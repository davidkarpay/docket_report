/* Minification failed. Returning unminified contents.
(2457,39): run-time error JS1004: Expected ';'
(2457,49-50): run-time error JS1010: Expected identifier: (
(2462,26): run-time error JS1004: Expected ';'
(2463,39): run-time error JS1004: Expected ';'
(3312,17-26): run-time error JS1300: Strict-mode does not allow assignment to undefined variables: iconStyle
(3319,17-26): run-time error JS1300: Strict-mode does not allow assignment to undefined variables: iconStyle
 */

window.common = (function () {
    var common = {};

    common.getFragment = function getFragment() {
        if (window.location.hash.indexOf("#") === 0) {
            return parseQueryString(window.location.hash.substr(1));
        } else {
            return {};
        }
    };

    function parseQueryString(queryString) {
        var data = {},
            pairs, pair, separatorIndex, escapedKey, escapedValue, key, value;

        if (queryString === null) {
            return data;
        }

        pairs = queryString.split("&");

        for (var i = 0; i < pairs.length; i++) {
            pair = pairs[i];
            separatorIndex = pair.indexOf("=");

            if (separatorIndex === -1) {
                escapedKey = pair;
                escapedValue = null;
            } else {
                escapedKey = pair.substr(0, separatorIndex);
                escapedValue = pair.substr(separatorIndex + 1);
            }

            key = decodeURIComponent(escapedKey);
            value = decodeURIComponent(escapedValue);

            data[key] = value;
        }

        return data;
    }

    common.sortByKey = function (array, key) {
        return array.sort(function (a, b) {
            var x = a[key];
            var y = b[key];
            return ((x < y) ? -1 : ((x > y) ? 1 : 0));
        });
    };

    common.getAccessToken = function () {
        if (sessionStorage.getItem("accessToken")) {
            var token = JSON.parse(sessionStorage.getItem("accessToken"));
            if (token) {
                return token;
            }
        }
        return null;
    };

    common.isMobile = function(){
        if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
            return true;
        }
        return false;
    }

    common.isSmall = function () {
        if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
            return true;
        }
        return false;
    };

    common.isMedium = function () {
        if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
            return true;
        }
        return false;
    };

    common.dateRegex = function () {
        // MM/DD/YYYY: 12/12/2012 or 2/3/2013
        return '/^[0,1]?\d{1}\/(([0-2]?\d{1})|([3][0,1]{1}))\/(([1]{1}[9]{1}[9]{1}\d{1})|([2-9]{1}\d{3}))$/';
    };

    common.timeRegex = function () {
        return '(1[012]|[1-9]):[0-5][0-9](\\s)(am|pm|PM|AM)';
    }

    common.formatCurrency = function (num) {
        if (num || num === 0) {
            var p = num.toFixed(2).split(".");
            var formatedNum =  p[0].split("").reverse().reduce(function (acc, num, i, orig) {
                return num + (i && !(i % 3) ? "," : "") + acc;
            }, "") + "." + p[1];

            if (formatedNum.substring(0, 1) == "-") {
                //negative
                return "(" + formatedNum.substring(1) + ")";
            }
            else {
                //positive or zero
                return "$" + formatedNum;
            }           
        }
        return num;
    }

    common.formatDate = function(dateString) {
        if (!dateString) return '';

        try {
            let d = new Date(dateString);

            let formattedDate = ("0" + (d.getMonth() + 1)).slice(-2)
                + "/" + ("0" + d.getDate()).slice(-2)
                + "/" + d.getFullYear();

            return formattedDate;
        }
        catch (e) {
            return '';
        }
    }

    String.prototype.toCamelCase = function () {
        return this.replace(/^([A-Z])|\s(\w)/g, function (match, p1, p2, offset) {
            if (p2) return p2.toUpperCase();
            return p1.toLowerCase();
        });
    };

    return common;
})();;

var sc = sc || {};

(function (ng) {
    'use strict';

    sc.ng = ng.module('sc', ['ui.router',
        'sc.controllers',   //ShowCase controllers
        'sc.services',  //ShowCase services
        'datatables', //datatables
        'ui.calendar', //fullcalendar
        'ui.bootstrap',
        'cgBusy',   //loading panel
        'ncy-angular-breadcrumb', //breadcrumb
        ]);  
        //'vcRecaptcha']);  

    sc.ng.svcs = ng.module('sc.services', []);

    sc.ng.controllers = ng.module('sc.controllers', ['sc.services', 'datatables']);

    sc.ng.directives = ng.module('sc.directives', []);

    sc.ng.config(['$httpProvider', '$urlRouterProvider', '$stateProvider', '$locationProvider','$breadcrumbProvider',
        function ($httpProvider, $urlRouterProvider, $stateProvider, $locationProvider, $breadcrumbProvider) {
            $urlRouterProvider.otherwise("/");

            $stateProvider
                .state('home', {
                    url: '/',
                    templateUrl: 'home/logo',
                    ncyBreadcrumb: {
                        label: 'Home'
                    }
                })
                .state('searchresults', {
                    url: '/search-results',
                    templateUrl: 'home/SearchResults',
                    controller: 'searchResultsCtrl',
                    params: { searchArgs: null },
                    ncyBreadcrumb: {
                        label: 'Case Search',
                        parent: function ($scope) {
                            if ($scope.myCases) {
                                this.label = 'My Cases';
                            }
                            else {
                                this.label = 'Case Search';
                            }
                        }
                    }
                })
                .state('caseDetails', {
                    //url: '/casedetails',
                    //url: '/caseDetails/{caseID:int}/{name}',
                    url: '/casedetails/{key}',
                    templateUrl: 'home/CaseDetails',
                    controller: 'caseDetailsCtrl',
                    //params: { caseID: null, name: null, prevState: null, eventInfo: null },
                    params: { key: null, prevState: null, eventInfo: null },
                    ncyBreadcrumb: {
                        label: '{{cd.caseNumber}}',
                        parent: function ($scope) {
                            //the previous state could have been passed to this state to ID the parent
                            if ($scope.prevState === 'calendarcases' || ($scope.$parent && $scope.$parent.prevState === 'calendarcases')) {
                                return 'calendarcases';
                            }
                            return 'searchresults';
                        }
                    }
                })
                .state('caseDetails.tab', {
                    url: '',
                    //url: '/{tabName}',
                    //params: { tabName: null },
                    params: { tabName: null, caseID: null },
                    templateUrl: function ($stateParams) {
                        return 'home/casedetailstab?name=_' + $stateParams.tabName;
                    },
                    ncyBreadcrumb: {
                        skip: true  //no breadcrum for this state
                    }
                })
                .state('document', {
                    url: '/document/{requestKey}',
                    params: { requestKey: null},
                    templateUrl: function ($stateParams) { return 'sci/case/document/' + $stateParams.requestKey; }
                })
                .state('changepassword', {
                    url: '/change-password',
                    templateUrl: 'account/changepassword',
                    controller: 'changePwdCtrl',
                    params: { userName: null, passwordExpired: null }

                })
                .state('calendar', {
                    url: '/calendar?v&d',
                    templateUrl: 'home/calendar',
                    controller: 'calendarCtrl',
                    reloadOnSearch: false,
                    params: { v: null, d: null },
                    ncyBreadcrumb: {
                        label: 'Court Events'
                    }
                })
                .state('calendarcases', {
                    //url: '/calendar/cases',
                    url: '/calendar/cases?title&searchdate&starttime&locationid&eventtypeid&eventview&courttypeid&judgeid&divisionid',
                    templateUrl: 'home/calendarcases',
                    controller: 'calendarCasesCtrl',
                    params: { key: null, prevState: null, eventInfo: null },
                    ncyBreadcrumb: {
                        label: '{{eventDate | date : "longDate"}} {{eventName}}', //{{eventDate | date : 'longDate'}} {{eventName}}
                        parent: function ($scope) {
                            if (typeof $scope.eventTitle === "function") {
                                this.label = $scope.eventTitle();
                            }
                            else {
                                this.label = 'Cases';
                            }

                            var uiSref = 'calendar';
                            if ($scope.eventView && $scope.eventDate)
                                uiSref = 'calendar({v:"' + $scope.eventView + '", d:"' + $scope.eventDate + '"})';
                            return uiSref;
                        }
                    }
                })
                .state('setcourtdatecontent', {
                    url: '/courtdate-info',
                    templateUrl: 'home/SetCourtDateContent',
                    controller: 'setCourtDateCtrl'
                })
                .state('setcourtdate', {
                    url: '/courtdate',
                    templateUrl: 'home/SetCourtDate',
                    controller: 'setCourtDateCtrl'
                })
                .state('schoolcompletion', {
                    url: '/schoolcompletion',
                    params: { citInfo: null },
                    templateUrl: 'home/schoolcompletion',
                    controller: 'schoolCompletionCtrl'
                });

            //not using barere token anymore
            $httpProvider.interceptors.push('authInterceptorService');

            $breadcrumbProvider.setOptions({
                prefixStateName: 'home',
                template: 'bootstrap3'
            });

            //this must be at then end of the configuration so it doesnt conflict with the states above
            //$locationProvider.html5Mode(true);
            //$locationProvider.hashPrefix('');

        }]);

    sc.ng.run(['$rootScope', '$state', '$stateParams', '$location',
        function ($rootScope, $state, $stateParams, $location) {

            // It's very handy to add references to $state and $stateParams to the $rootScope
            // so that you can access them from any scope within your applications.For example,
            // <li ng-class="{ active: $state.includes('contacts.list') }"> will set the <li>
            // to active whenever 'contacts.list' or one of its decendents is active.
            $rootScope.$state = $state;
            //$rootScope.$stateParams = $stateParams;
            $rootScope.title = 'ShowCase';
        }]
);
    sc.baseURL = $('base').attr('href');
})(angular);;
(function () {
    'use strict';

    sc.ng.controllers.controller('arrestCtrl', ['$scope', 'caseSvc', '$stateParams', '$state','controlSettingSvc', arrestCtrl]);

    function arrestCtrl($scope, caseSvc, $stateParams, $state, controlSettingSvc) {
        var _caseID = $stateParams.caseID;
        var _printing = $stateParams.printing;
        $scope.abTabPromiseLoading;

        $scope.aControlSetting = 'gridArrest_ShowCaseWebSilverlight.CaseInquire';

        var _adefaultColDef = [
            { data: 'arrestOffenseDate', title: 'Offense Date', render: renderDate, type: 'date'},
            { data: 'agencyName', title: 'Arresting Agency' },
            { data: 'agencyNumber', title: 'Agency Number' },
            { data: 'bookingNumber', title: 'Booking' },
            { data: 'incidentNumber', title: 'Incident #' }
        ];

        $scope.adtInstance = null;
        $scope.adtColumns = controlSettingSvc.gridColDefs($scope.aControlSetting, _adefaultColDef);
        
        $scope.adtOptions = {
            paging:false,
            //paginationType: 'numbers',
            //displayLength: 25,  //pages are 25 rows
            //bLengthChange: false,    //hide pagination option from top left
            searching: false,
            ordering: (!_printing),
            //order: [0, 'asc'], //order by arrest date by default
            aaSorting: [], //no sort by default but stil allow users to sort
            responsive: true,
            oLanguage: { sZeroRecords: "No records found" },
            info: false,
            autoWidth: false, //This is required to fix column width when columns are hidden
            fnPromise: function () {

                if (!$scope.abTabPromiseLoading)
                    $scope.abTabPromiseLoading = caseSvc.caseArrests(_caseID);

                return $scope.abTabPromiseLoading
            }
        };

        $scope.bControlSetting = 'gridBond_ShowCaseWebSilverlight.CaseInquire';

        var _bdefaultColDef = [
            { data: 'bondNumber', title: 'Bond #'},
            { data: 'bondType', title: 'Type' },
            { data: 'chargeCount', title: 'ChargeCount' },
            { data: 'bondAgent', title: 'Bondsman' },
            { data: 'depositorName', title: 'Depositor' },
            { data: 'suretyCompany', title: 'Surety Company' },
            { data: 'closedDate', title: 'Closed Date', render: renderDate },
            { data: 'bondAmount', title: 'Amount', render: renderCurrency },
            { data: 'forfeitureDate', title: 'Forfeiture Date', render: renderDate },
            { data: 'issueDate', title: 'Effective Date', render: renderDate },
            { data: 'status', title: 'Status' }
        ];

        $scope.bdtInstance = null;
        $scope.bdtColumns = controlSettingSvc.gridColDefs($scope.bControlSetting, _bdefaultColDef);

        $scope.bdtOptions = {
            paging:false,
            //paginationType: 'numbers',
            //displayLength: 25,  //pages are 25 rows
            //bLengthChange: false,    //hide pagination option from top left
            searching: false,
            ordering: (!_printing),
            aaSorting: [], //no sort by default but stil allow users to sort
            responsive: true,
            oLanguage: { sZeroRecords: "No records found" },
            info: false,
            autoWidth: false, //This is required to fix column width when columns are hidden
            fnPromise: function () {

                if (!$scope.bondsLoading)
                    $scope.bondsLoading = caseSvc.caseBonds(_caseID);

                return $scope.bondsLoading;
            }
        };

        $scope.controlsettingSaved = function (name) {
            //console.log('case arrest knows about it:' + name);
            //relaod control settings as the directvie requested
            $state.reload();
        }

        function renderDate(data) {
            if (data)
                return moment(data).format('MM/DD/YYYY');
            return '';
        }

        function renderCurrency(amount) {
            return common.formatCurrency(amount);
        }

        //$scope.CaseArrests = [];
        //$scope.CaseBonds = [];
        //$scope.controlSetting;
        //$scope.gridColDefs = [];

        //function init() {
            //$scope.tabPromiseLoading = caseSvc.caseArrests(_caseID).
            //    then(function (d) {
            //        $scope.CaseArrests = d;
            //    });

            //caseSvc.caseBonds(_caseID).
            //    then(function (d) {
            //        $scope.CaseBonds = d;
            //    });
        //}

        //init();
    }   
})();;
(function () {
    'use strict';

    sc.ng.controllers.controller('calendarCtrl', ['$scope', '$state', '$compile', 'calSvc', 'listsSvc', '$q', 'authSvc', calendarCtrl]);

    function calendarCtrl($scope, $state, $compile, calSvc, listsSvc, $q, authSvc) {

        var _calendar = null;
        var _selectedEvent = null;
        var _now = new Date();
        
        var VIEWTYPE = {
            Day: 'listDay',
            Week: 'basicWeek',
            Month: 'month'
        };

        $scope.promiseLoading = null;

        $scope.calSearchArgs = {
            eventDate: null,
            startTime: '',
            view: 0 //Day = 0, Week = 1, Month = 2
        };

        $scope.eventSources = [];      
        
        $scope.dateControl = {
            showWeeks: false,
            opened:false,
            open: function ($event) {
                this.opened = true;
            }
        }

        $scope.titleDateControl = {
            showWeeks: false,
            opened: false,
            open: function ($event) {
                this.opened = true;
            }
        }

        $scope.timeControl = {
            time: new Date(_now.getYear(), _now.getMonth(), _now.getDate(), _now.getHours(), 0),
            changed: function () {
                $scope.calSearchArgs.startTime = moment(this.time).format("LT");
            },
            pattern: common.timeRegex()
        }

        //REF: http://angular-ui.github.io/ui-calendar/
        $scope.uiConfig = {
            calendar: {
                editable: false,
                businessHours: true,
                header: false,
                //header: {
                //    left: '',
                //    center: '',
                //    right: ''
                //},
                //selectable: true,
                //eventTextColor: '#5e594b',
                //eventBorderColor: '',
                //eventBackgroundColor: 'rgb(255,0,0)',
                //eventLimit: 30,
                contentHeight: 'auto',
                defaultView: (common.isMobile() ? VIEWTYPE.Day : VIEWTYPE.Month),
                lazyFetching: false, //this allows me to request new events for each view
                eventClick: eventClick,
                events: calendarEventsRequest,
                eventRender: eventRender,
                eventDataTransform: courtEventTransform,
                dayClick: function (date, jsEvent, view) {
                    //set default date to the clicked one
                    //$scope.calSearchArgs.eventDate = date.format('MM/DD/YYYY');
                }, 
                loading: function (isLoading, view) {
                    if (isLoading) {
                        //show loading 
                        var deferred = $q.defer();
                        $scope.promiseLoading = deferred.promise
                    }
                    else {
                        $scope.promiseLoading = null;
                    }
                }
            }
        };

        $scope.showSearchPanel = function () {
            $('#calsearchPanel').modal('show');
        }

        $scope.navigate = function (nav) {
            if (nav === 'prev') {
                //var prevDate = _calendar.getDate().subtract(1, 'month');
                //var view = _calendar.getView().name;
                //$state.go('calendar', { v: view, d: prevDate.format('YYYY-MM-DD')});
                _calendar.prev();
            }
            else {
                _calendar.next();
            }
        }

        $scope.clear = function () {
            for (var prop in $scope.calSearchArgs) {
                switch (prop) {
                    case 'view':                           
                        $scope.calSearchArgs[prop] = (common.isMobile() ? 0 : 2);
                        break;
                    case 'eventDate':
                        $scope.calSearchArgs[prop] = new Date();
                        break;
                    default:
                        $scope.calSearchArgs[prop] = null;
                }
            }

            $scope.dateControl.eventDate = '';
        }

        $scope.changeView = function (view) {
            _calendar.changeView(view);
        };

        $scope.isView = function (viewName) {
            if (!_calendar)
                return false;
            return (_calendar.view.name === viewName);
        };

        $scope.search = function () {
            var eventDateMoment;

            if ($scope.dateControl.eventDate) {
                eventDateMoment = moment($scope.dateControl.eventDate);
            }
            else {
                //default to today's date
                eventDateMoment = moment(new Date());
            }

            var currentView = _calendar.view;

            switch ($scope.calSearchArgs.view) {
                case 0:
                    if (currentView.name != VIEWTYPE.Day) {
                        _calendar.changeView(VIEWTYPE.Day);
                    }
                    break;
                case 1:
                    if (currentView.name != VIEWTYPE.Week) {
                        _calendar.changeView(VIEWTYPE.Week);
                    }
                    break;
                case 2:
                    if (currentView.name != VIEWTYPE.Month) {
                        _calendar.changeView(VIEWTYPE.Month);
                    }
                    break;
            }
            
            _calendar.gotoDate(eventDateMoment);
            _calendar.refetchEvents();
        }

        $scope.viewCases = function () {
            //provide time for the modal to close
            //DateTime? searchDate, string startTime, int? courtTypeID = 0, int? courtEventTypeID = 0, int? judgeID = 0, int? courtLocationID = 0, int? divisionID = 0

            var eventData = {
                title: _selectedEvent.title,
                searchDate: _selectedEvent.start.toJSON(),
                startTime: _selectedEvent.start.format('HH:mm'),
                courtLocationID: _selectedEvent.courtLocationID,
                courtEventTypeID: _selectedEvent.courtEventTypeID,
                eventView: $scope.currentView(),
                courtTypeID: 0,
                judgeID: 0,               
                divisionID: 0,
                barNumber: ""
                //lastUpdate: $scope.selectedEventLastUpdated
            };

            //$state.go('calendarcases', { eventInfo: eventData });

            var eventMoment = moment(eventData.searchDate);
     
            $state.go('calendarcases', {
                title: eventData.title,
                searchdate: eventData.searchDate,
                starttime: eventMoment.format('h:mm A'),
                locationid: eventData.courtLocationID,
                eventtypeid: eventData.courtEventTypeID,
                eventview: eventData.eventView,
                courttypeid: eventData.courtTypeID,
                judgeid: eventData.judgeID,
                divisionid: eventData.divisionID,
                batNumber: eventData.barNumber
            });

            //setTimeout(function () {
            //    $state.go('calendarcases', { eventInfo: eventData });
            //}, 500);
        }

        $scope.currentView = function () {
            if (_calendar)
                return _calendar.getView().name;
        }

        $scope.currentDate = function () {
            if (_calendar)
                return _calendar.getDate().format('YYYY-MM-DD');;
        }

        function courtEventTransform(e) {
            if (e.totalSummary) {
                return {
                    title: e.courtEventCount + ' events...',
                    totalSummary:1,
                    start: e.courtEventDate.substring(0,10) + 'T23:59',
                    timeFormat: 'H(:mm:ss)',
                    className: 'cal-event-total'
                };
            }
            else if (e.courtEventDate) {
                return {
                    title: '(' + e.courtEventCount + ') ' + e.courtEvent,
                    start: e.courtEventDate,
                    courtLocationID: e.courtLocationID,
                    courtEventTypeID: e.courtEventTypeID,
                    className: 'cal-event'
                };
            }
            else
                return e; 
        }

        /* Render Tooltip */
        function eventRender(event, element, view) {
            //compile angular specific directive here
            var tooltipText = event.title;
            if (event.totalSummary){
                tooltipText = 'Click to see all court events'
            }

            if (!common.isMobile() && view.name == VIEWTYPE.Month) {
                element.attr({
                    'uib-tooltip': tooltipText,
                    'tooltip-append-to-body': true
                });
            }
            $compile(element)($scope);
        };

        function calendarEventsRequest(start, end, timezone, callback) {
            
            //collect _calendar object so we can talk to it directly
            if (!_calendar) {
                _calendar = this;
            }
            
            //1. Set MVVM data to synchronize UI
            //var eventDate = start.format('MM/DD/YYYY')
            $scope.calSearchArgs.eventDate = start.format('MM/DD/YYYY');
            $scope.calSearchArgs.eventEndDate = end.format('MM/DD/YYYY');
            $scope.calTitle = this.view.title;

            //console.log("eventDate: " + $scope.calSearchArgs.eventDate + " eventEndDate: " +$scope.calSearchArgs.eventEndDate + " view: " +this.view.name);
           
            switch(this.view.name){
                case VIEWTYPE.Month:
                    $scope.calSearchArgs.view = 2;
                    //show top 4 per day in month view
                    $scope.calSearchArgs.maxPerDay = 6;
                    break;
                case VIEWTYPE.Week:
                    $scope.calSearchArgs.view = 1;
                    $scope.calSearchArgs.maxPerDay = null;
                    break;
                case VIEWTYPE.Day:
                    $scope.calSearchArgs.view = 0;
                    $scope.calSearchArgs.maxPerDay = null;
                    break;
            }

            //2. Get the events
            calSvc.getSummary($scope.calSearchArgs)
                .then(function (events) {
                    if (events) {
                        callback(events);
                    }
                });

            updateURLParams();
        }

        function updateURLParams() {
            var day = $scope.currentDate();
            var view = $scope.currentView();

            //this can be used in combination of reloadOnSearch : false in the state to avoid reloading the controller
            $state.go('calendar', { v: view, d: day });
            //$state.go('calendar', { v: view, d: day }, {
            //    location: true,
            //    inherit: true,
            //    relative: $state.$current,
            //    notify: false   // do not reload my state
            //});
        }

        function eventClick(event, jsEvent, view) {
            
            if (event.totalSummary){
                $state.go('calendar', {
                    d: event.start.format('YYYY-MM-DD'),
                    v: VIEWTYPE.Day
                }, { reload: true }); // must reload as the state prevents reload from itself
            }
            else {
                //set selected event which  is passed to the calendar cases
                _selectedEvent = event;
                $scope.viewCases();
            }
           
            //var sessionLastUpdatedParams = {
            //    courtLocationID: event.courtLocationID,
            //    courtEventDate: event.start.toJSON()
            //};

            //calSvc.getSessionLastUpdated(sessionLastUpdatedParams)
            //    .then(function (date) {
            //        $scope.selectedEventLastUpdated = date;
            //    });

            //var courtTotalsParams = {
            //    courtLocationID: event.courtLocationID,
            //    courtEventTypeId: event.courtEventTypeID,
            //    courtEventDate: event.start.toJSON(),
            //    courtTypeID: 0  // CourtTypeID is never returned from the summary.
            //};
            
            //calSvc.getCourtTotals(courtTotalsParams)
            //    .then(function (totals) {
            //        $scope.courtTotals = totals;
            //    });
            
            //$scope.selectedEventTitle = event.title;

            //$('#eventDetails').modal('show');
        }

        function viewIntToStr(viewInt) {
            switch (viewInt) {
                case 0:
                    return VIEWTYPE.Day;
                case 1:
                    return VIEWTYPE.Week;
                case 2:
                    return VIEWTYPE.Month;
            }
        }

        function viewStrToInt(viewStr) {
            switch (viewStr) {
                case VIEWTYPE.Day:
                    return 0;
                case VIEWTYPE.Week:
                    return 1;
                case VIEWTYPE.Month:
                    return 2;
            }
            return -1;
        }

        function init() {

            var day = $state.params.d;
            var view = $state.params.v;

            if (day) {
                //default day was passed in. Otherwise, it will show today
                $scope.uiConfig.calendar.defaultDate = moment(day);
            }

            if (view) {
                //default view was passed in. Otherwise, it will show month or day in mobile
                $scope.uiConfig.calendar.defaultView = view;
            }

            //Load dropdown lists
            listsSvc.getJudges().then(
                function (judges) {
                    $scope.judges = judges;
                });

            listsSvc.getDivisions().then(
                function (divisions) {
                    $scope.divisions = divisions;
                });

            listsSvc.getCourtTypes().then(
                function (courtTypes) {
                    $scope.courtTypes = courtTypes;
                });

            listsSvc.getCourtRooms().then(
                function (courtLocations) {
                    $scope.courtLocations = courtLocations;
                });

            listsSvc.getCourtEventTypes().then(
                function (courtEventTypes) {
                    $scope.courtEventTypes = courtEventTypes;
                });
        }

        init();
    }
})();;
(function () {
    'use strict';

    sc.ng.controllers.controller('calendarCasesCtrl', ['$scope', '$state', 'uiCalendarConfig', 'calSvc', 'caseSvc', 'controlSettingSvc', '$compile', '$filter', calendarCasesCtrl]);

    function calendarCasesCtrl($scope, $state, uiCalendarConfig, calSvc, caseSvc, controlSettingSvc, $compile, $filter) {
        var _eventInfo = $state.params.eventInfo || calSvc.getEventInfo();
        var _viewSealedCase = false;

        $scope.controlSettingName = 'gridRelated_ShowCaseWebSilverlight.Controls.EditAppointment';
        $scope.calCasesLoading = null;
        $scope.lastUpdate = null;
        $scope.selectedTimes = [];

        //data from preview state required for bredcrumb
        $scope.eventDate = null;
        $scope.eventView = null;

        var _defaultColDef = [
            { data: 'caseNumber', title: 'Case #', className: 'text-nowrap', responsivePriority: 1, render: renderCaseNumber }, //note: if the responsie layout removes the case number, it will never compile in angularjs so raise responsivePriority
            { data: 'processed', title: 'Processed', render: renderBool },
            { data: 'courtEventDate', title: 'Event Date', render: renderDates, responsivePriority: 3, type: 'date' },
            { data: 'name', title: 'Name', className: 'text-nowrap', responsivePriority: 2 },
            { data: 'citationNumber', title: 'Citation #' },
            { data: 'initialStatuteDescription', title:'Statute Description'},
            { data: 'offenseDate', title: 'Offense Date', render: renderDates, type: 'date' },
            { data: 'dob', title: 'DOB', render: renderDates, type: 'date' },
            { data: 'caseStatus', title: 'Status' },
            { data: 'dlNumber', title: 'DL Number', className: 'text-nowrap' },
            { data: 'speedyTrialDueDate', title: 'Speedy Trial Due Date', render: renderDates, type: 'date' },
            { data: 'aggressiveDriving', title:'Aggressive', render: renderBool },
            { data: 'commercialDL', title:'Commercial DL', render: renderBool }
        ];

        var _excludedCol = ['caseID'];

        //angularjs - datatable objects
        $scope.dtInstance = null;
        $scope.dtColumns = controlSettingSvc.gridColDefs($scope.controlSettingName, _defaultColDef, _excludedCol); 
        $scope.dtOptions = {
            paginationType: 'numbers',
            displayLength: 25,  //pages are 25 rows
            lengthChange: false,    //hide pagination option from top left
            order: [1], //sort by caseNumber by default
            responsive: true,
            colReorder: true,
            oLanguage: { sZeroRecords: "No records found" },
            fnPromise: function () {
                //if (!$scope.calCasesLoading)
                $scope.calCasesLoading = calSvc.search(_eventInfo);
                return $scope.calCasesLoading;
            },
            createdRow: createdRow, //compile row elements in angular
            dom: 'Brtip',
            buttons: ['csvHtml5'],
            language: {
                sSearch: '<span class="glyphicon glyphicon-filter" title="Filter"></span>',
                sInfo: "Showing _START_ to _END_", //"Got a total of _TOTAL_ entries to show (_START_ to _END_)"
                //sLengthMenu: "Display _MENU_ records" //Display _MENU_ records
            }
        };

        $scope.timeSelect = function (t) {
            var i = $scope.selectedTimes.indexOf(t);

            if (i === -1) {
                //add item
                $scope.selectedTimes.push(t);
            }
            else {
                //remove item
                $scope.selectedTimes.splice(i,1);
            }

            //$scope.refreshCases();

            _eventInfo.startTime = $scope.selectedTimes.join('|');

            $state.go('calendarcases', {
                title: _eventInfo.title,
                searchdate: _eventInfo.searchDate,
                starttime: _eventInfo.startTime,
                locationid: _eventInfo.courtLocationID,
                eventtypeid: _eventInfo.courtEventTypeID,
                eventview: _eventInfo.eventView,
                courttypeid: _eventInfo.courtTypeID,
                judgeid: _eventInfo.judgeID,
                divisionid: _eventInfo.divisionID
            },
            { reload: true });
        }

        $scope.eventTitle = function () {
            return $filter('date')($scope.eventDate, "longDate") + ' ' + $scope.eventName;
        }

        $scope.refreshCases = function () {
            //if (!($scope.selectedTimes) || $scope.selectedTimes.length === 0) {
            //    return;
            //}

            _eventInfo.startTime = "";
            //_eventInfo.startTime = '4/25/2016 2:00 PM|4/25/2016 3:00 PM|4/25/2016 4:00 PM'
            var formattedDate = moment($scope.eventDate).format('MM/DD/YYYY');
            for (var i = 0; i < $scope.selectedTimes.length; i++) {
                _eventInfo.startTime += formattedDate + ' ' + $scope.selectedTimes[i] + '|';
            }

            if ($scope.dtInstance) {
                //reloadData calls the function attached to fnPromise
                $scope.dtInstance.reloadData(null, true);
            }
            else {
                console.log('dtInstance failed');
            }
        }

        $scope.canExport = !common.isMobile();

        $scope.export = function () {
            if ($('.buttons-csv').length > 0) {
                $('.buttons-csv').click();
            }
        }

         //note: if the responsie layout removes the case number, this will never fire;
        $scope.rowClick = function (row) {
            var caseobj = $scope.dtInstance.DataTable.data()[row];

            //$state.go('caseDetails', {
            //    caseID: caseobj.caseID,
            //    name: caseobj.name,
            //    prevState: $state.current.name,
            //    calTitle: $scope.eventTitle(),
            //    eventInfo: _eventInfo
            //});

            caseSvc.getcaseKey(caseobj.caseID, caseobj.nameID)
                .then(function (casekey) {

                    if (casekey) {
                        $state.go('caseDetails', {
                            key: casekey,
                            caseID: caseobj.caseID,
                            name: caseobj.name,
                            prevState: $state.current.name,
                            calTitle: $scope.eventTitle(),
                            eventInfo: _eventInfo
                        });
                    }
                });
        }

        $scope.controlsettingSaved = function (name) {
            //console.log('calendar cases knows about it:' + name);
            //relaod control settings as the directvie requested
            $state.reload();
        }

        function createdRow(row, data, dataIndex) {
            if (caseSvc.isCaseSecured(data)) {
                //Add secure case style
                $(row).addClass('danger');
                //Add tooltip
                $(row).attr('title', caseSvc.secureInfo(data));
            }

            // Recompiling so we can bind Angular directive to the DT
            $compile(angular.element(row).contents())($scope);
        }
        
        function renderDates(data) {
            if (data)
                return moment(data).format('MM/DD/YYYY');
            return '';
        }

        function renderCaseNumber(data, type, c, meta) {
            var warrantIcon = '';
            var title = c.caseNumber;

            if (c.hasOpenWarrant) {
                warrantIcon = '<span class="glyphicon glyphicon-asterisk" style="color:#a94442;padding-right: 2px;"></span>';
                title = 'Open Warrant';
            }

            if (c.isSealedCase && !_viewSealedCase) {
                return '<p>' + warrantIcon + c.caseNumber + '</p>';
            }

            return '<a title="' + title + '" href="" ng-click="rowClick(' + meta.row + ')">' + warrantIcon + data + '</a>';
        }

        function renderBool(data) {
            if (data == null)
                return ''
            if (data == 1 || data == true)  // 1 || "1" || true || "true"
                return 'Yes';
            return 'No'
        }

        function init() {

            _eventInfo = {
                title: $state.params.title,
                searchDate: $state.params.searchdate,
                startTime: $state.params.starttime,
                courtLocationID: $state.params.locationid,
                courtEventTypeID: $state.params.eventtypeid,
                eventView: $state.params.eventview,
                courtTypeID: $state.params.courttypeid,
                judgeID: $state.params.judgeid,
                divisionID: $state.params.divisionid
            };
                

            if (!_eventInfo) {
                //return to calendar when no event info
                $state.go('calendar');
                return;
            }

            //var eventMoment = moment(_eventInfo.searchDate);

            //TODO: This button is not rendered yet at init(). Find another time
            //$scope.canExport = ($('.buttons-csv').length > 0);

            //$scope.eventText = _eventInfo.title;
            //$scope.lastUpdate = _eventInfo.lastUpdate;
          
            $scope.eventDate = _eventInfo.searchDate;
            $scope.eventView = _eventInfo.eventView;
            //$scope.selectedTimes.push(eventMoment.format('h:mm A'));
            $scope.eventName = _eventInfo.title;

            if (_eventInfo.startTime) {

                var times = _eventInfo.startTime.split("|");

                times.forEach(time => {
                    $scope.selectedTimes.push(time);
                });
            }

            _eventInfo.startTime = "";
            var formattedDate = moment($scope.eventDate).format('MM/DD/YYYY');

            for (var i = 0; i < $scope.selectedTimes.length; i++) {
                _eventInfo.startTime += formattedDate + ' ' + $scope.selectedTimes[i] + '|';
            }

            var sessionTimesRequest = {
                courtLocationID: _eventInfo.courtLocationID,
                courtEventDate: _eventInfo.searchDate
            }

            calSvc.getSessionTimes(sessionTimesRequest)
                .then(function (results) {
                    $scope.availableTimes = results;
                });


            var sessionLastUpdatedParams = {
                courtLocationID: _eventInfo.courtLocationID,
                courtEventDate: _eventInfo.searchDate
            };

            calSvc.getSessionLastUpdated(sessionLastUpdatedParams)
                .then(function (date) {
                    $scope.lastUpdate = date;
                });

            var courtTotalsParams = {
                courtLocationID: _eventInfo.courtLocationID,
                courtEventTypeId: 0, //_eventInfo.courtEventTypeID,
                courtEventDate: _eventInfo.searchDate,
                courtTypeID: 0  // CourtTypeID is never returned from the summary.
            };

            calSvc.getCourtTotals(courtTotalsParams)
                .then(function (totals) {
                    if (totals) {
                        $scope.courtTotals = '';
                        angular.forEach(totals, function (k, v) {
                            $scope.courtTotals += k.courtType + '-' + k.count + ' | ';
                        })
                        $scope.courtTotals = $scope.courtTotals.substring(0, $scope.courtTotals.length - 3);
                    }
                });

            controlSettingSvc.getMainNavSettings()
              .then(function (d) {
                  _viewSealedCase = d.viewSealedCase;
              });
        }
        init();
    }
})();;
(function () {
    'use strict';
    sc.ng.controllers.controller('caseDetailsCtrl', ['$scope', '$state', '$stateParams', '$window', 'controlSettingSvc', 'caseSvc', 'authSvc', caseDetailsCtrl]);

    function caseDetailsCtrl($scope, $state, $stateParams, $window, controlSettingSvc, caseSvc, authSvc) {

        var _printing = $stateParams.printing;
        var _eventInfo = $stateParams.eventInfo;
        var _caseKey = $stateParams.key;

        //$scope.caseID = $stateParams.caseID;
        //$scope.name = $stateParams.name;

        var _caseID;
        var _nameID;

        $scope.tabControlSettingsName = 'tabsCaseDetails_ShowCaseWebSilverlight.CaseInquire';
        $scope.panelControlSettingsName = 'ucCaseSearchDetailsPanel_ShowCaseWebSilverlight.CaseInquire';
        $scope.panelSettings = []; 

        $scope.prevState = ($stateParams.prevState || 'searchresults');
        $scope.promiseLoading = null;
        $scope.cd = {};
        $scope.viewMugshot = false;

        //data from preview state required for bredcrumb
        $scope.eventDate = null;
        $scope.eventView = null;

        //if (!$scope.caseID) { $state.go('home'); return; }
        if (!_caseKey) { $state.go('home'); return; }

        //default tabs if controlsetting is configured
        $scope.tabs = [
           { title: 'Court Events', route: 'caseDetails.tab', name: 'courtevents', order: 0 },
           { title: 'Parties', route: 'caseDetails.tab', name: 'parties' },
           { title: 'Charges', route: 'caseDetails.tab', name: 'charges' },
           { title: 'Dockets', route: 'caseDetails.tab', name: 'dockets' },
           { title: 'Linked Cases', route: 'caseDetails.tab', name: 'relatedCases' },
           { title: 'Sentences', route: 'caseDetails.tab', name: 'sentences' },
           { title: 'Warrants', route: 'caseDetails.tab', name: 'warrants' },
           { title: 'Arrests & Bonds', route: 'caseDetails.tab', name: 'arrests' },
           { title: 'Fees', route: 'caseDetails.tab', name: 'fees' }
        ];

        $scope.go = function (tab) {
            if (tab && tab.route)
                //$state.go(tab.route, { caseID: $scope.caseID, tabName: tab.name });
                $state.go(tab.route, { caseID: _caseID, tabName: tab.name });

        };

        $scope.goBack = function () {
            window.history.back();
        };

        $scope.securityInfo = '';

        $scope.showPrintPreview = function () {
            //window uses the parameters from localStorage
            localStorage.crosswdata = JSON.stringify({
                state: "printPreview",
                params: {
                    caseID: _caseID,
                    key: _caseKey
                }
            });

            var url = sc.baseURL + 'print';
            var w = $window.open(url, '_blank');
        };

        $scope.getVal = function (controlSettings) {
            var value = "";
            if (!$scope.cd || !controlSettings ||!controlSettings.id)
                return value;

            switch (controlSettings.id.toLowerCase()) {
                case 'namesuffix':
                    return $scope.cd.suffixName;
                case 'dlnumber':
                    return $scope.cd.dlNumber;
                case 'akas':
                    return $scope.cd.akAs;
                case 'dlstate':
                    return $scope.cd.dlState;
                case 'sanumber':
                    return $scope.cd.saNumber;
                case 'feebalance':
                    return common.formatCurrency($scope.cd.feeBalance);
                case 'restitutionbalance':
                    return common.formatCurrency($scope.cd.restitutionBalance);
                case 'capiasissueddate':
                    return common.formatDate($scope.cd.capiasIssuedDate);
                case 'speedytrialduedate':
                    return common.formatDate($scope.cd.speedyTrialDueDate);
                case 'speedytrialdemanddate':
                    return common.formatDate($scope.cd.speedyTrialDemandDate);
                case 'speedytrialwaiveddate':
                    return common.formatDate($scope.cd.speedyTrialWaivedDate);
                case 'filedate':
                    return common.formatDate($scope.cd.fileDate);
                case 'arrestdate':
                    return common.formatDate($scope.cd.arrestDate);
                case 'offensedate':
                    return common.formatDate($scope.cd.offenseDate);
                case 'dob':
                    return common.formatDate($scope.cd.dob);
                default:
                    value = $scope.cd[controlSettings.id.toCamelCase()];

            }
            return value;
        }

        $scope.controlsettingSaved = function (name) {
            //console.log('case details knows about it:' + name);
            //relaod control settings as the directvie requested
            setControlSettings();
        }
      
        function setControlSettings() {
            //get tab settings
            controlSettingSvc.getControlSettings($scope.tabControlSettingsName)
                   .then(function (cs) {
                       //when printing, we need to hide those section that dont have a tab
                       if (_printing) {
                           togglePrintSections(cs);
                       }
                       else {
                           //build the tabs normally
                           buildTabs(cs);
                           if (!$state.params.tabName) {
                               //Activate default tab since tabName was not passed
                               goToDefaultTab();
                           }
                       }
                   });

            //get panel settings
            controlSettingSvc.getControlSettingsArray($scope.panelControlSettingsName)
                .then(function (cs) {
                    $scope.panelSettings = cs;
                    //buildHeaderPanel(cs);
                }, function (err) {
                    console.log('unable to read the control setting', err);
                });


            controlSettingSvc.getMainNavSettings()
                .then(function (d) {
                    $scope.viewMugshot = d.viewMugshots;
                });
        }

        $scope.isTabActive = function (tab) {
            if (tab)
                return $state.params.tabName === tab.name;
                //return $state.is(tab.route) && $state.params.tabName === tab.name;
            return false;
        }

        function buildTabs(cs) {
            var _tabs = []
            if (cs) {
                for (var n in cs) {
                    if (cs[n].includeInDisplay && n != 'WordMerge') {
                        _tabs.push({
                            title: cs[n].displayName,
                            route: 'caseDetails.tab',
                            name: n.toLowerCase(),
                            order: cs[n].displayOrder,
                            //active: (cs[n].displayOrder === 0)
                        });
                    }
                }
                if (_tabs && _tabs.length > 0) {
                    $scope.tabs = _tabs;
                }
            }
        }

        function togglePrintSections(cs) {
            //This ui changes are out side of the angular view and as a consequence scope.
            //DOM manipulations must be done here with javascript/jquery to properly have access
            if (cs) {
                for (var n in cs) {
                    if (cs[n].includeInDisplay) {
                        $('section#' + n.toLowerCase() + ' h4').html(cs[n].displayName);
                    }
                    else {
                        //console.log('removing ' + n + ' section');
                        $('section').remove('#' + n.toLowerCase());
                    }
                }
            }
        }

        function goToDefaultTab() {
            if ($scope.tabs.length > 0)
                $scope.go($scope.tabs[0]);
        }

        //Richard Marens 02/01/2019 SC-1176
        function addRecentCase(caseDetails, maxCases) {
            authSvc.addRecentCase(caseDetails, maxCases);
        }

        function init() {
            //This should be called when _caseID is available from the _caseKey.
            //setControlSettings();

            if (_eventInfo) {
                //required for breadcrumb state
                $scope.eventDate = _eventInfo.searchDate;
                $scope.eventView = _eventInfo.eventView;
            }

            if (_caseKey) {
                caseSvc.readcaseKey(_caseKey)
                    .then(function (caseKeyResult) {
                        _caseID = caseKeyResult.caseID;
                        _nameID = caseKeyResult.nameID;

                        setControlSettings();

                        if (_caseID) {
                            $scope.promiseLoading = caseSvc.getCaseDetails(_caseID, _nameID)
                                .then(function (caseDetails) {
                                    $scope.cd = caseDetails;

                                    if (caseSvc.isCaseSecured(caseDetails))
                                        $scope.securityInfo = caseSvc.secureInfo(caseDetails);

                                    //Richard Marens 02/01/2019 SC-1176
                                    addRecentCase(caseDetails);
                                });
                        }
                    });
            }
        }

        init();
    }
})();;
(function () {
    'use strict';

    sc.ng.controllers.controller('caseSearchCtrl', ['$scope', '$state', 'caseSvc', 'controlSettingSvc', 'listsSvc', '$timeout', caseSearchCtrl]);

    function caseSearchCtrl($scope, $state, caseSvc, controlSettingSvc, listsSvc, $timeout) {

        const _modalElement = "#caseSearchPanel";

        $scope.controlSettingsName = 'ucCaseSearchPanel_ShowCaseWebSilverlight.CaseInquire';

        $scope.$on('sessionStarted', function (event, args) {
            //init();
            setControlSettings();
        });

        $scope.$on('handleLogOut', function (event) {
            //init();
            setControlSettings();
        });

        $scope.$on('showSearch', function (event, args) {

            if (args.panel !== 'case') return;

            $(_modalElement)
                .prop('class', 'modal fade modal-search'); // revert to default

            $(_modalElement).modal('show');
        });

        //$scope.settingsLoading;

        $scope.searchArgs = {
            LastName: '',
            FirstName: '',
            OneRowPerCase: true,
            MatchType: 0 //Exact = 0, SoundEx = 1, StartWith = 2
        };

        $scope.settings = [
            { displayName: "Case Number", id: "canCaseNumber" },
            { displayName: "Last Name", id: "canLastName" },
            { displayName: "First Name", id: "canFirstName" },
        ];

        $scope.judges = [];
        $scope.divisions = [];
        $scope.caseStatuses = [];
        $scope.courtTypes = [];

        $scope.clear = function () {
            $scope.noResults = false;
            for (var prop in $scope.searchArgs) {
                switch (prop) {
                    case 'OneRowPerCase':
                        $scope.searchArgs[prop] = true;
                        break;
                    case 'MatchType':
                        $scope.searchArgs[prop] = 0;
                        break;
                    default:
                        $scope.searchArgs[prop] = null;
                }
            }
        };

        $scope.search = function ($event) {

            //console.log({ 'search events': $event});

            $scope.noResults = false;

            //if ($scope.modalTitle === "Case Search") {

            $scope.validateCaseNumber();

            $state.transitionTo('searchresults', { searchArgs: $scope.searchArgs }, { reload: true });

            //caseSearchform.$setValidity('Invalid case number', false, window);           

            //hiding the modal must be done last. the hidden.bs.modal will clear the parameters used in the methods above
            $(_modalElement).modal('hide');
        };

        $scope.validateCaseNumber = function () {
            if ($scope.searchArgs.CaseNumber) {
                caseSvc.validateCaseNumber($scope.searchArgs.CaseNumber)
                    .then(function (validCaseNumber) {
                        $scope.searchArgs.CaseNumber = validCaseNumber;
                    });
            }
        };

        $scope.controlsettingSaved = function (name) {
            //console.log('case search knows about it:' + name);
            //relaod control settings as the directvie requested
            setControlSettings();
        }

        //$scope.captcha = authSvc.getCaptcha();

        function loadLists() {

            //Load dropdown lists
            //listsSvc.getCaseTypes().then(
            //    function (ct) {
            //        $scope.caseTypes = ct;
            //    });

            //listsSvc.getPartyTypes().then(
            //    function (pt) {
            //$scope.partyTypes = pt;
            //    });

            listsSvc.getJudges().then(
                function (judges) {
                    $scope.judges = judges;
                });

            listsSvc.getDivisions().then(
                function (divisions) {
                    $scope.divisions = divisions;
                });

            listsSvc.getCaseStatuses().then(
                function (caseStatuses) {
                    $scope.caseStatuses = caseStatuses;
                });

            listsSvc.getCourtTypes().then(
                function (courtTypes) {
                    $scope.courtTypes = courtTypes;
                });

        }

        function setControlSettings() {
            //console.log("casesearch->setControlSettings");
            controlSettingSvc.getControlSettingsArray($scope.controlSettingsName)
                .then(function (s) {
                    console.info("CaseSearch: settings loaded...");
                    $scope.settings = s;
                }, function (err) {
                    console.error('unable to read the control setting', err);
                });
        }

        function init() {
            loadLists();

            setControlSettings();
        }

        //the session may be started before this controller loads. Therefore we must always call it on load
        init();

    }
})();;
(function () {
    'use strict';

    sc.ng.controllers.controller('changePwdCtrl', ['$scope', '$stateParams', '$state', 'authSvc', '$timeout', changePwdCtrl]);

    function changePwdCtrl($scope, $stateParams, $state, authSvc, $timeout) {

        $scope.changePasswordError = '';
        $scope.changePasswordMessage = '';
        $scope.promiseLoading = null;
        $scope.userName;

        $scope.changePassword = function () {
            //var formData = $('#changePasswordForm').serialize();
            $scope.changePasswordMessage = '';
            $scope.changePasswordError = '';

            var data = $scope.resetcredentials;
            data.userName = $scope.userName;

            $scope.promiseLoading = authSvc.changePassword(data).
                then(function (msg) {
                    //$scope.changePasswordMessage = 'Change Password Succeeded';
                    $scope.changePasswordMessage = msg;

                    $timeout(function () {
                        authSvc.logout();
                    }, 2000);

                }, function (err) {
                    $scope.changePasswordError = err;

                    if (err == 'Login is Disabled') {
                        $timeout(function () {
                            authSvc.logout();
                        }, 3000);
                    }
                });
        }


        function init() {
            //checks before allowing this UI:

            //1. The user's password just expired. In this case, there wont be a token so isAuthenticated() would be false
            if ($stateParams && $stateParams.passwordExpired) {
                $scope.userName = $stateParams.userName;
                return;
            }
            //2. user is authenticated and wants to change the password. This also ensures this is not the public user
            else if (authSvc.isAuthenticated()) {
                $scope.userName = authSvc.getUserName();
            }
            //otherwise return to home
            else {
                $state.go('home');
            }
        }

        init();
    }

})();;
(function () {
    'use strict';

    sc.ng.controllers.controller('chargeCtrl', ['$scope', '$state', 'caseSvc', '$stateParams', 'controlSettingSvc', chargeCtrl]);

    function chargeCtrl($scope, $state, caseSvc, $stateParams, controlSettingSvc) {
        var _caseID = $stateParams.caseID;
        var _printing = $stateParams.printing;

        $scope.controlSettingsName = 'gridCharges_ShowCaseWebSilverlight.CaseInquire';

        var _defaultColDef = [
            { data: 'chargeCount', target: 1, title: 'Count' },
            { data: 'courtStatuteNumber', title: 'Statute #' },
            { data: 'chargeDescription', title: 'Description' },
            { data: 'disposition', title: 'Disposition' },
            { data: 'dispositionDate', title: 'Disposition Date', render: renderDate, type: 'date' },
            { data: 'sentence', title: 'Sentence' },
            { data: 'offenseDate', title: 'Offense Date', render: renderDate, type: 'date' },
            { data: 'sentenceStatus', title: 'Sentence Status' },
            { data: 'citationNumber', title: 'Citation #' },
            { data: 'offenseLevelID', title: 'Offense Level' },
            { data: 'plea', title: 'Plea' },
            { data: 'pleaDate', title: 'Plea Date', render: renderDate, type: 'date' }
        ];

        var _excludedCols = [];

        $scope.dtInstance = null;
        $scope.dtColumns = controlSettingSvc.gridColDefs($scope.controlSettingsName , _defaultColDef, _excludedCols);
        $scope.dtOptions = {
            paginationType: 'numbers',
            displayLength: 25,  //pages are 25 rows
            bLengthChange: false,    //hide pagination option from top left
            searching: false,
            paging: (!_printing), //hide some options when printing...
            info: (!_printing),
            ordering: (!_printing),
            aaSorting: [], //no sort by default but stil allow users to sort
            responsive: true,
            autoWidth: false, //This is required to fix column width when columns are hidden
            oLanguage: { sZeroRecords: "No records found" },
            fnPromise: function () {

                if (!$scope.chargesLoading) 
                    $scope.chargesLoading = caseSvc.caseCharges(_caseID);

                return $scope.chargesLoading;
            }
        };

        //$scope.CaseCharges = [];
        //$scope.controlSetting;
        //$scope.gridColDefs = [];
        $scope.chargesLoading;

        $scope.controlsettingSaved = function (name) {
            //console.log('case party knows about it:' + name);
            //relaod control settings as the directvie requested
            $state.reload();
        }

        function renderDate(data) {
            if (data)
                return moment(data).format('MM/DD/YYYY');
            return '';
        }

    }   
})();;
(function () {
    'use strict';

    sc.ng.controllers.controller('citationSearchCtrl', ['$scope', '$state', 'caseSvc', citationSearchCtrl]);

    function citationSearchCtrl($scope, $state, caseSvc) {

        const _modalElement = "#citationSearchPanel";
        
        $scope.$on('showSearch', function (event, args) {
            
            if (args.panel !== 'citation') return;
            
            $(_modalElement)
                .prop('class', 'modal fade modal-search'); // revert to default

            $(_modalElement).modal('show');
        });

        $scope.searchArgs = {
            CitationNumber: null,
        };

        $scope.clear = function () {
            $scope.noResults = false;
        };

        $scope.search = function ($event) {

            $scope.noResults = false;

            if ($scope.searchArgs.CitationNumber) {

                $scope.schoolCertLoading = caseSvc.citationSearch({ CitationNumber: $scope.searchArgs.CitationNumber })
                    .then(function (citation) {
                        if (citation) {
                            $(_modalElement).modal('hide');
                            $state.transitionTo('schoolcompletion', { citInfo: citation }, { reload: true });
                        }
                        else {
                            $scope.noResults = true;
                        }
                    });
            }
            else {
                citationSearchform.$setValidity('Invalid citation number', false, window);
            }
            
        };
    }
})();;
(function () {
    'use strict';

    sc.ng.controllers.controller('courtEventCtrl', ['$scope', 'caseSvc', '$stateParams', '$state', 'controlSettingSvc', courtEventCtrl]);

    function courtEventCtrl($scope, caseSvc, $stateParams, $state, controlSettingSvc) {
        var _caseID = $stateParams.caseID;
        var _printing = $stateParams.printing;

        $scope.controlSettingsName = 'gridCourtEvent_ShowCaseWebSilverlight.CaseInquire';

        var _defaultColDef = [
            { data: 'courtEventDate', target: 1, title: 'Date', render: renderDate, type: 'date' },
            { data: 'courtEventTime', title: 'Time', render: renderTime },
            { data: 'courtEventType', title: 'Event Type' },
            { data: 'courtLocation', title: 'Location' },
            { data: 'courtRoom', title: 'Room' },
            { data: 'courtEventNotes', title: 'Notes' }
        ];

        var _excludedCols = [];

        $scope.dtInstance = null;
        $scope.dtColumns = controlSettingSvc.gridColDefs($scope.controlSettingsName, _defaultColDef, _excludedCols);
        $scope.dtOptions = {
            paginationType: 'numbers',
            displayLength: 25,  //pages are 25 rows
            bLengthChange: false,    //hide pagination option from top left
            paging: !_printing, //hide some options when printing...
            info: !_printing,
            ordering: !_printing,
            searching: false,
            //order: [0, 'asc'], //order by date by default
            aaSorting: [], //no sort by default but stil allow users to sort
            responsive: true,
            autoWidth: false, //This is required to fix column width when columns are hidden
            oLanguage: { sZeroRecords: "No records found" },
            fnPromise: function () {

                if (!$scope.courtEventsLoading) 
                    $scope.courtEventsLoading = caseSvc.caseCourtEvents(_caseID);

                return $scope.courtEventsLoading;
            },
            createdRow: createdRow
        };

        $scope.courtEventsLoading;
        //$scope.CaseCourtEvents = [];
        //$scope.controlSetting;
        //$scope.gridColDefs = [];


        $scope.controlsettingSaved = function (name) {
            //relaod control settings as the directvie requested
            $state.reload();
        }

        function renderDate(data) {
            if (data)
                return moment(data).format('MM/DD/YYYY');
            return '';
        }

        function renderTime(data) {
            //ref:http://momentjs.com/
            if (data)
                return moment(data).format('LT'); //example: 12:09 PM
            return '';
        }

        function createdRow(row, data) {
            if (data.courtEventType.indexOf('CANCELLED') > -1) {
                $(row).addClass('disabled-row');
            }
        }

        function init() {
            $.fn.dataTable.moment('LT');
        }

        init();
    }   
})();;

(function () {
    'use strict';

    sc.ng.controllers.controller('docketCtrl', ['$scope', '$stateParams', '$state', 'controlSettingSvc', 'caseSvc', '$window', '$compile','$timeout', docketCtrl]);

    function docketCtrl($scope, $stateParams, $state, controlSettingSvc, caseSvc, $window, $compile, $timeout) {

        var _caseID = $stateParams.caseID;
        var _printing = $stateParams.printing;
        var searchable = false;

        $scope.printing = _printing;
        $scope.docketsLoading;
        //$scope.Searchable = false;

        $scope.controlSettingsName = 'gridDockets_ShowCaseWebSilverlight.CaseInquire';

        var _defaultColDef = [
            //{ target: 0, title: '', orderable: false, render: function () { return ''; } }, // this empty col is requred when selecting a docket on touch devices
            { data: 'docketImage', target: 1, title: '', className: 'text-nowrap', orderable: false, render: renderImgIcons },
            { data: 'docketNumber', title: 'Docket #' },
            { data: 'effectiveDate', title: 'Effective Date', render: renderDate, type: 'date' },
            { data: 'docketCount', title: 'Count' },
            { data: 'description', title: 'Description' },
            { data: 'notes', title: 'Text' },
            { data: 'book', title: 'Book' },
            { data: 'page', title: 'Page' }
        ];

        var _excludedCols = ['docketID'];

        $scope.dtInstance = null;
        $scope.dtColumns = controlSettingSvc.gridColDefs($scope.controlSettingsName, _defaultColDef, _excludedCols);
        $scope.dtOptions = {
            paginationType: 'numbers',
            displayLength: 25,  //pages are 25 rows
            lengthChange: false,    //hide pagination option from top left
            searching: false,
            paging: (!_printing), //hide some options when printing...
            info: (!_printing),
            ordering: (!_printing),
            //order: [2, 'asc'], //sort by seqpos
            aaSorting: [], //no sort by default but stil allow users to sort
            responsive: true,
            colReorder: true,
            autoWidth: false, //This is required to fix column width when columns are hidden
            oLanguage: { sZeroRecords: "No records found" },
            fnPromise: function () {
                //max 07/13/2018 - this hack is required so angular-datable doesn't call the promise twice which affects layout and performance.
                //$scope.dtOptions = null;
                if (!$scope.docketsLoading)
                    $scope.docketsLoading = caseSvc.caseDockets(_caseID);

                return $scope.docketsLoading;
            },
            initComplete: function () {
                //if ($scope.dtInstance)
                //    $scope.dtInstance.DataTable.columns.adjust().draw();
            },
            createdRow: createdRow //compile row elements in angular
        };

        function createdRow(row, data, dataIndex) {
            // Recompiling so we can bind Angular directive to the DT
            $compile(angular.element(row).contents())($scope);
        }

        $scope.getImage = function (row) {
            var docket = $scope.dtInstance.DataTable.data()[row];
            //open the window right away to avoid browsers blocking the pop-up...
            _selectedDockets = [docket.docketID];

            //TODO: max 06/24/2019 - go straight to vor page instead of depending on redirect
            if (docket.vor) {
                //url = sc.baseURL + "home/vor?k=" + key + "&cid=" + _caseID;
                showVORModal();
                return;
            }

            var w = $window.open('', "_blank");
            
            caseSvc.getdocumentKey(_caseID, _selectedDockets , searchable)
                .then(function (key) {
                    var url = sc.baseURL + "home/pdfframe?k=" + key;

                    //max 06/24/2019 - go straight to vor page instead of depending on redirect
                    if (docket.vor) {
                        url = sc.baseURL + "home/vor?k=" + key + "&cid=" + _caseID;
                    }
                    
                    w.location = url;

                    //w.open(url, "_blank");
                    //...then set url of the opened window                    
                });
        };

        $scope.selectDocket = function (row) {
            var docket = $scope.dtInstance.DataTable.data()[row];
            docket.selected = !docket.selected;
        };

        var _selectedDockets = [];

        $scope.virtualCase = function () {
            _selectedDockets = [];
            var anyVOR = false;

            var dockets = $scope.dtInstance.DataTable.data();
            if (dockets) {
                for (var i = 0; i < dockets.length; i++) {
                    if (dockets[i].hasImages) {
                        _selectedDockets.push(dockets[i].docketID);

                        if (dockets[i].vor) {
                            anyVOR = true;
                        }
                    }
                }
            }
            
            if (_selectedDockets.length === 0) {
                console.log('No images available');
                return;
            }

            if (anyVOR) {
                //url = sc.baseURL + "home/vor?k=" + key + "&cid=" + _caseID;
                showVORModal();
                return;
            }

            var w = $window.open('', "_blank");

            caseSvc.getdocumentKey(_caseID, _selectedDockets, searchable)
                .then(function (key) {
                    var url = sc.baseURL + "home/pdfframe?k=" + key;

                    //max 06/24/2019 - go straight to vor page instead of depending on redirect
                    if (anyVOR) {
                        url = sc.baseURL + "home/vor?k=" + key + "&cid=" + _caseID;
                    }
                    
                    w.location = url;
                });
        };

        $scope.combineAndDownload = function () {
            _selectedDockets = [];
            var anyVOR = false;

            var dockets = $scope.dtInstance.DataTable.data();
            if (dockets) {
                for (var i = 0; i < dockets.length; i++) {
                    if (dockets[i].selected) {
                        _selectedDockets.push(dockets[i].docketID);

                        if (dockets[i].vor) {
                            anyVOR = true;
                        }
                    }
                }
            }

            if (_selectedDockets.length === 0) {
                console.log('No images selected');
                return;
            }

            if (anyVOR) {
                //url = sc.baseURL + "home/vor?k=" + key + "&cid=" + _caseID;
                showVORModal();
                return;
            }

            var w = $window.open('', "_blank");

            caseSvc.getdocumentKey(_caseID, _selectedDockets, searchable)
                .then(function (key) {
                    var url = sc.baseURL + "home/pdfframe?k=" + key;

                    //max 06/24/2019 - go straight to vor page instead of depending on redirect
                    if (anyVOR) {
                        url = sc.baseURL + "home/vor?k=" + key + "&cid=" + _caseID;
                    }
                  
                    w.location = url;
                });
        };

        $scope.vorPromiseLoading;
        $scope.emails;
        $scope.disableSubmitRequest = false;
        $scope.vorReqCompleted = false;

        $scope.submitVORRequest = function () {
            $scope.disableSubmitRequest = true;

            $scope.vorPromiseLoading = caseSvc.submitVORRequest(_caseID, $scope.emails, _selectedDockets).
                then(function () {
                    //wait 2 seconds then close
                    $scope.vorReqCompleted = true;

                    $timeout(function () {
                        $('#vor_modal').modal('hide');
                        $scope.emails = '';
                        $scope.disableSubmitRequest = false;
                    }, 3000);
                });

            _selectedDockets = [];
        };

        $scope.controlsettingSaved = function (name) {
            //console.log('case party knows about it:' + name);
            //relaod control settings as the directvie requested
            $state.reload();
        }

        function showVORModal() {
            if (!_selectedDockets.length) return;
            
            $scope.vorReqCompleted = false;

            $('#vor_modal').modal('show');
        }

        function renderDate(data) {
            if (data)
                return moment(data).format('MM/DD/YYYY');
            return '';
        }

        function renderImgIcons(data, type, docket, meta) {
            var iconClass = 'glyphicon glyphicon-paperclip';
            var tooltip = 'Document';
            var html = '';
            var modalAttr = '';
            var iconStyle = '';

            if (docket.vor) {
                tooltip = 'View On Request';
                iconClass = 'glyphicon glyphicon-lock';
                //this links it to the modal
                //modalAttr = 'data-toggle="modal" data-target="#vor_modal"';
            }

            //sealed should display only an icon.
            if (docket.sealed) {
                tooltip = 'No Access';
                iconClass = 'glyphicon glyphicon-ban-circle';
                iconStyle = 'color:red';

                html = '<button class="btn btn-link" uib-tooltip="' + tooltip + '">' +
                    '<span class="' + iconClass + '" style="' + iconStyle + '"></span>';
                    '</button>';
            }
            //vorPending should display only an icon.
            else if (docket.hasImages && !docket.sealed && docket.vorPending) {
                tooltip = 'View On Request Pending';
                iconClass = 'glyphicon glyphicon-lock';
                iconStyle = 'color:gray';

                html = '<button class="btn btn-link" uib-tooltip="' + tooltip + '">' +
                    '<span class="' + iconClass + '" style="' + iconStyle + '" aria-hidden="true"></span>';
                    '</button>';
            }
            else if (docket.hasImages && !docket.sealed) {
                html = '<input type="checkbox" style="margin-left:12px;" ng-click="selectDocket(' + meta.row + ')" role="checkbox" aria-checked="false" title="select document">' +
                    '<button role="button" class="btn btn-link" aria-label="document" ng-click="getImage(' + meta.row + ')" uib-tooltip="' + tooltip + '" ' + modalAttr + ' >' +
                        '<span class="' + iconClass + '" aria-hidden="true"></span>' +
                    '</button>';
            }

            return html;
        }
    }
})();;
(function () {
    'use strict';

    sc.ng.controllers.controller('feeCtrl', ['$scope', '$state', 'caseSvc', '$stateParams','controlSettingSvc', feeCtrl]);

    function feeCtrl($scope, $state, caseSvc, $stateParams, controlSettingSvc) {
        var _caseID = $stateParams.caseID;
        var _printing = $stateParams.printing;
        
        $scope.fcontrolSettingsName = 'gridFees_ShowCaseWebSilverlight.CaseInquire';
        $scope.epayURL = null;

        var _fdefaultColDef = [
            { data: 'effectiveDate', title: 'Effective Date', render: renderDate, type: 'date' },
            { data: 'dueDate', title: 'Due Date', render: renderDate, type: 'date'},
            { data: 'description', title: 'Description' },
            { data: 'amountDue', title: 'Amount Due', render: renderCurrency },
            { data: 'amountPaid', title: 'Amount Paid', render: renderCurrency },
            { data: 'balance', title: 'Balance', render: renderCurrency },
            { data: 'inCollections', title: 'In Collections' },
            { data: 'judgmentDate', title: 'In Judgment', render: renderDate, type: 'date' },
            { data: 'judgmentInterest', title: 'Judgment Interest', render: renderCurrency }
        ];

        var _fexcludedCols = [];

        $scope.fdtInstance = null;
        $scope.fdtColumns = controlSettingSvc.gridColDefs($scope.fcontrolSettingsName, _fdefaultColDef, _fexcludedCols);
        $scope.fdtOptions = {
            paging:false,
            searching: false,
            ordering: (!_printing),
            //order: [0, 'asc'], //order by effective Date by default
            aaSorting: [], //no sort by default but stil allow users to sort
            responsive: true,
            info: false,
            autoWidth: false, //This is required to fix column width when columns are hidden
            oLanguage: { sZeroRecords: "No records found" },
            fnPromise: function () {

                if (!$scope.caseFeesLoading) 
                    $scope.caseFeesLoading = caseSvc.caseFees(_caseID);

                return $scope.caseFeesLoading;
            },
            footerCallback: function (tfoot, caseFees) {
                buildTotals(caseFees);               
            }
        };

        //$scope.CaseFees = [];
        //$scope.CasePaymentPlans = [];
        //$scope.controlSetting;
        //$scope.tabPromiseLoading;
        $scope.totalBalance = 0;
        $scope.totalDue = 0;
        $scope.totalPaid = 0;
        $scope.totalInterest = 0;

        $scope.paymentsLoading;

        $scope.pcontrolSettingsName = 'gridPaymentPlan_ShowCaseWebSilverlight.CaseInquire';

        $scope.controlsettingSaved = function (name) {
            //console.log('case party knows about it:' + name);
            //relaod control settings as the directvie requested
            $state.reload();
        }

        var _pdefaultColDef = [
            { data: 'source', title: 'Plan' },
            { data: 'amountDue', title: 'Scheduled Pay Amount', render: renderCurrency },
            { data: 'originalAmount', title: 'Balance Due', render: renderCurrency },
            { data: 'partialPayVal', title: 'Partial Payment', render: renderCurrency }
        ];

        var _pexcludedCols = [];

        $scope.pdtInstance = null;
        $scope.pdtColumns = controlSettingSvc.gridColDefs($scope.pcontrolSettingsName, _pdefaultColDef, _pexcludedCols);
        $scope.pdtOptions = {
            paging: false,
            searching: false,
            ordering: (!_printing),
            responsive: true,
            aaSorting: [], //no sort by default but stil allow users to sort
            info: false,
            autoWidth: false, //This is required to fix column width when columns are hidden
            oLanguage: { sZeroRecords: "No records found" },
            fnPromise: function () {

                if (!$scope.paymentsLoading) 
                    $scope.paymentsLoading = caseSvc.casePaymentPlans(_caseID);

                return $scope.paymentsLoading;
            },
        };

        function renderDate(data) {
            if (data)
                return moment(data).format('MM/DD/YYYY');
            return '';
        }

        function renderCurrency(data) {
            return common.formatCurrency(data);
        }

        function buildTotals(caseFees) {

            $scope.totalBalance = 0;
            $scope.totalDue = 0;
            $scope.totalPaid = 0;
            $scope.totalInterest = 0;

            if (caseFees) {
                for (var i = 0; i < caseFees.length; i++) {
                    $scope.totalBalance += caseFees[i].balance;
                    $scope.totalDue += caseFees[i].amountDue;
                    $scope.totalPaid += caseFees[i].amountPaid;
                    $scope.totalInterest += caseFees[i].judgmentInterest;
                }

                if (($scope.totalBalance + $scope.totalInterest) > 0) {
                    //show epay button
                    controlSettingSvc.getEpayURL($stateParams.caseID)
                        .then(function (url) {
                            $scope.epayURL = url;
                        });
                }
            }
        }    
    }
})();;
(function () {
    'use strict';

    sc.ng.controllers.controller('linkedCasesCtrl', ['$scope', '$state', 'caseSvc', '$stateParams','controlSettingSvc', linkedCasesCtrl]);

    function linkedCasesCtrl($scope, $state, caseSvc, $stateParams, controlSettingSvc) {
        var _caseID = $stateParams.caseID;
        var _printing = $stateParams.printing;

        $scope.controlSettingsName = 'gridRelatedCases_ShowCaseWebSilverlight.CaseInquire';

        var _defaultColDef = [
            { data: 'caseNumber', target: 1, title: 'Case #' },
            { data: 'name', title: 'Case Description' },
            { data: 'offenseDate', title: 'Offense Date', render: renderDate, type: 'date' },
            { data: 'caseStatus', title: 'Status' }
        ];

        var _excludedCols = ["caseID"];

        $scope.dtInstance = null;
        $scope.dtColumns = controlSettingSvc.gridColDefs($scope.controlSettingsName, _defaultColDef, _excludedCols);
        $scope.dtOptions = {
            paginationType: 'numbers',
            displayLength: 25,  //pages are 25 rows
            bLengthChange: false,    //hide pagination option from top left
            searching: false,
            paging: (!_printing), //hide some options when printing...
            info: (!_printing),
            ordering: (!_printing),
            //order: [1, 'asc'], //order by caseNumber by default
            aaSorting: [], //no sort by default but stil allow users to sort
            responsive: true,
            autoWidth: false, //This is required to fix column width when columns are hidden
            oLanguage: { sZeroRecords: "No records found" },
            fnPromise: function () {

                if (!$scope.linkedCasesLoading) 
                    $scope.linkedCasesLoading = caseSvc.linkedCases(_caseID);

                return $scope.linkedCasesLoading;
            }
        };

        $scope.linkedCasesLoading;

        $scope.controlsettingSaved = function (name) {
            //relaod control settings as the directvie requested
            $state.reload();
        }

        function renderDate(data) {
            if (data)
                return moment(data).format('MM/DD/YYYY');
            return '';
        }
    }   
})();;
(function () {
    'use strict';

    sc.ng.controllers.controller('loginCtrl', ['$scope', '$state', 'authSvc','$timeout', loginCtrl]);

    function loginCtrl($scope, $state, authSvc, $timeout) {

        //$scope.$on('sessionStarted', function (event, args) {
        //    init();
        //});

        $scope.message = '';
        $scope.credentials = {
            username: '',
            password: '',
            clear: function () {
                this.username = '';
                this.password = '';
            }
        };

        $scope.changePasswordError = '';
        $scope.changePasswordMessage = '';
        $scope.promiseLoading = null;

        $scope.login = function ($event) {
            //var token = $('#loginform input[name="__RequestVerificationToken"]').val();
            //var formData = $('#loginform').serialize();
            //var dataWithAntiforgeryToken = $.extend(formData, { '__RequestVerificationToken': token });
            $scope.message = '';

            //$scope.loginMVC();

            $scope.promiseLoading = authSvc.login($scope.credentials)
                .then(function (response) {

                    $scope.message = 'Authentication succeeded!';

                    $timeout(function () {
                        $('#login_modal').modal('hide');
                        $scope.credentials.clear();
                        //reload the state since we have new user context
                        $state.go('home', {}, { reload: true });
                        //$state.reload();
                    }, 1000);
                },
                    function (err) {
                        if (err && err.data && err.data.error_description) {
                            $scope.message = err.data.error_description;
                            if (err.data.error_description === 'Password has expired') {
                                $timeout(function () {
                                    $('#login_modal').modal('hide');
                                    var user = $scope.credentials.username;
                                    //go to password view but pass username and flag that we are not authenticated
                                    $state.go('changepassword', { userName: user, passwordExpired: true });
                                }, 1000);
                            }
                        }
                        else {
                            $scope.message = ':-( Server Error';
                        }
                    });
        };

        $scope.getUserName = authSvc.getUserName;

        $('#login_modal').on('hidden.bs.modal', function () {
            $scope.credentials.clear();
            $scope.message = '';
        });

        //function init() {
        //    if (!authSvc.isAuthenticated()) {
        //        $state.go('home');
        //    }
        //}

        //init();
    }
})();;
(function () {
    'use strict';

    sc.ng.controllers.controller('navCtrl', ['$scope', '$state', '$window', '$rootScope', 'caseSvc', 'authSvc','controlSettingSvc', navCtrl]);

    function navCtrl($scope, $state, $window, $rootScope, caseSvc, authSvc, controlSettingSvc) {

        $scope.$on('sessionStarted', function (event, args) {
            //init must now be called every time. both public and authenticated users will reais the sessionStarted event.
            init();
            //if (args && args.accessToken) {
            //    console.log('access token');
            //    //only init when a session has started. this should be reaised by public, showcase or windows users.
            //    init();
            //} 
        });

        $scope.$on('handleLogOut', function (event) {
            // this forces to clear all states which may includ users-specific results
            $window.location.href = sc.baseURL;
        });

        $scope.i = {
            isAuthenticated: false,
            userName: null,
            judgeID: null,
            barNumber: null
        };

        $scope.mainnav = null;

        $scope.toggleSearch = function (panel) {

            collapsMenu();

            //Max 08/07/2017 - moved to casesearch.controller
            $rootScope.$broadcast('showSearch', { panel: panel });
        };

        $scope.showlogin = function () {
            collapsMenu();
            $('#login_modal').modal('show');
        };

        $scope.logout = function () {
            authSvc.logout();
        };

        $scope.$on('$stateChangeStart', function (event, toState, toParams, fromState, fromParams, options) {
            collapsMenu();
        });

        function collapsMenu() {
            
            if ($('#mainNavBarCollapse:hidden').length === 0 && $('#mainNavBarCollapse').hasClass('collapse in')) {
                //hides the expanded menu since the page will not refresh in a SPA
                $('#navCollapse').click();
            }
        }

        //Richard Marens 02/01/2019 SC-1176
        $scope.recentCases = [];
        
        //Richard Marens 02/01/2019 SC-1176
        $scope.$on('handleRecentCasesUpdate', function (event, newRecentCases) {
            $scope.recentCases = newRecentCases;
        });

        //Richard Marens 02/01/2019 SC-1176
        $scope.recentCaseSelect = function (rc) {
            //$state.go('caseDetails', rc, {reload:true});

            caseSvc.getcaseKey(rc.caseID, rc.nameID)
                .then(function (casekey) {

                    if (casekey) {
                        $state.go('caseDetails', { key: casekey }, { reload: true });
                    }
                });
        };
       
        $scope.startWinSession = async function (id) {
            const retries = 3;
            for (let i = 1; i <= retries; i++) {
                try {
                    //add 500 ms delay to avoid starting a windows session too early.
                    await new Promise(r => setTimeout(r, 500));
                    var result = await authSvc.startWinSession(id);
                    break;
                }
                catch (ex) {
                    //sometimes we try too early and browser wont send windows token.
                    console.log('unable to start session for SSO user...attempt' + i);
                }
            }
        };
        
        $scope.startPubSession = function (publicUser, captchaEnabled) {

            //check if non-public user is logged in.
            if (!authSvc.isAuthenticated()) {
                //var user = authSvc.getUserName()
                authSvc.startPubSession(publicUser, captchaEnabled);    
            }

            //authSvc.startPubSession(publicUser, captchaEnabled);                        
        };

        //Richard Marens 02/01/2019 SC-1176
        function clearRecentCases() {
            $scope.recentCases = authSvc.clearRecentCases();
        }

        //Richard Marens 02/01/2019 SC-1176
        function loadRecentCases(maxCases) {
            $scope.recentCases = authSvc.loadRecentCases(maxCases);
        }

        function init() {
            controlSettingSvc.clearControlSettings();

            //$scope.i.isAuthenticated = authSvc.isAuthenticated();
            //$scope.i.userName = authSvc.getUserName();

            //Richard Marens 02/01/2019 SC-1176
            if (authSvc.isAuthenticated()) {
                $scope.i.isAuthenticated = true;
                $scope.i.userName = authSvc.getUserName();
                loadRecentCases();
            }
            else {
                $scope.i.isAuthenticated = false;
                $scope.i.userName = null;
                clearRecentCases();
            }
            
            controlSettingSvc.getMainNavSettings()
                .then(function (d) {
                    //console.log({ mainnav: d });
                    $scope.mainnav = d;
                    $scope.i.judgeID = d.judgeID;
                    $scope.i.barNumber = d.barNumber;
                });
        }

        //the session may be started before this controller loads. Therefore we must always call it on load
        init();
    }
})();;
(function () {
    'use strict';

    sc.ng.controllers.controller('partyCtrl', ['$scope', '$state', 'caseSvc', '$stateParams', '$compile','controlSettingSvc', partyCtrl]);

    function partyCtrl($scope, $state, caseSvc, $stateParams, $compile, controlSettingSvc) {
        var _caseID = $stateParams.caseID;
        var _printing = $stateParams.printing;

        $scope.controlSettingsName = 'gridParty_ShowCaseWebSilverlight.CaseInquire';
        var _defaultColDef = [
            { data: 'fullName', title: 'Full Name', render: renderFullName },
            { data: 'partyType', title: 'Party Type' },
            { data: 'sex', title: 'Gender' },
            { data: 'dob', title: 'DOB', render: renderDates, type: 'date' },
            { data: 'akAs', title: 'AKAs', render: renderAKAs },
            { data: 'dod', title: 'Deceased', render: renderDates, type: 'date' },
            { data: 'countyID', title: 'Sheriff\'s #' },
            { data: 'hair', title: 'Hair' },
            { data: 'eyes', title: 'Eyes' }
        ];

        var _excludedCols = ['caseID', 'partyID'];

        $scope.dtInstance = null;
        $scope.dtColumns = controlSettingSvc.gridColDefs($scope.controlSettingsName, _defaultColDef, _excludedCols);
        $scope.dtOptions = {
            paginationType: 'numbers',
            displayLength: 25,  //pages are 25 rows
            bLengthChange: false,    //hide pagination option from top left
            searching: false,
            paging: (!_printing), //hide some options when printing...
            info: (!_printing),
            ordering: (!_printing),
            //order: [1, 'asc'], //order by first column by default
            aaSorting: [], //no sort by default but stil allow users to sort
            responsive: true,
            colReorder: true,
            autoWidth: false, //This is required to fix column width when columns are hidden
            oLanguage: { sZeroRecords: "No records found" },
            fnPromise: function () {
                
                if (!$scope.partyLoading)
                    $scope.partyLoading = caseSvc.caseParties(_caseID);

                return $scope.partyLoading;
            },
            createdRow: createdRow 
        };

        function createdRow(row, data, dataIndex) {
            // Recompiling so we can bind Angular directive to the DT
            $compile(angular.element(row).contents())($scope);
        }

        $scope.partyLoading;
        $scope.CaseParties = [];
        $scope.CaseMainParties;
        $scope.PartyAttorneys = [];
        $scope.PartyName;

        $scope.togglePartyAttorneys = function (partyID, partyName) {
            
            caseSvc.getPartyAttorneys(partyID).
                then(function (d) {
                    $scope.PartyAttorneys = d.data;
                });

            $scope.PartyName = partyName;

            $('#partyAttorneysPanel')
                .prop('class', 'modal fade modal-search') // revert to default
                .addClass($(this).data('direction'));

            $('#partyAttorneysPanel').modal('show');
        }

        $scope.controlsettingSaved = function (name) {
            //console.log('case party knows about it:' + name);
            //relaod control settings as the directvie requested
            $state.reload();
        }

        function renderDates(date) {
            if (date && moment)
                return moment(date).format('MM/DD/YYYY');
            return '';
        }

        function renderAKAs(akas) {
            if (akas && Array.isArray(akas))
                return akas.join('; ');
            return akas;
        }

        function renderFullName(fullName, type, party, meta) {
            if (party.partyAttorneyCount) {
                var cellHtml = '<span>' + fullName + '</span> ' +
                    '<span style="float:right;">  ' +
                    '    <a href="" ng-click="togglePartyAttorneys(' + party.partyID + ', \'' + fullName + '\')"> ' +
                    '        <img src="Images/attorney.png"' +
                    '            alt="Party Attorneys"' +
                    '            title="Click to see attorneys associated to this party"' +
                    '            style="width: 24px; height: 24px" />' +
                    '    </a>' +
                    '</span>';
                return cellHtml;
            }

            return fullName;
        }

        function init() {
            
            caseSvc.caseMainParties(_caseID).
                then(function (mainParties) {
                    $scope.CaseMainParties = mainParties;
                });

        }

        init();
    }   
})();;
(function () {
    'use strict';

    sc.ng.controllers.controller('schoolCompletionCtrl', ['$scope', '$state', '$stateParams', 'caseSvc', '$rootScope', schoolCompletionCtrl]);

    function schoolCompletionCtrl($scope, $state, $stateParams, caseSvc, $rootScope) {

        $scope.Citation;    
        $scope.schoolCertLoading;

        $scope.processed = false;
        $scope.errorMsg;
        $scope.validFile = true;

        var $fi; //jquery element for fileinput

        $scope.dateControl = {
            showWeeks: false,
            opened: false,
            open: function ($event) {
                this.opened = true;
            },
            maxDate: Date.now()
        };

        $scope.certRequest;
        $scope.certFile; //this model is updated by the file-model directive
        $scope.fileName;

        $scope.submitSchoolCompletion = function () {
            if (!$scope.validFile)
                return;

            $scope.errorMsg = false;
            $scope.processed = false;

            if ($scope.certRequest && $scope.certRequest.CitationNumber) {
                $scope.schoolCertLoading = caseSvc.submitSchoolCertificate($scope.certRequest, $scope.certFile).
                    then(function () {
                        $scope.processed = true;
                        $scope.errorMsg = null;

                        $fi.fileinput('clear'); //clear
                    }, function (er) {
                        $scope.errorMsg = 'Unable to process your request. Please, try again later.';
                    });
            }
        };

        $scope.showSearch = function () {
            $rootScope.$broadcast('showSearch', 'citation');
            $state.go('home');
        };

        function init() {

            if (!$stateParams.citInfo || !$stateParams.citInfo.caseResult.citationNumber) {
                $state.go('home');
                return;
            }

            //setup bootstrap file input
            $fi = $("#cert-file");

            $fi.fileinput({
                //rtl: true,
                //uploadUrl: 'sci/case/updatecitationschool',
                showCaption: false,
                captionClass: 'fileinput-caption',
                msgPlaceholder:'',
                maxFileCount: 1,
                showCancel: false,
                showPreview: false,
                browseLabel:'Browse',
                autoReplace: true,
                allowedFileExtensions: ["pdf", "tif", "tiff"],
                maxFileSize:25600, //25MB
                //hiddenThumbnailContent: true
            }).on('fileclear', function (event) {
                $scope.fileName = null;
            }).on('fileerror', function (event, data, msg) {
                $fi.fileinput('clear'); //clear
                $fi.fileinput('refresh', { showRemove: false }); //remove the "Remove" button
                $scope.fileName = null;
                $scope.errorMsg = msg;
            }).on('fileloaded', function (event, data, msg) {
                $scope.errorMsg = null
                $fi.fileinput('refresh', { showRemove: true }); //show the "Remove" button
                $scope.fileName = data.name;
            });

            $scope.Citation = $stateParams.citInfo;

            $scope.certRequest = {
                CitationNumber: $stateParams.citInfo.caseResult.citationNumber,
                CompletionDate: null,
                Description: null
            };

            //_searchArgs = {
            //    CitationNumber: 'A47WZMF',
            //    //DLNumber: 'S143323552430',
            //    //DOB: '1955-07-03'
            //};
        }

        init();
    }
})();;
(function () {
    'use strict';

    sc.ng.controllers.controller('searchResultsCtrl', ['$scope', '$state', 'caseSvc', '$stateParams', '$compile', 'controlSettingSvc', caseSearchCtrl]);

    function caseSearchCtrl($scope, $state, caseSvc, $stateParams, $compile, controlSettingSvc) {

        var _searchArgs;
        var _viewSealedCase = false;

        $scope.controlSettingsName = 'sgCaseSearch_ShowCaseWebSilverlight.CaseInquire';

        $scope.gridOptions = {
            paginationType: 'numbers',
            displayLength: 25,  //pages are 25 rows
            lengthChange: false,    //hide pagination option from top left
            order: [1], //order by caseNumber by default
            responsive: true,
            keys: true
        };

        // < th class="details-control sorting_disabled" rowspan = "1" colspan = "1" aria - label="" style = "width: 16px;" ></th >

        $scope.maxResults = 199;
        $scope.tooMany = false;
        $scope.SearchResults;
        $scope.controlSettings;
        $scope.promiseLoading = null;
        $scope.myCases = ($stateParams.searchArgs && ($stateParams.searchArgs.judgeID || $stateParams.searchArgs.barNumber)); //used by breadcrum

        var _defaultColDef = [
            { target: 0, title: '', type: 'html', orderable: false, render: renderMugShot }, //Mugshot
            { data: 'caseNumber', title: 'Case #', className: 'text-nowrap', responsivePriority: 1, render: renderCaseNumber }, //note: if the responsie layout removes the case number, it will never compile in angularjs so raise responsivePriority
            { data: 'citationNumber', title: 'Citation #', },
            { data: 'name', title: 'Name', className: 'text-nowrap', responsivePriority: 2 },
            { data: 'dob', title: 'DOB', render: renderDates, type: 'date' },
            { data: 'dlNumber', title: 'DL Number', className: 'text-nowrap' },
            { data: 'sex', title: 'Gender' },
            { data: 'race', title: 'Race' },
            { data: 'fileDate', title: 'File Date', render: renderDates, responsivePriority: 3, type: 'date' },
            { data: 'caseStatus', title: 'Status' },
            { data: 'offenseDate', title: 'Offense Date', render: renderDates, type: 'date' },
            { data: 'arrestDate', title: 'Arrest Date', render: renderDates, type: 'date' },
            { data: 'speedyTrialDueDate', title: 'Speedy Trial Due Date', render: renderDates, type: 'date' },
            { data: 'speedyTrialDemandDate', title: 'Speedy Trial Demand Date', render: renderDates, type: 'date' },
            { data: 'speedyTrialWaivedDate', title: 'Speedy Trial Waived Date', render: renderDates, type: 'date' },
            { data: 'capiasIssuedDate', title: 'Capias Issued Date', render: renderDates, type: 'date' },
            { data: 'restitutionBalance', title: 'Restitution Balance', render: renderCurrency },
            { data: 'feeBalance', title: 'Balance', render: renderCurrency }
        ];

        //var _excludedCol = ['nameSuffix', 'bookingSheetNumber', 'saNumber', 'incidentNumber', 'offenderNumber', 'speedyTrialDueDate',
        //    'speedyTrialDemandDate', 'speedyTrialWaivedDate', 'address1', 'address2', 'capiasIssuedDate', 'zipCode', 'tagState','ucn'];
        var _excludedCol = ['nameSuffix', 'address2', 'ucn']; //nameSuffix was renamed in the model to match DB which says suffixName

        $scope.dtInstance = null;
        $scope.dtColumns = controlSettingSvc.gridColDefs($scope.controlSettingsName, _defaultColDef, _excludedCol);
        $scope.dtOptions = {
            paginationType: 'numbers',
            displayLength: 25,  //pages are 25 rows
            lengthChange: false,    //hide pagination option from top left
            order: [1], //sort by caseNumber by default
            responsive: true,
            autoWidth: false, //This is required to fix column width when columns are hidden
            oLanguage: { sZeroRecords: "No records found" },
            fnPromise: function () {
              
                //$scope.promiseLoading = caseSvc.caseSearch(_searchArgs)
                if (!$scope.promiseLoading)
                    $scope.promiseLoading = controlSettingSvc.getMainNavSettings()
                        .then(function (d) {
                            _viewSealedCase = d.viewSealedCase;
                        })
                        .then(function (c) {
                            return caseSvc.caseSearch(_searchArgs)
                        })
                        .then(function (caseResults) {
                            $scope.tooMany = (caseResults && caseResults.length > $scope.maxResults);
                            return caseResults;
                        });

                return $scope.promiseLoading;
            },
            createdRow: createdRow, //compile row elements in angular
            dom: 'rtip',
            language: {
                sSearch: '<span class="glyphicon glyphicon-filter" title="Filter"></span>',
                sInfo: "Showing _START_ to _END_", //"Got a total of _TOTAL_ entries to show (_START_ to _END_)"
                //sLengthMenu: "Display _MENU_ records" //Display _MENU_ records
            },
            //drawCallback: function (settings) {
            //    //settings.aoHeader[0][0].
            //    console.log({ drawCallback: $scope.dtInstance, settings});
            //},
            headerCallback: function (thead, data, start, end, display) {
                //$(thead).find('th').eq(0).html('Displaying ' + (end - start) + ' records');
                let headerValue = $(thead).find('th').eq(0).html();

                //console.log({ data, headerValue, display });
                
                if (!headerValue) {
                    //replace empty th with td per accessibility guidelines
                    //https://webaim.org/techniques/tables/data
                    $(thead).find('th').eq(0).wrapInner('<td />').contents().unwrap();
                }
            }
        };

        $scope.goToCaseDetails = function (row) {

            var d = $scope.dtInstance.DataTable.data()[row];
            //console.log(d.caseNumber);

            caseSvc.getcaseKey(d.caseID, d.nameID)
                .then(function (casekey) {

                    if (casekey) {
                        $state.go('caseDetails', { key: casekey, result: d });
                    }
                });
        };

        $scope.controlsettingSaved = function (name) {
            //console.log('search result knows about it:' + name);
            //relaod control settings as the directvie requested
            $state.reload();
        }

        $scope.resultMessage = function () {
            if (caseSvc.getSearchResults() && caseSvc.getSearchResults().length > 0) {
                return 'Search found ' + caseSvc.getSearchResults().length + ' results';
            }
            else
                return 'No results';
        }

        function init() {

            _searchArgs = $stateParams.searchArgs;
            var results = caseSvc.getSearchResults();

            if (!_searchArgs && results && results.length === 0) {
                $state.go('home');
                return;
            }

            if (_searchArgs)
                _searchArgs.maxResults = $scope.maxResults;
        }

        function createdRow(row, data, dataIndex) {
            // Recompiling so we can bind Angular directive to the DT

            //console.log({ dataIndex,  row });

            if (caseSvc.isCaseSecured(data)) {
                //Add secure case style
                $(row).addClass('danger');
                //Add tooltip
                $(row).attr('title', caseSvc.secureInfo(data));
            }

            $compile(angular.element(row).contents())($scope);
        }

        function renderDates(data) {
            if (data) { 
                return moment(data).format('MM/DD/YYYY');
                }
            return '';
        }

        function renderCaseNumber(data, type, c, meta) {
            var warrantIcon = '';
            var title = c.caseNumber;

            if (c.hasOpenWarrant) {
                warrantIcon = '<span class="glyphicon glyphicon-asterisk" style="color:#a94442;padding-right: 2px;"></span>';
                title = 'Open Warrant';
            }

            if (c.isSealedCase && !_viewSealedCase) {
                return '<p>' + warrantIcon + c.caseNumber + '</p>';
            }
            else {
                return '<a title="' + title + '" href="" ng-click="goToCaseDetails(' + meta.row + ')">' + warrantIcon + c.caseNumber + '</a>';
            }
        }

        function renderMugShot(data, type, c, meta) {
            //look at mugshot.directive.js for details of implementation
            return '<img mugshot caseid="' + c.caseID + '" lname="' + c.lastName + '" fname="' + c.firstName + '" height="65" width="48" />';
        }

        function renderCurrency(data, type, c, meta) {
            if (data) {
                return common.formatCurrency(data);
            }
            return '';
        }

        init();
    }
})();;
(function () {
    'use strict';

    sc.ng.controllers.controller('sentenceCtrl', ['$scope', 'caseSvc', '$stateParams', '$state', 'controlSettingSvc', sentenceCtrl]);

    function sentenceCtrl($scope, caseSvc, $stateParams, $state, controlSettingSvc) {
        var _caseID = $stateParams.caseID;
        var _printing = $stateParams.printing;

        $scope.controlSettingsName = 'gridSentences_ShowCaseWebSilverlight.CaseInquire';

        var _defaultColDef = [
            { data: 'sentenceImposedDate', title: 'Date', render: renderDate, type: 'date' },
            { data: 'chargeCount', title: 'Count' },
            { data: 'sentence', title: 'Sentence' },
            { data: 'confinement', title: 'Confinement' },
            { data: 'term', title: 'Term' },
            { data: 'creditTime', title: 'CreditTime' },
            { data: 'conditions', title: 'Conditions' },
            { data: 'sentenceStatus', title: 'Status' }
        ];

        var _excludedCols = [];

        $scope.dtInstance = null;
        $scope.dtColumns = controlSettingSvc.gridColDefs($scope.controlSettingsName, _defaultColDef, _excludedCols);
        $scope.dtOptions = {
            paginationType: 'numbers',
            displayLength: 25,  //pages are 25 rows
            bLengthChange: false,    //hide pagination option from top left
            searching:false,
            paging: (!_printing), //hide some options when printing...
            info: (!_printing),
            ordering: (!_printing),
            aaSorting: [], //no sort by default but stil allow users to sort
            responsive: true,
            autoWidth: false, //This is required to fix column width when columns are hidden
            oLanguage: { sZeroRecords: "No records found"},
            fnPromise: function () {

                if (!$scope.sentenceLoading) 
                    $scope.sentenceLoading = caseSvc.caseSentences(_caseID);

                return $scope.sentenceLoading;
            }
        };

        $scope.controlsettingSaved = function (name) {
            //console.log('case sentences knows about it:' + name);
            //relaod control settings as the directvie requested
            $state.reload();
        }

        //$scope.CaseSentences = [];
        //$scope.controlSetting;
        //$scope.tabPromiseLoading;

        //$scope.gridColDefs = [];

        function renderDate(data) {
            if (data)
                return moment(data).format('MM/DD/YYYY');
            return '';
        }
    }   
})();;
(function () {
    'use strict';

    sc.ng.controllers.controller('setCourtDateCtrl', ['$scope', '$state', 'caseSvc', 'calSvc', setCourtDateCtrl]);

    function setCourtDateCtrl($scope, $state, caseSvc, calSvc) {

        $scope.goToSearch = function () {
            $state.transitionTo('setcourtdate', null, {reload: true});
        };

        $scope.searchArgs = {
            CitationNumber: '',
            DLNumber: '',
            DOB: '',
            forceValidation: true
        };

        $scope.searchResult = null;
        $scope.assignCourtDateObj = null;
        $scope.searchMode = true;
        $scope.searchResultMode = false;
        $scope.confirmationMode = false;

        $scope.disableSearch = false;
        $scope.disableSetCourtDate = false;
        $scope.modalError = null;
        $scope.modalTitle = null;

        $scope.clear = function () {
            for (var prop in $scope.searchArgs) {
                switch (prop) {
                    default:
                        $scope.searchArgs[prop] = null;
                }
            }

            $scope.clearSearchResult();
            $scope.modalTitle = null;
            $scope.modalError = null;
        }
        
        $scope.clearSearchResult = function () {
            $scope.searchMode = true;
            $scope.searchResultMode = false;
            $scope.disableSearch = false;
        }

        $scope.citationsearch = function () {
            $scope.clearSearchResult();
            $scope.disableSearch = true;

            //$state.transitionTo('citationsearchresult', { citationSearchArgs: $scope.searchArgs }, { reload: true });
            $scope.citationPromiseLoading = caseSvc.citationSearch($scope.searchArgs)
                    .then(function (r) {
                        //when there is a success result, turn off search mode so the result can be displayed.
                        $scope.searchResult = r;
                        $scope.searchMode = false;
                        $scope.searchResultMode = true;
                        $scope.disableSearch = false;
                    },
                   function (err) {
                       console.log('Error searching for citation.', err);
                       var message;
                       if (err.data !=null && err.data.message != null) {
                           err = err.data.message;
                        }

                       $scope.showErrorModal('Error searching for citation.', err);
                       $scope.disableSearch = false;
                   });
        }

        $scope.setcourtdate = function (caseID) {
            $scope.disableSetCourtDate = true;

            $scope.setCourtDatePromiseLoading = caseSvc.setCourtDate(caseID)
                .then(function (r) {

                    if(r.result != null)
                    {
                        if (r.result.Error != null) {
                            console.log('Error setting court date.', r.result.Error);
                            $scope.showErrorModal('Could not set court date.', r.result.Error);
                        }
                        else {
                            $scope.assignCourtDateObj = r.result.AssignCourtDate;

                            if ($scope.assignCourtDateObj != null) {
                                if ($scope.assignCourtDateObj.ResultMessage != null) {
                                    if ($scope.assignCourtDateObj.ResultMessage.toUpperCase() != "SUCCESS") {
                                        $scope.showErrorModal('Could not set court date.', $scope.assignCourtDateObj.ResultMessage);
                                    }
                                    else
                                    {
                                        //when there is a success result, change to conf mode.
                                        $scope.searchResultMode = false;
                                        $scope.confirmationMode = true;
                                    }
                                }
                            }
                        }
                    }

                    $scope.finishSetCourtDate();
                },
                function (err) {
                    console.log('Error setting court date.', err);
                    var message;
                    if (err.data != null && err.data.message != null) {
                        err = err.data.message;
                    }

                    $scope.showErrorModal('Error setting court date.', err);
                    $scope.finishSetCourtDate();
                });
        }

        $scope.finishSetCourtDate = function () {
            $scope.disableSetCourtDate = false;
        }

        $scope.showErrorModal = function (title, error) {
            $scope.modalTitle = title;
            $scope.modalError = error;
            $('#setcourtdate-errormodal').modal('show');
        }

        $scope.$print = function () {
            window.print();
        };
    }
})();;
(function () {
    'use strict';

    sc.ng.controllers.controller('warrantCtrl', ['$scope', 'caseSvc', '$stateParams','$state', '$window', '$compile','controlSettingSvc', warrantCtrl]);

    function warrantCtrl($scope, caseSvc, $stateParams, $state,$window, $compile, controlSettingSvc) {
        var _caseID = $stateParams.caseID;
        var _printing = $stateParams.printing;

        $scope.controlSettingsName = 'gridWarrant_ShowCaseWebSilverlight.CaseInquire';

        var _wdefaultColDef = [
            { data: 'warrantType', title: 'Warrant Type', render: renderWarrantType },
            { data: 'warrantNumber', title: 'Warrant #'},
            { data: 'issueDate', title: 'Issue Date', render: renderDate, type: 'date' },
            { data: 'actionDate', title: 'Effective Date', render: renderDate, type: 'date'},
            { data: 'warrantReturnReason', title: 'Reason'},
            { data: 'lastAction', title: 'Last Action'}
        ];

        var _wexcludedCols = [];

        $scope.wdtInstance = null;
        $scope.wdtColumns = controlSettingSvc.gridColDefs($scope.controlSettingsName, _wdefaultColDef, _wexcludedCols);
        $scope.wdtOptions = {
            paginationType: 'numbers',
            displayLength: 25,  //pages are 25 rows
            lengthChange: false,    //hide pagination option from top left
            searching: false,
            paging: (!_printing), //hide some options when printing...
            info: (!_printing),
            ordering: (!_printing),
            aaSorting: [], //no sort by default but stil allow users to sort
            responsive: true,
            autoWidth: false, //This is required to fix column width when columns are hidden
            oLanguage: { sZeroRecords: "No records found" },
            fnPromise: function () {

                if (!$scope.warrantsLoading) 
                    $scope.warrantsLoading = caseSvc.caseWarrants(_caseID);

                return $scope.warrantsLoading;
            },
            createdRow: createdRow
        };

        var _dcontrolSetting = "gridDockets_ShowCaseWebSilverlight.CaseInquire";
        
        var _ddefaultColDef = [
            { target: 0, title: '', orderable: false, render: function () { return ''; } }, // this empty col is requred when selecting a docket on touch devices
            { data: 'docketImage', target: 1, title: '', className: 'text-nowrap', orderable: false, render: renderImgIcons },
            { data: 'docketNumber', title: 'Docket #' },
            { data: 'effectiveDate', title: 'Effective Date', render: renderDate },
            { data: 'docketCount', title: 'Count' },
            { data: 'description', title: 'Description' },
            { data: 'notes', title: 'Text' },
            { data: 'book', title: 'Book' },
            { data: 'page', title: 'Page' }
        ];

        var _dexcludedCols = [];

        $scope.ddtInstance = null;
        $scope.ddtColumns = controlSettingSvc.gridColDefs(_dcontrolSetting, _ddefaultColDef, _dexcludedCols);
        $scope.ddtOptions = {
            paginationType: 'numbers',
            displayLength: 25,  //pages are 25 rows
            lengthChange: false,    //hide pagination option from top left
            searching: false,
            paging: (!_printing), //hide some options when printing...
            info: (!_printing),
            ordering: (!_printing),
            order: [2, 'asc'], //sort by seqpos
            responsive: true,
            createdRow: createdRow
        };

        //$scope.CaseWarrants = [];
        $scope.WarrantNumber;

        //$scope.WarrantDockets = [];
        //$scope.controlSetting;

        $scope.tabPromiseLoading;
        $scope.dialogPromiseLoading;

        $scope.gridColDefs = [];
        $scope.docketsGridColDefs = [];

        $scope.getImage = function (row) {
            var docket = $scope.ddtInstance.DataTable.data()[row];
            //open the window right away to avoid browsers blocking the pop-up...
            var w = $window.open('', "_blank");

            caseSvc.getdocumentKey(_caseID, [docket.docketID], $scope.Searchable)
              .then(function (key) {
                  var url = "home/pdfframe?k=" + key;
                  //w.open(url, "_blank");
                  //...then set url of the opened window
                  w.location = url;
              });
        }


        $scope.controlsettingSaved = function (name) {
            //console.log('case warrants knows about it:' + name);
            //relaod control settings as the directvie requested
            $state.reload();
        }

        function createdRow(row, data, dataIndex) {
            // Recompiling so we can bind Angular directive to the DT
            $compile(angular.element(row).contents())($scope);
        }

        function renderWarrantType(data, type, warrant) {
            var cellHtml = '';
            if (data) {
                cellHtml = '<span>' + data + '</span>' +
                    '<span style= "float:right;">' +
                    '    <a href="" ng-click="toggleWarrantDockets(' + warrant.warrantID + ', \'' + warrant.warrantNumber + '\')">' +
                    '        <img src="images/docinfo.png"' +
                    '            alt="Warrant document and history"' +
                    '            title="Click to see warrant document and history"' +
                    '            style="width: 24px; height: 24px" />' +
                    '    </a>' +
                    '</span>';               
            }
            return cellHtml;
        }

        function renderDate(data) {
            if (data)
                return moment(data).format('MM/DD/YYYY');
            return '';
        }

        function renderImgIcons(data, type, docket, meta) {
            var iconClass = 'glyphicon glyphicon-paperclip';
            var tooltip = 'Document';
            var html = '';

            if (docket.vor) {
                tooltip = 'View On Request';
                iconClass = 'glyphicon glyphicon-lock';
            }

            //sealed and vorPending should display only an icon.
            if (docket.sealed) {
                tooltip = 'No Access';
                iconClass = 'glyphicon glyphicon-ban-circle';
                iconStyle = 'color:red';

                html = '<span class="' + iconClass + '" style="' + iconStyle + '" uib-tooltip="' + tooltip + '"></span>';
            }
            else if (docket.hasImages && !docket.sealed && docket.vorPending) {
                tooltip = 'View On Request Pending';
                iconClass = 'glyphicon glyphicon-align-center glyphicon-lock';
                iconStyle = 'color:gray';

                html = '<span class="' + iconClass + '" style="' + iconStyle + '" uib-tooltip="' + tooltip + '"></span>';
            }
            //<a ng-if="wd.hasImages" href="" ng-click="$parent.getImage(wd)" uib-tooltip="{{wd.vor ? 'View On Request': 'Document'}}"><span ng-class="(wd.vor) ? 'glyphicon glyphicon-lock' : 'glyphicon glyphicon-paperclip'" aria-hidden="true"></span></a>
            else if (docket.hasImages && !docket.sealed) {
                html = '<a href="" ng-click="getImage(' + meta.row + ')" uib-tooltip="' + tooltip + '">' +
                    '<span class="' + iconClass + '" aria-hidden="true"></span>' +
                    '</a>&nbsp;' +
                    '<input type="checkbox" ng-click="selectDocket(' + meta.row + ')">';
            }
            
            return html;
        }

        function init() {
            //$scope.tabPromiseLoading = caseSvc.caseWarrants(_caseID).
            //    then(function (d) {
            //        $scope.CaseWarrants = d;
            //    });
        }

        init();
        
        $scope.toggleWarrantDockets = function (warrantID, warrantNumber) {
             //$scope.WarrantDockets = [];
            $scope.dialogPromiseLoading = caseSvc.getWarrantDockets(_caseID, warrantID).
                then(function (dockets) {
                    //$scope.WarrantDockets = d;

                    if ($scope.ddtInstance) {
                        $scope.ddtInstance.DataTable.clear().draw();
                        $scope.ddtInstance.DataTable.rows.add(dockets).draw();
                    }
                });

            $scope.WarrantNumber = warrantNumber;

            $('#warrantDocketsPanel')
                .prop('class', 'modal fade modal-search') // revert to default
                .addClass($(this).data('direction'));

            $('#warrantDocketsPanel').modal('show');
           
        }
    }   
})();;

(function (ng) {
    'use strict';

    ng.module('sc').directive('scCaptcha', ['authSvc', captcha]);

    function captcha(authSvc) {  // This name is what AngularJS uses to match to the `<phone-list>` element.
        let _template =
            '<form id=\'captcha-form\' action="?" method="POST">' +
            '<button class="g-recaptcha" data-sitekey="{{sitekey}}" data-callback="validateCaptcha" data-error-callback="captchaError" style="visibility: collapse;">Submit</button>' +
            '<br />' +
            '</form>';

        let _controller = ['$window', function ($window) {
            $window.validateCaptcha = function (token) {
                alert('validating: ' + token);
            }

            $window.captchaError = function () {
                console.log('captchaError');
            }
        }];

        return {
            restrict: 'AE',
            scope: {
                sitekey: '@',
            },
            //controller: _controller,
            //template: _template,
            link: function ($scope) {

                if (!$scope.sitekey) return;

                grecaptcha.ready(function () {

                    grecaptcha.execute($scope.sitekey, { action: 'sc_homepage' })
                        .then(function (token) {
                            //console.log({ 'token': token });

                            //accesibility improvement
                            var textarea = $('#g-recaptcha-response-100000').attr('aria-hidden', true);
                            //var textarea = document.getElementsByName("g-recaptcha-response");
                            textarea.attr("aria-hidden", "true");
                            textarea.attr("aria-label", "do not use");
                            textarea.attr("aria-readonly", "true");

                            authSvc.validateCaptcha(token)
                                .then(function (valid) {
                                    if (valid) {
                                        console.info('valid-captcha');
                                    } else {
                                        console.warn('invalid-captcha');

                                        // In case of a failed validation you need to reload the captcha
                                        // because each response can be checked just once
                                        //vcRecaptchaService.reload(this.widgetId);
                                    }
                                });

                        });
                });
            }
        };
    }

})(angular);;

sc.ng.directive('controlEditor', ['controlSettingSvc', controlEditor]);

function controlEditor(controlSettingSvc) {

    var _controller = ['$scope', '$element', '$attrs',
        function ($scope, $element, $attrs) {

        $scope.canEditControlSettings = false;
        var _myGroupID = 0;

        $scope.$on('sessionStarted', function () {
            //restart the controlsetting to read canEditControlSettings
            init();
        }); 

        $scope.$on('handleLogOut', function () {
            $scope.canEditControlSettings = false;
        });

        function init() {

            controlSettingSvc.getMainNavSettings()
                .then(function (d) {
                    $scope.canEditControlSettings = d.controlSettingsAdmin;
                    //console.log({ 'settingsname': $scope.settingsname, 'canEditControlSettings': $scope.canEditControlSettings});

                    if ($scope.canEditControlSettings) {

                        controlSettingSvc.getMyGrouID()
                            .then(function (mygroupID) {
                                _myGroupID = mygroupID;
                            });
                    }
                });
        }

        $scope.showControlSettingsEditor = function () {
            if (!$scope.canEditControlSettings) return;

            //how to callback the parent controller
            //$scope.onSaved({ name: $scope.settingsname });

            //onSave is a callback parent controllers can subscribe to
            controlSettingSvc.editControlSettings($scope.settingsname, _myGroupID, $scope.onSaved);
        };

        init();
    }];

    const _template = '<button type="button" ng-show="canEditControlSettings" class="btn btn-default btn-sm" title="Control Editor" style="border:0;float:right; padding: 0 8px; margin-top:-1px;" ng-click="showControlSettingsEditor()" aria-label="control editor">' +
        '<span class="glyphicon glyphicon-cog" aria-hidden="true"></span>' +
        '</button>';

    return {
        restrict: 'AE',
        scope: {
            settingsname: '@', //name of the control setting
            settings: '@',
            onSaved: '&' //callback to parent controllers
        },
        controller: _controller,
        template: _template
    };
}

sc.ng.controllers.controller('controlSettingsCtrl', ['$scope', 'controlSettingSvc', controlSettingsCtrl]);

function controlSettingsCtrl($scope, controlSettingSvc) {
    $scope.columns = [];
    $scope.settingName = "";
    $scope.groups = [];
    $scope.selectedGroup;

    $scope.groupChange = function (id) {

        controlSettingSvc.getRawControlSettings($scope.settingName, $scope.selectedGroup.groupID)
            .then(function (controlSettings) {
                $scope.columns = controlSettings.columns;
            });
    };

    $scope.saveControlSetting = function () {
        var sortableElements = $('#draggablePanelList .movable');

        //reset displayOrder on all elements
        sortableElements.each(function (index, elem) {
            var $listItem = $(elem);
            var uniqueName = $listItem.attr('data-uniqueName');
            updateColumnIndex(uniqueName, index);
        });

        //send changes to service
        controlSettingSvc.saveControlSetting($scope.settingName, $scope.selectedGroup.groupID, $scope.columns);
    };

    //raised when showing the control settings editor
    controlSettingSvc.onEditControlSettings = function (name, columns, groupID) {
        //console.log('onEditControlSettings');

        $scope.settingName = name;
        $scope.columns = columns;

        //reset selected group if it was already set
        if ($scope.selectedGroup)
            $scope.selectedGroup.groupID = groupID;

        controlSettingSvc.getGroups()
            .then(function (groups) {
                $scope.groups = groups;

                angular.forEach(groups, function (group, k) {
                    if (group.groupID === groupID) {
                        $scope.selectedGroup = group;
                    }
                });

            });

        $('#controlSettingsModal').modal('show');

        var sortableList = $('#draggablePanelList');

        sortableList.sortable({
            // Only make the .panel-heading child elements support dragging.
            // Omit this to make then entire <li>...</li> draggable.
            handle: '.movable',
            //update: function (event, ui) {
            //    $('.movable', panelList).each(function (index, elem) {
            //        var $listItem = $(elem);
            //        //var uniqueName = $listItem.attr('data-uniqueName');
            //        //var newIndex = $listItem.index();
            //    });
            //}
        });
    };

    function updateColumnIndex(uniqueName, index) {
        angular.forEach($scope.columns, function (column) {
            if (column.uniqueName === uniqueName) {
                column.displayOrder = index;
                return;
            }
        });
    }
};

sc.ng.directive('datePicker', datePicker);

function datePicker() {
  return {
    restrict: 'A',
    replace: true,
    scope: {
      datePicker: '=',
      name: '@',
      click: '&',
      required: '='
    },
    template: '<div class="input-append">' +
      '<input type="text" ng-model="datePicker" name="{{name}}" ng-click="click()" required="required">' +
      '<span class="add-on">' +
      '<i class="icon-calendar"></i>' +
      '</span>' +
      '</div>',
    link: function($scope, $element, $attrs, $controller) {
      // handle widget launch etc
    }
  };
};;

sc.ng.directive('dtfilter', [dtfilter]);

function dtfilter() {
    var _filterInput = null;

    return {
        restrict: 'E',
        scope: {
            dtinstance: '=',
            state: '@'
        },   
        link: function (scope, element, attrs) {
            _filterInput = element.find("#filterInput");

            scope.$watch('searchText', function (value) {
                if (scope.dtinstance) {
                    //filter table
                    scope.dtinstance.DataTable.search(value).draw();
                }
            }, true);

            //Fix for IE X on input that clears the searchText without raising the $watch above
            _filterInput.bind('input propertychange', function () {
                if (this.value == "" && scope.searchText) {
                    scope.searchText = "";
                    scope.dtinstance.DataTable.search(scope.searchText).draw();
                }
            });

            scope.togglefilter = function () {               

                var sliderWidth = 220;
                if (_filterInput.css('visibility') != 'hidden')

                    _filterInput.animate({ left: '+=' + sliderWidth, width: '0' }, 500, function () {
                        _filterInput.css('visibility', 'hidden');
                    });
                else {
                    _filterInput.css('visibility', 'visible');
                    _filterInput.animate({ left: '-=' + sliderWidth, width: sliderWidth }, 500, function () {
                        _filterInput.css('visibility', 'visible');
                    });
                }

            };

            //if (scope.state === 'opened') {
            //    _filterInput.css('visibility', 'visible');
            //} else {
            //    scope.togglefilter();
            //}
        },
        template: '<div class="input-group pull-right" style="max-width:250px; padding-bottom:5px;"> ' +
                '<input type="text" id="filterInput" class="form-control" ng-model="searchText" placeholder="Filter..." aria-label="filter"> ' +
                '<span class="input-group-btn"> ' +
                '   <button class="btn btn-default" ng-click="togglefilter()" title="Filter" aria-label="toggle filter" type="button"><span class="glyphicon glyphicon-filter"></span></button> ' +
                '</span> ' +
            '</div>'
    };
};;
sc.ng.directive('fileModel', ['$parse', fileModel]);

function fileModel($parse) {
    return {
        restrict: 'A',
        link: function (scope, element, attrs) {
            var model = $parse(attrs.fileModel);
            var modelSetter = model.assign;

            element.bind('change', function () {
                scope.$apply(function () {
                    modelSetter(scope, element[0].querySelector('input[type="file"]').files[0]);
                });
            });
        }
    };
};

sc.ng.directive('mugshot', ['caseSvc', 'controlSettingSvc', mugshotImg]);

function mugshotImg(caseSvc, controlSettingSvc) {

    function loadMugshot(caseID, lname, fname, element) {
        if (!caseID || !lname || !fname)
            return;

        caseSvc.mugshot(caseID, lname, fname)
                            .then(function (imageData) {
                                if (imageData) {
                                    //update img src with real image
                                    var bloburl = (window.URL || window.webkitURL).createObjectURL(imageData);
                                    element.attr('src', bloburl);
                                    element.attr('alt', 'mugshot image');
                                }
                            });
    }

    return {
        restrict: 'AE',
        scope: {
            caseid: '@',
            lname: '@',
            fname: '@'
        },
        link: function (scope, element, attrs) {
            var templateImg = "Images/no-profile-man-medium.png";
            //set default silhouette image
            element.attr('src', templateImg);
            element.attr('alt', ''); //per wcag https://webaim.org/standards/wcag/checklist#sc1.1.1

            var canViewMugshots = false;

            if (!scope.caseid) {
                attrs.$observe("caseid", function (data) {
                    //This gets called when data changes.
                    scope.caseid = data;
                    loadMugshot(scope.caseid, scope.lname, scope.fname, element);
                });
            }

            if (!scope.lname) {
                attrs.$observe("lname", function (data) {
                    //This gets called when data changes.
                    scope.lname = data;
                    loadMugshot(scope.caseid, scope.lname, scope.fname, element);
                });
            }

            if (!scope.fname) {
                attrs.$observe("fname", function (data) {
                    //This gets called when data changes.
                    scope.fname = data;
                    loadMugshot(scope.caseid, scope.lname, scope.fname, element);
                });
            }

            controlSettingSvc.getMainNavSettings()
                .then(function (d) {
                    canViewMugshots = d.viewMugshots;
                    //request mugshot if I have access
                    //this is just for performance reasons as the api will not give me the mugshot if I dont have access
                    if (canViewMugshots) {
                        loadMugshot(scope.caseid, scope.lname, scope.fname, element);
                    }
                });
        },
        //template: '<img caseid="obj" />, '
    };
};;
(function () {
    'use strict';

    sc.ng.svcs.service('authSvc', ['$http', '$q', '$rootScope', 'controlSettingSvc', authSvc]);

    function authSvc($http, $q, $rootScope, controlSettingSvc) {
        var _baseURl = sc.baseURL;
        var _publicUser = '';
        var _winUser = '';
        var _sessionStarted = false;
        var svc = {};
        
        //Richard Marens 02/01/2019 SC-1176
        var _maxRecentCases = null;
        var _recentCases = [];

        let _captcha = {
            required: false,
            widgetId: 0,
            //key: '6LcUbBgUAAAAALqDS62AYUHVCwPuCqEZQqHckNKj', //Key comes from CaptchaPublicKey setting
            setWidgetId: function (widgetId) {
                //this.captchaEnabled = true;
                console.info('Created widget ID: %s', widgetId);

                //console.log({ 'g-recaptcha-response': $document.find('#g-recaptcha-response') });

                $('#g-recaptcha-response').attr('aria-hidden', true);
                $('#g-recaptcha-response').attr('aria-label', 'do not use');
                $('#g-recaptcha-response').attr('aria-readonly', true);

                this.widgetId = widgetId;
            },
            setResponse: function (response) {
                console.info('Response available');

                validateCaptcha(response)
                    .then(function (valid) {
                        if (valid) {
                            console.log('Success');
                        } else {
                            console.log('Failed validation');

                            // In case of a failed validation you need to reload the captcha
                            // because each response can be checked just once
                            vcRecaptchaService.reload(this.widgetId);
                        }
                    });
            },
            cbExpiration: function () {
                console.info('Captcha expired. Resetting response object');
                vcRecaptchaService.reload(this.widgetId);
            },
            enabled: false
        };

        var _getToken = function () {
            if (sessionStorage.getItem("accessToken")) {
                var token = JSON.parse(sessionStorage.getItem("accessToken"));
                if (token) {
                    return token;
                }
            }
            return null;
        };

        //Richard Marens 02/01/2019 SC-1176
        var _getUserName = function () {
            var t = _getToken();
            if (t) {
                return t.userName;
            }
            return '';
        };

        svc.isAuthenticated = function () {
            //to determine if a non-public user is authenticated with need at least a token and _publicUser loaded
            var t = _getToken();
            var now = new Date();

            if (t && t.accessToken //there is a token
                && now < t.expiresIn // token is not expired
                && (t.userName || _publicUser || _winUser) //there is a username
                && t.userName !== _publicUser) { //the user is not the public user
                return true;
            }
            return false;
        };

        svc.passwordExpired = function () {
            var t = _getToken();
            var now = new Date();
            var passwordExpired = false;

            if (t.userName.toLowerCase() === _publicUser.toLowerCase()) {
                return false; // public doesn't allow password change from the client
            }

            if (t && t.accessToken //there is a token
                && now < t.expiresIn // token is not expired
            ) {
                passwordExpired = true;
            }

            return true;
        };

        svc.getUserName = function () {
            //Richard Marens 02/01/2019 SC-1176
            //var t = _getToken();
            //if (t) {
            //    return t.userName;
            //}
            //return '';
            return _getUserName();
        };

        svc.saveToken = function (accessToken) {
            sessionStorage.setItem("accessToken", JSON.stringify(accessToken));
        };

        svc.login = function (cred) {
            var deferred = $q.defer();
            var now = new Date();

            if (cred.username.toLowerCase() === _publicUser.toLowerCase()) {
                deferred.reject({
                    data: {
                        error_description: 'Invalid Account'
                    }
                });
                return deferred.promise;
            }

            var data = "grant_type=password&username=" + encodeURIComponent(cred.username) + "&password=" + encodeURIComponent(cred.password);
            data += "&client_id=showcaseweb";

            $http.post(_baseURl + 'token', data, { headers: { 'Content-Type': 'application/x-www-form-urlencoded' } }).
                then(function (response) {
                    var token = null;

                    if (response.data) {
                        token = {
                            accessToken: response.data.access_token,
                            expiresIn: now.setSeconds(now.getSeconds() + response.data.expires_in),
                            userName: cred.username
                        };
                        svc.saveToken(token);

                        loadSettings();

                        $rootScope.$broadcast('sessionStarted', token);
                        deferred.resolve(response);
                    }
                    else {
                        deferred.reject(err);
                    }
                }, function (err, status) {
                    deferred.reject(err);
                });
            return deferred.promise;
        };

        svc.logout = function () {
            //logout from the server. This removes the cookie used by MVC.
            $http.post(_baseURl + 'account/logoff', { headers: { 'Content-Type': 'application/x-www-form-urlencoded' } });

            //logout from the client. This removes to token used by Web API.
            sessionStorage.removeItem('accessToken');
            $rootScope.$broadcast('handleLogOut');
            //this is called when the page is refresh
            //startSession();
        };

        svc.changePassword = function (credentialChange) {
            var deferred = $q.defer();

            $http.post(_baseURl + 'account/resetpassword', credentialChange).
                then(function (r) {
                    if (r.status === 202) { //Accepted
                        deferred.resolve('Change Password Succeeded');
                        return;
                    }

                    var msg = r.data.message || 'There was an error changing the password';

                    deferred.reject(msg);

                    //if (r.data) {
                    //    deferred.reject(r.data);
                    //    return;
                    //}

                    //deferred.reject("There was an error changing the password");
                }, function (err) {
                    console.log('Error: ', err);
                    deferred.reject(err);
                });

            return deferred.promise;
        };

        svc.getCaptcha = function () {
            return _captcha;
        };

        svc.startWinSession = function(winUser){
            _winUser = winUser;

            controlSettingSvc.clearControlSettings();

            console.info('starting windows session');
            return startSession();
        };

        svc.startPubSession = function (publicUser, captchaEnabled) {
            _publicUser = publicUser;
            _captcha.enabled = captchaEnabled;

            if (captchaEnabled) return; //public session will be started when captcha is answered

            controlSettingSvc.clearControlSettings();

            console.info('starting public session');
            return startSession();
        };

        svc.setPubUser = function (publicUser) {
            _publicUser = publicUser;
        };

        svc.sessionStarted = function(){
            return _sessionStarted;
        };

        //Richard Marens 02/01/2019 SC-1176
        svc.clearRecentCases = function () {
            _recentCases.length = 0;
            return _recentCases;
        };

        //Richard Marens 02/01/2019 SC-1176
        svc.addRecentCase = function (caseDetails, maxCases) {
            var userName = _getUserName();
            if (!userName)
                return;

            if (!maxCases)
                maxCases = _maxRecentCases;

            //locate case number in array
            if (_recentCases && _recentCases.length > 0) {
                for (var i = 0; i < _recentCases.length; i++) {
                    if (_recentCases[i].caseID === caseDetails.caseID) {
                        if (i === 0)
                            //if already most recent in array, abort
                            return;
                        else {
                            //else, remove
                            _recentCases.splice(i, 1);
                            break;
                        }
                    }
                }
            }

            //add to start of array
            var rc = { caseID: caseDetails.caseID, caseNumber: caseDetails.caseNumber, name: caseDetails.name, nameID: caseDetails.nameID };
            _recentCases.splice(0, 0, rc);

            //ensure recent case maximum is not exceeded
            if (_recentCases.length > maxCases)
                _recentCases.length = maxCases;

            //convert array to json
            var json = JSON.stringify({
                cases: _recentCases
            });

            //save json to local storage
            localStorage.setItem(userName, json);

            $rootScope.$broadcast('handleRecentCasesUpdate', _recentCases);
        };

        //Richard Marens 02/01/2019 SC-1176
        svc.loadRecentCases = function (maxCases) {
            var userName = _getUserName();
            if (!userName)
                return;

            if (!maxCases)
                maxCases = _maxRecentCases;

            //load json from local storage
            var json = localStorage.getItem(userName);

            //if exists, convert json to array
            if (json) {
                var obj = JSON.parse(json);
                _recentCases = obj.cases;
            }

            //ensure recent case maximum is not exceeded
            if (_recentCases.length > maxCases)
                _recentCases.length = maxCases;

            return _recentCases;
        };

        function loadSettings() {

            controlSettingSvc.getMainNavSettings()
                .then(function (d) {
                    _publicUser = d.publicUser;
                    _maxRecentCases = controlSettingSvc.getMaxRecentCases(); //Richard Marens 02/01/2019 SC-1176
                });           
        }

        function startSession() {
            var deferred = $q.defer();

            if (svc.isAuthenticated()) {
                console.log("startSession.isAuthenticated");
                //session already started or captcha is configured in which case the session will start when captcha is validated
                _sessionStarted = true;
                $rootScope.$broadcast('sessionStarted', _getToken());
                deferred.resolve();
            }
            else {
                _sessionStarted = false;
                var now = new Date();

                //make sure to always use _winUser 1st when available
                var data = "grant_type=password&username=" + encodeURIComponent(_winUser || _publicUser);
                data += "&client_id=showcaseweb";

                $http.post(_baseURl + 'token', data, { headers: { 'Content-Type': 'application/x-www-form-urlencoded' } }).
                    then(function (response) {
                        var token = null;

                        if (response.data) {
                            token = {
                                accessToken: response.data.access_token,
                                expiresIn: now.setSeconds(now.getSeconds() + response.data.expires_in),
                                userName: _winUser || _publicUser 
                            };

                            svc.saveToken(token);

                            _sessionStarted = true;

                            console.log("startSession.sessionStarted");

                            loadSettings();
               
                            $rootScope.$broadcast('sessionStarted', token);

                            //loadSettings();

                            deferred.resolve(response);
                        }
                        else {
                            deferred.reject(err);
                        }
                    }, function (err, status) {
                        deferred.reject(err);
                    });
            }
            return deferred.promise;
        }

        svc.validateCaptcha = function(responseToken) {
            var deferred = $q.defer();

            if (svc.isAuthenticated()) {
                //session already started or captcha is configured in which case the session will start when captcha is validated
                _sessionStarted = true;
                $rootScope.$broadcast('sessionStarted', _getToken());
                deferred.resolve();
                return deferred.promise;
            }

            console.info('validating...');

            var data = "grant_type=gcaptcha&token=" + responseToken + "&client_id=showcaseweb";
            //var data = { captchaResposne: responseToken};

            $http.post(_baseURl + 'token', data, { headers: { 'Content-Type': 'application/x-www-form-urlencoded' } }).
                then(function (r) {
                    var token = {
                        accessToken: r.data.access_token,
                        expiresIn: r.data.expires_in,
                        userName: _publicUser
                    };

                    svc.saveToken(token);

                    $rootScope.$broadcast('sessionStarted', _getToken());

                    deferred.resolve(true);
                }, function (err) {
                    console.log('Error: ', err);
                    deferred.reject(err);
                });

            return deferred.promise;
        };

        loadSettings();

        return svc;
    }
})();;
(function () {
    sc.ng.factory('authInterceptorService', ['$q', 
        function ($q) {

            var authInterceptorServiceFactory = {};

            var _request = function (config) {

                config.headers = config.headers || {};

                if (sessionStorage.getItem("accessToken")) {
                    var token = JSON.parse(sessionStorage.getItem("accessToken"));
                    if (token) {
                        config.headers.Authorization = 'Bearer ' + token.accessToken;
                    }
                }
                return config;
            };

            var _responseError = function (rejection) {

                console.log('status', rejection.status);
                
                if (rejection.status === 401) {
                    //a request was made with a bad accessToken
                    //console.log('unauthorizes');
                    sessionStorage.removeItem('accessToken');

                    //$window.location.href = sc.baseURL;
                }
                
                return $q.reject(rejection);
            };

            authInterceptorServiceFactory.request = _request;
            authInterceptorServiceFactory.responseError = _responseError;

            return authInterceptorServiceFactory;
        }]);
})();
;
(function () {
    'use strict';

    sc.ng.svcs.service('calSvc', ['$http', '$q', calSvc]);

    function calSvc($http, $q) {
        var _baseURl = sc.baseURL;
        var svc = {};
        var _searchResults;
        var _eventInfo
        
        svc.getSummary = function (searchArgs) {
            if (!searchArgs) {
                return $q.when(null);
            }

            var deferred = $q.defer();
            var url = 'sci/calendar/summary?';
            svc.clearResults();

            $http.get(_baseURl + url, { params: searchArgs }).
                then(function (response) {
                    var summaryResults = response.data;

                    deferred.resolve(summaryResults);
                }, function (err, status) {
                    console.log('error', err);
                    deferred.resolve([]);
                });
            return deferred.promise;
        };

        svc.getCourtTotals = function (data) {
            if (!data) {
                return $q.when(null);
            }

            var deferred = $q.defer();
            var url = 'sci/calendar/courttotals?';

            $http.get(_baseURl + url, { params: data }).
                then(function (response) {
                    var courtTotals = response.data;
                    deferred.resolve(courtTotals);
                }, function (err, status) {
                    console.log('error', err);
                    deferred.reject(err);
                });
            return deferred.promise;
        };

        svc.getSessionLastUpdated = function (data) {
            if (!data) {
                return $q.when(null);
            }

            var deferred = $q.defer();
            var url = 'sci/calendar/sessionLastUpdated?';

            $http.get(_baseURl + url, { params: data }).
                then(function (response) {
                    var lastUpdated = response.data;

                    deferred.resolve(lastUpdated);
                }, function (err, status) {
                    console.log('error', err);
                    deferred.reject(err);
                });
            return deferred.promise;
        }

        svc.search = function (searchArgs) {
            if (!_eventInfo && !searchArgs) {
                return $q.when(null);
            }

            if (searchArgs) {
                _eventInfo = searchArgs;
            }

            var deferred = $q.defer();
            var url = 'sci/calendar/details?';

            //svc.clearResults();

            $http.get(_baseURl + url, { params: _eventInfo }).
                then(function (response) {
                    _searchResults = response.data;
                    deferred.resolve(_searchResults);
                }, function (err, status) {
                    console.log('error', err);
                    deferred.resolve([]);
                });
            return deferred.promise;
        };

        svc.getEventInfo = function () {
            return _eventInfo;
        };

        svc.getSessionTimes = function (searchArgs) {
            if (!searchArgs) {
                return $q.when(null);
            }

            var deferred = $q.defer();
            var url = 'sci/calendar/sessiontimes?';

            $http.get(_baseURl + url, { params: searchArgs }).
                then(function (response) {
                    var times = response.data;

                    deferred.resolve(times);
                }, function (err, status) {
                    console.log('error', err);
                    deferred.reject(err);
                });
            return deferred.promise;
        };

        svc.clearResults = function () {
            _searchResults = null;
            _eventInfo = null;
        }

        return svc;
    };

})();;
(function () {
    'use strict';

    sc.ng.svcs.service('caseSvc', ['$http', '$q', caseSvc]);

    function caseSvc($http, $q) {
        var svc = {};

        var _searchResults = [];
        var _oneRowPerCase = true;

        svc.caseSearch = function (searchArgs) {
            //sci/case/search?LastName={LastName}&FirstName={FirstName}&MiddleName={MiddleName}&CaseNumber={CaseNumber}&CitationNumber={CitationNumber}&CaseType={CaseType}&Year={Year}&DOB={DOB}&DLNumber={DLNumber}&countyID={countyID}&SAONumber={SAONumber}&FromFileDate={FromFileDate}&ToFileDate={ToFileDate}&Judge={Judge}&Division={Division}&CaseStatus={CaseStatus}&BookingNumber={BookingNumber}&ArrestDate={ArrestDate}
            var deferred = $q.defer();
            var url = 'sci/case/search?';

            if (!searchArgs) {
                deferred.resolve(_searchResults);
                return deferred.promise;
            }

            svc.clearResults();

            _oneRowPerCase = searchArgs.OneRowPerCase;

            $http.get(sc.baseURL + url, { params: searchArgs }).
                then(function (r) {
                    if (!r || !r.data) {
                        console.log('No Data Returned');
                        deferred.resolve([]);
                    }
                    _searchResults = r.data;

                    deferred.resolve(_searchResults);

                }, function (err) {
                    console.log('Error: ' + err);
                    deferred.resolve([]);
                });

            return deferred.promise;
        };

        svc.mugshot = function (caseID, lname, fname) {
            var deferred = $q.defer();
            var url = 'sci/case/' + caseID + '/mugshot?lname=' + lname + '&fname=' + fname;

            $http.get(sc.baseURL + url,{responseType: 'arraybuffer'}).
                then(function (r) {
                    var imgBlob = null;
                    if (r.status == 200)
                        imgBlob  = new Blob([r.data], {type: "image/png"})

                    deferred.resolve(imgBlob);
                }, function (err) {
                    console.log('Error: ' + err.status, err);
                    deferred.resolve(null);
                });

            return deferred.promise;
        }
        
        svc.getCaseDetails = function (caseID, nameID) {
            var deferred = $q.defer();
            var caseDetails = readLoadedResult(caseID, nameID);

            if (caseDetails) {
                //result is already loaded
                deferred.resolve(caseDetails);
            }
            else {
                //need to reload results
                var url = 'sci/case/search?';
                $http.get(sc.baseURL + url, { params: { CaseID: caseID, OneRowPerCase: _oneRowPerCase } }).
                    then(function (r) {
                        if (!r || !r.data) {
                            console.log('Error: No Data Returned');
                            deferred.reject('No Data Returned');
                        }

                        //load new results. This can have multiple records
                        _searchResults = r.data;

                        var caseDetails = readLoadedResult(caseID, nameID);

                        deferred.resolve(caseDetails);

                    }, function (err) {
                        console.log('Error: ' + err);
                        deferred.reject(err);
                    });
            }
            return deferred.promise;
        };

        svc.readcaseKey = function (key) {
            var deferred = $q.defer();

            var url = 'sci/case/readcasekey' + '?caseKey=' + key;

            $http.get(sc.baseURL + url).
                then(function (r) {
                    if (!r || !r.data) {
                        console.log('Error: No Data Returned');
                        deferred.reject('No Data Returned');
                    }
                    deferred.resolve(r.data);

                }, function (err) {
                    console.log('Error: ' + err);
                    deferred.reject(err);
                });
            
            return deferred.promise;
        };

        svc.isCaseSecured = function (c) {
            return (c.isSealedCase || c.isNonPublicCase || c.isExpungedCase || c.isJuvenileCase || c.isAdoptionCase || c.isAbortionCase || c.isJimmyRyceCase);
        };

        svc.secureInfo = function (c) {
            var toolTipMsg = '';
            if (c.isSealedCase) {
                toolTipMsg += 'Sealed, ';
            }

            if (c.isNonPublicCase) {
                toolTipMsg += 'Not For Public Disclosure, ';
            }

            if (c.isExpungedCase) {
                toolTipMsg += 'Expunged, ';
            }

            if (c.isJuvenileCase) {
                toolTipMsg += 'Juvenile, ';
            }

            if (c.isAdoptionCase) {
                toolTipMsg += 'Adoption, ';
            }

            if (c.isAbortionCase) {
                toolTipMsg += 'Abortion, ';
            }

            if (c.isJimmyRyceCase) {
                toolTipMsg += 'Jimmy Ryce, ';
            }

            toolTipMsg = 'Case Security: [ ' + toolTipMsg.substring(0, toolTipMsg.length - 2) + ' ]';

            return toolTipMsg;
        };

        function readLoadedResult(caseID, nameID) {
            if (_searchResults && _searchResults.length > 0) {
                //result is already loaded
                for (var i = 0; i < _searchResults.length; i++) {
                    if (_searchResults[i].caseID === caseID && _searchResults[i].nameID === nameID) {
                        return _searchResults[i];
                    }
                }
            }
            return null;
        }

        svc.validateCaseNumber = function (caseNumber) {
            var deferred = $q.defer();
            var url = 'sci/case/validate/' + caseNumber;
            $http.get(sc.baseURL + url).
                then(function (r) {
                    deferred.resolve(r.data);
                }, function (err) {
                    console.log('Error: ' + err);
                    deferred.reject(err);
                });
            return deferred.promise;
        };

        svc.getSearchResults = function () {
            return _searchResults || [];
        };

        svc.clearResults = function () {
            _searchResults = [];
        };

        svc.caseDockets = function (caseID) {
            var deferred = $q.defer();
            var url = 'sci/case/' + caseID + '/dockets';
            $http.get(sc.baseURL + url).
                then(function (r) {
                    if (!r || !r.data) {
                        console.log('Error: No Data Returned');
                        deferred.reject('No Data Returned');
                    }
                    deferred.resolve(r.data);
                }, function (err) {
                    console.log('Error: ' + err);
                    deferred.reject(err);
                });
            return deferred.promise;
        };

        svc.getdocumentKey = function (caseID, docketIDs, searchable) {
            var deferred = $q.defer();
            var url = 'sci/docket/' + caseID + '/docketsKey/' + (searchable === true);
            var data = docketIDs;

            $http.post(sc.baseURL + url, data).
                 then(function (r) {
                     if (!r || !r.data) {
                         console.log('Error: No Data Returned');
                         deferred.reject('No Data Returned');
                     }
                     deferred.resolve(r.data);
                 }, function (err) {
                     console.log('Error: ' + err);
                     deferred.reject(err);
                 });
            return deferred.promise;
        };

        svc.getcaseKey = function (caseID, nameID) {
            var deferred = $q.defer();

            var url = 'sci/case/createcaseKey/' + caseID + '?nameID=' + nameID;

            $http.get(sc.baseURL + url).
                then(function (r) {
                    if (!r || !r.data) {
                        console.log('Error: No Data Returned');
                        deferred.reject('No Data Returned');
                    }
                    deferred.resolve(r.data);
                }, function (err) {
                    console.log('Error: ' + err);
                    deferred.reject(err);
                });
            return deferred.promise;
        };

        svc.caseParties = function (caseID) {
            var deferred = $q.defer();
            var url = 'sci/case/' + caseID + '/parties';
            $http.get(sc.baseURL + url).
                then(function (r) {
                    if (!r || !r.data) {
                        console.log('Error: No Data Returned');
                        deferred.reject('No Data Returned');
                    }
                    deferred.resolve(r.data);
                }, function (err) {
                    console.log('Error: ' + err);
                    deferred.reject(err);
                });
            return deferred.promise;
        };

        svc.caseMainParties = function (caseID) {
            var deferred = $q.defer();
            var url = 'sci/case/' + caseID + '/mainparties';
            $http.get(sc.baseURL + url).
                then(function (r) {
                    if (!r || !r.data) {
                        console.log('Error: No Data Returned');
                        deferred.reject('No Data Returned');
                    }
                    deferred.resolve(r.data);
                }, function (err) {
                    console.log('Error: ' + err);
                    deferred.reject(err);
                });
            return deferred.promise;
        };

        svc.getPartyAttorneys = function (partyID) {
            var deferred = $q.defer();
            var url = 'sci/case/party/' + partyID + '/partyattorneys';
            $http.get(sc.baseURL + url).
                then(function (r) {
                    if (!r || !r.data) {
                        console.log('Error: No Data Returned');
                        deferred.reject('No Data Returned');
                    }
                    deferred.resolve(r);
                }, function (err) {
                    console.log('Error: ' + err);
                    deferred.reject(err);
                });
            return deferred.promise;
        };

        svc.caseCourtEvents = function (caseID) {
            var deferred = $q.defer();
            var url = 'sci/case/' + caseID + '/courtevents';
            $http.get(sc.baseURL + url).
                then(function (r) {
                    if (!r || !r.data) {
                        console.log('Error: No Data Returned');
                        deferred.reject('No Data Returned');
                    }
                    deferred.resolve(r.data);
                }, function (err) {
                    console.log('Error: ' + err);
                    deferred.reject(err);
                });
            return deferred.promise;
        };

        svc.caseCharges = function (caseID) {
            var deferred = $q.defer();
            var url = 'sci/case/' + caseID + '/charges';
            $http.get(sc.baseURL + url).
                then(function (r) {
                    if (!r || !r.data) {
                        console.log('Error: No Data Returned');
                        deferred.reject('No Data Returned');
                    }
                    deferred.resolve(r.data);
                }, function (err) {
                    console.log('Error: ' + err);
                    deferred.reject(err);
                });
            return deferred.promise;
        };

        svc.linkedCases = function (caseID) {
            var deferred = $q.defer();
            var url = 'sci/case/' + caseID + '/linkedcases';
            $http.get(sc.baseURL + url).
                then(function (r) {
                    if (!r || !r.data) {
                        console.log('Error: No Data Returned');
                        deferred.reject('No Data Returned');
                    }
                    deferred.resolve(r.data);
                }, function (err) {
                    console.log('Error: ' + err);
                    deferred.reject(err);
                });
            return deferred.promise;
        };

        svc.caseSentences = function (caseID) {
            var deferred = $q.defer();
            var url = 'sci/case/' + caseID + '/sentences';
            $http.get(sc.baseURL + url).
                then(function (r) {
                    if (!r || !r.data) {
                        console.log('Error: No Data Returned');
                        deferred.reject('No Data Returned');
                    }
                    deferred.resolve(r.data);
                }, function (err) {
                    console.log('Error: ' + err);
                    deferred.reject(err);
                });
            return deferred.promise;
        };

        svc.caseWarrants = function (caseID) {
            var deferred = $q.defer();
            var url = 'sci/case/' + caseID + '/warrants';
            $http.get(sc.baseURL + url).
                then(function (r) {
                    if (!r || !r.data) {
                        console.log('Error: No Data Returned');
                        deferred.reject('No Data Returned');
                    }
                    deferred.resolve(r.data);
                }, function (err) {
                    console.log('Error: ' + err);
                    deferred.reject(err);
                });
            return deferred.promise;
        };

        svc.getWarrantDockets = function (caseID, warrantID) {
            var deferred = $q.defer();
            var url = 'sci/docket/' + caseID + '/dockets/tblWarrant/' + warrantID;
            $http.get(sc.baseURL + url).
                 then(function (r) {
                     if (!r || !r.data) {
                         console.log('Error: No Data Returned');
                         deferred.reject('No Data Returned');
                     }
                     deferred.resolve(r.data);
                 }, function (err) {
                     console.log('Error: ' + err);
                     deferred.reject(err);
                 });
            return deferred.promise;
        }

        svc.caseArrests = function (caseID) {
            var deferred = $q.defer();
            var url = 'sci/case/' + caseID + '/arrests';
            $http.get(sc.baseURL + url).
                then(function (r) {
                    if (!r || !r.data) {
                        console.log('Error: No Data Returned');
                        deferred.reject('No Data Returned');
                    }
                    deferred.resolve(r.data);
                }, function (err) {
                    console.log('Error: ' + err);
                    deferred.reject(err);
                });
            return deferred.promise;
        };

        svc.caseBonds = function (caseID) {
            var deferred = $q.defer();
            var url = 'sci/case/' + caseID + '/bonds';
            $http.get(sc.baseURL + url).
                then(function (r) {
                    if (!r || !r.data) {
                        console.log('Error: No Data Returned');
                        deferred.reject('No Data Returned');
                    }
                    deferred.resolve(r.data);
                }, function (err) {
                    console.log('Error: ' + err);
                    deferred.reject(err);
                });
            return deferred.promise;
        };

        svc.caseFees = function (caseID) {
            var deferred = $q.defer();
            var url = 'sci/case/' + caseID + '/fees';
            $http.get(sc.baseURL + url).
                then(function (r) {
                    if (!r || !r.data) {
                        console.log('Error: No Data Returned');
                        deferred.reject('No Data Returned');
                    }
                    deferred.resolve(r.data);
                }, function (err) {
                    console.log('Error: ' + err);
                    deferred.reject(err);
                });
            return deferred.promise;
        };

        svc.casePaymentPlans = function (caseID) {
            var deferred = $q.defer();
            var url = 'sci/case/' + caseID + '/paymentplans';
            $http.get(sc.baseURL + url).
                then(function (r) {
                    if (!r || !r.data) {
                        console.log('Error: No Data Returned');
                        deferred.reject('No Data Returned');
                    }
                    deferred.resolve(r.data);
                }, function (err) {
                    console.log('Error: ' + err);
                    deferred.reject(err);
                });
            return deferred.promise;
        };

        svc.getDocketImage = function (caseID, docketKey, searchable) {
            var deferred = $q.defer();

            var url = 'sci/docket/document';

            var data = {
                CaseID: caseID,
                Key: docketKey,
                Searchable: searchable
            };

            var config = { responseType: "arraybuffer" };

            $http.post(sc.baseURL + url, data, config).
                then(function (r, status) {
                    if (!r || !r.data) {
                        console.log('Error: No Data Returned', url);
                        deferred.reject('No Data Returned from ' + url);
                        return;
                    }
                    deferred.resolve(r);
                }, function (err) {
                    if (err.status == 403) {
                        deferred.resolve('VOR');
                        return;
                    }
                    console.log('Error: ' + err);
                    deferred.reject(err);
                });
            return deferred.promise;
        };

        svc.citationSearch = function (searchArgs) {
            var deferred = $q.defer();

            var url = 'sci/case/citationsearch?';

            $http.get(sc.baseURL + url, { params: searchArgs }).
                then(function (r) {
                    //if (!r || !r.data) {
                    //    console.log('Error: No Data Returned');
                    //    deferred.reject('No Data Returned');
                    //}
                    deferred.resolve(r.data);
                }, function (err) {
                    console.log('Error: ' + err);
                    deferred.reject(err);
                });
            return deferred.promise;
        }

        svc.setCourtDate = function (caseID) {
            var deferred = $q.defer();

            var url = 'sci/case/setcourtdate/' + caseID;
            $http.get(sc.baseURL + url).
                then(function (r) {
                    if (!r || !r.data) {
                        console.log('Error: No Data Returned');
                        deferred.reject('No Data Returned');
                    }
                    deferred.resolve(r.data);
                }, function (err) {
                    console.log('Error: ' + err);
                    deferred.reject(err);
                    });

            return deferred.promise;
        };

        svc.submitSchoolCertificate = function (citationInfo, file) {
            var deferred = $q.defer();

            var payload = new FormData();
            payload.append('model', angular.toJson(citationInfo));
            payload.append('file', file);

            $http({
                url: sc.baseURL + 'sci/case/updatecitationschool',
                method: "POST",
                headers: { 'Content-Type': undefined }, //this allows the request to go as multipart
                data: payload
            }).then(function (response) {
                    deferred.resolve();
                },
                function (err) {
                    var e = err;
                    deferred.reject(err);
                });

            return deferred.promise;
        };

        svc.getMyCases = function () {
            var deferred = $q.defer();
            var url = 'sci/case/mine';
            $http.get(sc.baseURL + url).
                then(function (r) {
                    var cases = r.data;
                    deferred.resolve(cases);
                }, function (err) {
                    console.log('Error: ' + err);
                    deferred.reject(err);
                });
            return deferred.promise;
        };

        svc.submitVORRequest = function (caseID, emails, selectedDockets) {
            var deferred = $q.defer();
            var url = 'sci/docket/vor';

            var data = {
                caseID: caseID,
                emails: emails,
                //token: common.getAccessToken().accessToken,
                key: ''
            };

            //1st get the docket key
            this.getdocumentKey(caseID, selectedDockets, false).
                then(function (docketKey) {
                    data.key = docketKey;

                    //2nd now send the vor request
                    return $http.post(sc.baseURL + url, data).
                        then(function (r) {
                            deferred.resolve();
                        }, function (err) {
                            console.log('Error: ' + err);
                            deferred.reject(err);
                        });
                });

            return deferred.promise;
        };

        return svc;
    }
})();;
(function () {
    'use strict';
    sc.ng.svcs.service('controlSettingSvc', ['$http', '$q', controlSettingSvc]);

    function controlSettingSvc($http, $q) {
        //var _baseURl = sc.baseURL;
        var _myGroupID = 0;
        var svc = {};

        //contains all controlsettings loaded
        var _definitions = [];
        var _mainNavData = null;

        //Richard Marens 02/01/2019 SC-1176
        var _maxRecentCases = 10;

        //Richard Marens 02/01/2019 SC-1176
        svc.getMaxRecentCases = function () {
            return _maxRecentCases;
        };

        svc.getControlSettings = function (name) {

            return svc.getRawControlSettings(name).
                then(function (controlSettings) {
                    var controlSettingObj = buildControlSettingObject(controlSettings);
                    return controlSettingObj;
                });

            //var deferred = $q.defer();
            //var url = 'sci/controlsetting/get/' + name;

            //$http.get(sc.baseURL + url).
            //    then(function (r) {
            //        var controlSettingObj = buildControlSettingObject(r.data);
            //        deferred.resolve(controlSettingObj);
            //    }, function (err) {
            //        console.log('Error: ' + err);
            //        deferred.reject(err);
            //    });

            //return deferred.promise;
        };

        svc.getControlSettingsArray = function (name) {
            return this.getControlSettings(name)
                .then(function (d) {
                    var arr = [];
                    if (d) {
                        for (var setting in d) {
                            if (d[setting].includeInDisplay && d[setting].isConfigurable)
                                arr.push(d[setting]);
                        }
                    }
                    return arr;
                });
        };

        svc.getMainNavSettings = function () {
            var deferred = $q.defer();
            var url = 'sci/controlsetting/mainnav';

            //console.log({ "mainNavData": _mainNavData });

            if (_mainNavData) {
                deferred.resolve(_mainNavData);
                return deferred.promise;
            }
            
            //appending the userName helps cache per user
            if (sessionStorage) {
                var at = sessionStorage.getItem("accessToken");
                if (at) {
                    var token = JSON.parse(at);
                    url += '?ck=' + token.userName;
                }
                //else {
                //    console.log('no access token yet...');
                //}
            }

            $http.get(sc.baseURL + url).
                then(function (r) {
                    _mainNavData = r.data;
                    deferred.resolve(_mainNavData);
                }, function (err) {
                        console.error('Error: ' + err);
                    deferred.reject(err);
                });

            return deferred.promise;
        };

        svc.gridColDefs = function (name, defaultColDef, excludedCols) {
            var deferred = $q.defer();

            var exisitngDef = _definitions[name];

            if (exisitngDef) {
                deferred.resolve(exisitngDef);
                return deferred.promise;
            }
            
            var url = 'sci/controlsetting/gridcoldef/' + name;
            $http.get(sc.baseURL + url).
                then(function (r) {
                    var newdef = r.data;

                    if (excludedCols) {
                        newdef = removeExcluded(excludedCols, newdef);
                    }

                    if (defaultColDef) {
                        newdef = mergeColDefs(defaultColDef, newdef);
                    }

                    _definitions[name] = newdef;
                    deferred.resolve(newdef);
                }, function (err) {
                    console.log('Error gridColDefs', err);

                    if (defaultColDef) {
                        deferred.resolve(defaultColDef);
                    }
                    deferred.resolve([]);
                });
            

            return deferred.promise;
        };

        svc.getRawControlSettings = function (name, groupID) {
            var deferred = $q.defer();

            //var exisitngDef = _definitions[name];

            //if (exisitngDef) {
            //    deferred.resolve(exisitngDef);
            //    return deferred.promise;
            //}

            var url = 'sci/controlsetting/get/' + name;

            if (groupID) {
                url += '/' + groupID;
            }

            $http.get(sc.baseURL + url).
                then(function (r) {
                    //_definitions[name] = r.data;
                    deferred.resolve(r.data);
                }, function (err) {
                    console.log('Error: ' + err);
                    deferred.reject(err);
                });

            return deferred.promise;
        };

        //used by controlSettingsCtrl in directive to show the panel
        svc.onEditControlSettings;

        var _onSaveCallback;

        svc.editControlSettings = function (controlSettingsName, groupID, onSaveCallback) {
            
            this.getRawControlSettings(controlSettingsName)
                .then(function (controlSettings) {

                    _onSaveCallback = onSaveCallback;

                    //console.log({ "getRawControlSettings": svc.onEditControlSettings });

                    if (typeof svc.onEditControlSettings === 'function')
                        svc.onEditControlSettings(controlSettingsName, controlSettings.columns, groupID); 
                });            
        };

        svc.getGroups = function () {
            var deferred = $q.defer();
            var url = 'sci/controlsetting/groups';

            $http.get(sc.baseURL + url).
                then(function (r) {
                    deferred.resolve(r.data);                    
                }, function (err) {
                    console.log('Error: ' + err);
                    deferred.reject(err);
                });

            return deferred.promise;
        };

        svc.getMyGrouID = function () {

            var deferred = $q.defer();
            var url = 'sci/controlsetting/mygroupid';

            if (_myGroupID > 0)
                deferred.resolve(_myGroupID);
            else
                $http.get(sc.baseURL + url).
                    then(function (r) {
                        _myGroupID = r.data;
                        deferred.resolve(_myGroupID);
                    }, function (err) {
                            console.error('Error: ' + err);
                        deferred.reject(err);
                    });

            return deferred.promise;
        };

        svc.saveControlSetting = function (settingName, groupID, columns) {
            var deferred = $q.defer();
            var data = { columns: columns };
            var url = 'sci/controlsetting/post/' + settingName + '/' + groupID;

            $http.post(sc.baseURL + url, data).
                then(function (r) {

                    //clear before loading
                    _definitions[settingName] = null;

                    if (_onSaveCallback) {
                        _onSaveCallback({ name: settingName });
                        _onSaveCallback = null;
                    }

                    deferred.resolve(true);
                }, function (err) {
                    console.error('Error: ' + err);
                    deferred.reject(err);
                });

            return deferred.promise;
        };

        svc.clearControlSettings = function () {
            _mainNavData = null;
            _definitions = [];
            _myGroupID = 0;
        };

        svc.getEpayURL = function (caseID) {
            return this.getMainNavSettings()
                .then(function (settings) {
                    var url = null;

                    if (settings && settings.epayBaseURL) {
                        url = settings.epayBaseURL.replace(/\/$/, "/#");
                        url = url + '/casedetails/' + caseID; //this may need to include party information in the future
                    }
                    return url;
                });
        };

        ///Removes columns from a column control setting
        function removeExcluded(excludedCols, colDef) {
            if (excludedCols && excludedCols.length > 0) {
                for (var i = 0; i < excludedCols.length; i++) {

                    for (var j = 0; j < colDef.length; j++) {
                        if (colDef[j].data === excludedCols[i]) {
                            colDef.splice(j, 1);
                            break;
                        }
                    }
                }
            }
            return colDef;
        }

        function buildControlSettingObject(cs) {
            var _controlSetting = [];
            if (cs && cs.columns) {
                for (var i = 0; i < cs.columns.length; i++) {
                    _controlSetting[cs.columns[i].uniqueName] = {
                        displayName: cs.columns[i].displayName,
                        includeInDisplay: cs.columns[i].includeInDisplay,
                        displayOrder: cs.columns[i].displayOrder,
                        isConfigurable: cs.columns[i].isConfigurable,
                        id: cs.columns[i].uniqueName
                    };
                }
            }
            return sortByKey(_controlSetting, 'displayOrder');
        }

        function buildGirdColDefs(controlSetting) {
            var gridColDef = [];

            for (var c in controlSetting) {
                if (controlSetting[c].isConfigurable) {
                    gridColDef.push({
                        name: c,
                        visible: false,
                        title: controlSetting[c].displayName,
                        orderable: true,
                        targets: controlSetting[c].displayOrder
                    });
                }
            }
            return gridColDef;
        }

        //Merges the column definition read from the controlsetting with a default one provided by the view
        function mergeColDefs(defaultDef, controlDef) {
            var colsDef = [];

            if (defaultDef && controlDef) {
                
                //add default column definitions missing in control setting definition
                for (let i = 0; i < defaultDef.length; i++) {
                    var defaultDefFound = false;
                    for (let j = 0; j < controlDef.length; j++){
                        if (defaultDef[i].data && defaultDef[i].data.toLowerCase() === controlDef[j].data.toLowerCase()) {
                            defaultDefFound = true; //this will be added in the next loop as a merged definition
                            break;
                        }
                    }
                    if (!defaultDefFound) {
                        colsDef.push(defaultDef[i]);
                    }
                }
                //UNION

                //merge existing default column definition with control setting definition
                for (let i = 0; i < controlDef.length; i++) {
                    var mergedDefinition = controlDef[i];
                    
                    for (let j = 0; j < defaultDef.length; j++) {
                        if (defaultDef[j].data && defaultDef[j].data.toLowerCase() === controlDef[i].data.toLowerCase()) {
                            mergedDefinition = $.extend({}, defaultDef[j], controlDef[i]);
                            break;
                        }
                    }

                    colsDef.push(mergedDefinition);
                }              
            }
            return colsDef;
        }

        function sortByKey(array, key) {
            return array.sort(function (a, b) {
                var x = a[key];
                var y = b[key];
                return ((x < y) ? -1 : ((x > y) ? 1 : 0));
            });
        }

        return svc;
    }
})();;
(function () {
    'use strict';

    sc.ng.svcs.service('listsSvc', ['$http', '$q', listsSvc]);

    function listsSvc($http, $q) {
        var svc = {};

        var _courtTypes;
        var _caseTypes;
        var _judges;
        var _caseStatuses;
        var _partyTypes;
        var _divisions;
        var _courtLocations;
        var _courtEventTypes;
        
        svc.getCourtTypes = function () {
            if (_courtTypes) {
                var deferred = $q.defer();
                deferred.resolve(_courtTypes);
                return deferred.promise;
            }

            return getList('courttypes').
                then(function (r) {
                    _courtTypes = r.data;
                    return _courtTypes;
                });
        };

        svc.getCourtType = function (id) {
            if (!_courtTypes || !id)
                return null;

            for (var i = 0; i < _courtTypes.length; i++) {
                if (_courtTypes[i].CourtTypeID === id) {
                    return _courtTypes[i].CourtTypeName;
                }
            }
            return null;
        };

        svc.getCaseTypes = function () {
            if (_caseTypes) {
                var deferred = $q.defer();
                deferred.resolve(_caseTypes);
                return deferred.promise;
            }

            return getList('casetypes').
                then(function (r) {
                    _caseTypes = r.data;
                    return _caseTypes;
                });
        };

        svc.getCaseType = function (id) {
            if (!_caseTypes || !id)
                return;

            for (var i = 0; i < _caseTypes.length; i++) {
                if (_caseTypes[i].caseTypeID === id) {
                    return _caseTypes[i].caseTypeDescription;
                }
            }
            return null;
        };

        svc.getDivisions = function () {
            if (_divisions) {
                var deferred = $q.defer();
                deferred.resolve(_divisions);
                return deferred.promise;
            }
            return getList('divisions').
                then(function (r) {
                    _divisions = r.data;
                    return _divisions;
                });
        };

        svc.getDivision = function (id) {
            if (!_divisions || !id)
                return null;

            for (var i = 0; i < _divisions.length; i++) {
                if (_divisions[i].divisionID === id) {
                    return _divisions[i].divisionName;
                }
            }
            return null;
        };

        svc.getJudges = function () {
            if (_judges) {
                var deferred = $q.defer();
                deferred.resolve(_judges);
                return deferred.promise;
            }
            return getList('judges').
                then(function (r) {
                    _judges = r.data;
                    return _judges;
                });
        };

        svc.getJudge = function (id) {
            if (!_judges || !id)
                return null;

            for (var i = 0; i < _judges.length; i++) {
                if (_judges[i].JudgeID === id) {
                    return _judges[i].JudgeName;
                }
            }
            return null;
        };

        svc.getCaseStatuses = function () {
            if (_caseStatuses) {
                var deferred = $q.defer();
                deferred.resolve(_caseStatuses);
                return deferred.promise;
            }
            return getList('casestatuses').
                then(function (r) {
                    _caseStatuses = r.data;
                    return _caseStatuses;
                });
        };

        svc.getPartyTypes = function () {
            if (_partyTypes) {
                var deferred = $q.defer();
                deferred.resolve(_partyTypes);
                return deferred.promise;
            }
            return getList('partytypes').
                then(function (r) {
                    _partyTypes = r.data;
                    return _partyTypes;
                });
        };

        svc.getPartyType = function (id) {
            if (!_partyTypes || !id)
                return null;

            for (var i = 0; i < _partyTypes.length; i++) {
                if (_partyTypes[i].partyTypeID === id) {
                    return _partyTypes[i].partyTypeDescription;
                }
            }
            return null;
        };

        svc.getCourtRooms = function () {
            if (_courtLocations) {
                var deferred = $q.defer();
                deferred.resolve(_courtLocations);
                return deferred.promise;
            }
            return getList('courtlocations').
                then(function (r) {
                    _courtLocations = r.data;
                    return _courtLocations;
                });
        };

        svc.getCourtEventTypes = function () {
            if (_courtEventTypes) {
                var deferred = $q.defer();
                deferred.resolve(_courtEventTypes);
                return deferred.promise;
            }
            return getList('courteventtypes').
                then(function (r) {
                    _courtEventTypes = r.data;
                    return _courtEventTypes;
                });
        };

        function getList(entityName) {
            var deferred = $q.defer();
            var url = 'sci/' + entityName + '/list';
            $http.get(sc.baseURL + url).
               then(function (r) {
                   if (!r || !r.data) {
                       console.log('Error: No Data Returned', url);
                       deferred.reject('No Data Returned from ' + url);
                   }
                   deferred.resolve(r);
               }, function (err) {
                   console.log('Error: ' + err);
                   deferred.reject(err);
               });
            return deferred.promise;
        }
        return svc;
    }
})();;
/*!
 * bootstrap-fileinput v4.4.6
 * http://plugins.krajee.com/file-input
 *
 * Author: Kartik Visweswaran
 * Copyright: 2014 - 2017, Kartik Visweswaran, Krajee.com
 *
 * Licensed under the BSD 3-Clause
 * https://github.com/kartik-v/bootstrap-fileinput/blob/master/LICENSE.md
 */!function (e) { "use strict"; "function" == typeof define && define.amd ? define(["jquery"], e) : "object" == typeof module && module.exports ? module.exports = e(require("jquery")) : e(window.jQuery) }(function (e) {
    "use strict"; e.fn.fileinputLocales = {}, e.fn.fileinputThemes = {}, String.prototype.setTokens = function (e) { var t, i, a = this.toString(); for (t in e) e.hasOwnProperty(t) && (i = new RegExp("{" + t + "}", "g"), a = a.replace(i, e[t])); return a }; var t, i; t = { FRAMES: ".kv-preview-thumb", SORT_CSS: "file-sortable", OBJECT_PARAMS: '<param name="controller" value="true" />\n<param name="allowFullScreen" value="true" />\n<param name="allowScriptAccess" value="always" />\n<param name="autoPlay" value="false" />\n<param name="autoStart" value="false" />\n<param name="quality" value="high" />\n', DEFAULT_PREVIEW: '<div class="file-preview-other">\n<span class="{previewFileIconClass}">{previewFileIcon}</span>\n</div>', MODAL_ID: "kvFileinputModal", MODAL_EVENTS: ["show", "shown", "hide", "hidden", "loaded"], objUrl: window.URL || window.webkitURL, compare: function (e, t, i) { return void 0 !== e && (i ? e === t : e.match(t)) }, isIE: function (e) { if ("Microsoft Internet Explorer" !== navigator.appName) return !1; if (10 === e) return new RegExp("msie\\s" + e, "i").test(navigator.userAgent); var t, i = document.createElement("div"); return i.innerHTML = "<!--[if IE " + e + "]> <i></i> <![endif]-->", t = i.getElementsByTagName("i").length, document.body.appendChild(i), i.parentNode.removeChild(i), t }, initModal: function (t) { var i = e("body"); i.length && t.appendTo(i) }, isEmpty: function (t, i) { return void 0 === t || null === t || 0 === t.length || i && "" === e.trim(t) }, isArray: function (e) { return Array.isArray(e) || "[object Array]" === Object.prototype.toString.call(e) }, ifSet: function (e, t, i) { return i = i || "", t && "object" == typeof t && e in t ? t[e] : i }, cleanArray: function (e) { return e instanceof Array || (e = []), e.filter(function (e) { return void 0 !== e && null !== e }) }, spliceArray: function (e, t) { var i, a = 0, n = []; if (!(e instanceof Array)) return []; for (i = 0; i < e.length; i++)i !== t && (n[a] = e[i], a++); return n }, getNum: function (e, t) { return t = t || 0, "number" == typeof e ? e : ("string" == typeof e && (e = parseFloat(e)), isNaN(e) ? t : e) }, hasFileAPISupport: function () { return !(!window.File || !window.FileReader) }, hasDragDropSupport: function () { var e = document.createElement("div"); return !t.isIE(9) && (void 0 !== e.draggable || void 0 !== e.ondragstart && void 0 !== e.ondrop) }, hasFileUploadSupport: function () { return t.hasFileAPISupport() && window.FormData }, hasBlobSupport: function () { try { return !!window.Blob && Boolean(new Blob) } catch (e) { return !1 } }, hasArrayBufferViewSupport: function () { try { return 100 === new Blob([new Uint8Array(100)]).size } catch (e) { return !1 } }, dataURI2Blob: function (e) { var i, a, n, r, o, l, s = window.BlobBuilder || window.WebKitBlobBuilder || window.MozBlobBuilder || window.MSBlobBuilder, d = t.hasBlobSupport(), c = (d || s) && window.atob && window.ArrayBuffer && window.Uint8Array; if (!c) return null; for (i = e.split(",")[0].indexOf("base64") >= 0 ? atob(e.split(",")[1]) : decodeURIComponent(e.split(",")[1]), a = new ArrayBuffer(i.length), n = new Uint8Array(a), r = 0; r < i.length; r += 1)n[r] = i.charCodeAt(r); return o = e.split(",")[0].split(":")[1].split(";")[0], d ? new Blob([t.hasArrayBufferViewSupport() ? n : a], { type: o }) : (l = new s, l.append(a), l.getBlob(o)) }, arrayBuffer2String: function (e) { if (window.TextDecoder) return new TextDecoder("utf-8").decode(e); var t, i, a, n, r = Array.prototype.slice.apply(new Uint8Array(e)), o = "", l = 0; for (t = r.length; t > l;)switch (i = r[l++], i >> 4) { case 0: case 1: case 2: case 3: case 4: case 5: case 6: case 7: o += String.fromCharCode(i); break; case 12: case 13: a = r[l++], o += String.fromCharCode((31 & i) << 6 | 63 & a); break; case 14: a = r[l++], n = r[l++], o += String.fromCharCode((15 & i) << 12 | (63 & a) << 6 | (63 & n) << 0) }return o }, isHtml: function (e) { var t = document.createElement("div"); t.innerHTML = e; for (var i = t.childNodes, a = i.length; a--;)if (1 === i[a].nodeType) return !0; return !1 }, isSvg: function (e) { return e.match(/^\s*<\?xml/i) && (e.match(/<!DOCTYPE svg/i) || e.match(/<svg/i)) }, getMimeType: function (e, t, i) { switch (e) { case "ffd8ffe0": case "ffd8ffe1": case "ffd8ffe2": return "image/jpeg"; case "89504E47": return "image/png"; case "47494638": return "image/gif"; case "49492a00": return "image/tiff"; case "52494646": return "image/webp"; case "66747970": return "video/3gp"; case "4f676753": return "video/ogg"; case "1a45dfa3": return "video/mkv"; case "000001ba": case "000001b3": return "video/mpeg"; case "3026b275": return "video/wmv"; case "25504446": return "application/pdf"; case "25215053": return "application/ps"; case "504b0304": case "504b0506": case "504b0508": return "application/zip"; case "377abcaf": return "application/7z"; case "75737461": return "application/tar"; case "7801730d": return "application/dmg"; default: switch (e.substring(0, 6)) { case "435753": return "application/x-shockwave-flash"; case "494433": return "audio/mp3"; case "425a68": return "application/bzip"; default: switch (e.substring(0, 4)) { case "424d": return "image/bmp"; case "fffb": return "audio/mp3"; case "4d5a": return "application/exe"; case "1f9d": case "1fa0": return "application/zip"; case "1f8b": return "application/gzip"; default: return t && !t.match(/[^\u0000-\u007f]/) ? "application/text-plain" : i } } } }, addCss: function (e, t) { e.removeClass(t).addClass(t) }, getElement: function (i, a, n) { return t.isEmpty(i) || t.isEmpty(i[a]) ? n : e(i[a]) }, uniqId: function () { return Math.round((new Date).getTime()) + "_" + Math.round(100 * Math.random()) }, htmlEncode: function (e) { return e.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&apos;") }, replaceTags: function (t, i) { var a = t; return i ? (e.each(i, function (e, t) { "function" == typeof t && (t = t()), a = a.split(e).join(t) }), a) : a }, cleanMemory: function (e) { var i = e.is("img") ? e.attr("src") : e.find("source").attr("src"); t.objUrl.revokeObjectURL(i) }, findFileName: function (e) { var t = e.lastIndexOf("/"); return -1 === t && (t = e.lastIndexOf("\\")), e.split(e.substring(t, t + 1)).pop() }, checkFullScreen: function () { return document.fullscreenElement || document.mozFullScreenElement || document.webkitFullscreenElement || document.msFullscreenElement }, toggleFullScreen: function (e) { var i = document, a = i.documentElement; a && e && !t.checkFullScreen() ? a.requestFullscreen ? a.requestFullscreen() : a.msRequestFullscreen ? a.msRequestFullscreen() : a.mozRequestFullScreen ? a.mozRequestFullScreen() : a.webkitRequestFullscreen && a.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT) : i.exitFullscreen ? i.exitFullscreen() : i.msExitFullscreen ? i.msExitFullscreen() : i.mozCancelFullScreen ? i.mozCancelFullScreen() : i.webkitExitFullscreen && i.webkitExitFullscreen() }, moveArray: function (e, t, i) { if (i >= e.length) for (var a = i - e.length; a-- + 1;)e.push(void 0); return e.splice(i, 0, e.splice(t, 1)[0]), e }, cleanZoomCache: function (e) { var t = e.closest(".kv-zoom-cache-theme"); t.length || (t = e.closest(".kv-zoom-cache")), t.remove() }, setOrientation: function (e, t) { var i, a, n, r = new DataView(e), o = 0, l = 1; if (65496 !== r.getUint16(o) || e.length < 2) return void (t && t()); for (o += 2, i = r.byteLength; i - 2 > o;)switch (a = r.getUint16(o), o += 2, a) { case 65505: n = r.getUint16(o), i = n - o, o += 2; break; case 274: l = r.getUint16(o + 6, !1), i = 0 }t && t(l) }, validateOrientation: function (e, i) { if (window.FileReader && window.DataView) { var a, n = new FileReader; n.onloadend = function () { a = n.result, t.setOrientation(a, i) }, n.readAsArrayBuffer(e) } }, adjustOrientedImage: function (e, t) { var i, a, n; if (e.hasClass("is-portrait-gt4")) { if (t) return void e.css({ width: e.parent().height() }); e.css({ height: "auto", width: e.height() }), i = e.parent().offset().top, a = e.offset().top, n = i - a, e.css("margin-top", n) } } }, i = function (i, a) { var n = this; n.$element = e(i), n.$parent = n.$element.parent(), n._validate() && (n.isPreviewable = t.hasFileAPISupport(), n.isIE9 = t.isIE(9), n.isIE10 = t.isIE(10), (n.isPreviewable || n.isIE9) && (n._init(a), n._listen()), n.$element.removeClass("file-loading")) }, i.prototype = {
        constructor: i, _cleanup: function () { var e = this; e.reader = null, e.formdata = {}, e.uploadCount = 0, e.uploadStatus = {}, e.uploadLog = [], e.uploadAsyncCount = 0, e.loadedImages = [], e.totalImagesCount = 0, e.ajaxRequests = [], e.clearStack(), e.fileInputCleared = !1, e.fileBatchCompleted = !0, e.isPreviewable || (e.showPreview = !1), e.isError = !1, e.ajaxAborted = !1, e.cancelling = !1 }, _init: function (i, a) { var n, r, o, l, s = this, d = s.$element; s.options = i, e.each(i, function (e, i) { switch (e) { case "minFileCount": case "maxFileCount": case "minFileSize": case "maxFileSize": case "maxFilePreviewSize": case "resizeImageQuality": case "resizeIfSizeMoreThan": case "progressUploadThreshold": case "initialPreviewCount": case "zoomModalHeight": case "minImageHeight": case "maxImageHeight": case "minImageWidth": case "maxImageWidth": s[e] = t.getNum(i); break; default: s[e] = i } }), s.rtl && (l = s.previewZoomButtonIcons.prev, s.previewZoomButtonIcons.prev = s.previewZoomButtonIcons.next, s.previewZoomButtonIcons.next = l), a || s._cleanup(), s.$form = d.closest("form"), s._initTemplateDefaults(), s.uploadFileAttr = t.isEmpty(d.attr("name")) ? "file_data" : d.attr("name"), o = s._getLayoutTemplate("progress"), s.progressTemplate = o.replace("{class}", s.progressClass), s.progressCompleteTemplate = o.replace("{class}", s.progressCompleteClass), s.progressErrorTemplate = o.replace("{class}", s.progressErrorClass), s.dropZoneEnabled = t.hasDragDropSupport() && s.dropZoneEnabled, s.isDisabled = d.attr("disabled") || d.attr("readonly"), s.isDisabled && d.attr("disabled", !0), s.isAjaxUpload = t.hasFileUploadSupport() && !t.isEmpty(s.uploadUrl), s.isClickable = s.browseOnZoneClick && s.showPreview && (s.isAjaxUpload && s.dropZoneEnabled || !t.isEmpty(s.defaultPreviewContent)), s.slug = "function" == typeof i.slugCallback ? i.slugCallback : s._slugDefault, s.mainTemplate = s.showCaption ? s._getLayoutTemplate("main1") : s._getLayoutTemplate("main2"), s.captionTemplate = s._getLayoutTemplate("caption"), s.previewGenericTemplate = s._getPreviewTemplate("generic"), !s.imageCanvas && s.resizeImage && (s.maxImageWidth || s.maxImageHeight) && (s.imageCanvas = document.createElement("canvas"), s.imageCanvasContext = s.imageCanvas.getContext("2d")), t.isEmpty(d.attr("id")) && d.attr("id", t.uniqId()), s.namespace = ".fileinput_" + d.attr("id").replace(/-/g, "_"), void 0 === s.$container ? s.$container = s._createContainer() : s._refreshContainer(), r = s.$container, s.$dropZone = r.find(".file-drop-zone"), s.$progress = r.find(".kv-upload-progress"), s.$btnUpload = r.find(".fileinput-upload"), s.$captionContainer = t.getElement(i, "elCaptionContainer", r.find(".file-caption")), s.$caption = t.getElement(i, "elCaptionText", r.find(".file-caption-name")), t.isEmpty(s.msgPlaceholder) || (n = d.attr("multiple") ? s.filePlural : s.fileSingle, s.$caption.attr("placeholder", s.msgPlaceholder.replace("{files}", n))), s.$captionIcon = s.$captionContainer.find(".file-caption-icon"), s.mainClass.indexOf("input-group-lg") > -1 ? t.addCss(s.$captionIcon, "icon-lg") : s.$captionIcon.removeClass("icon-lg"), s.$previewContainer = t.getElement(i, "elPreviewContainer", r.find(".file-preview")), s.$preview = t.getElement(i, "elPreviewImage", r.find(".file-preview-thumbnails")), s.$previewStatus = t.getElement(i, "elPreviewStatus", r.find(".file-preview-status")), s.$errorContainer = t.getElement(i, "elErrorContainer", s.$previewContainer.find(".kv-fileinput-error")), s._validateDisabled(), t.isEmpty(s.msgErrorClass) || t.addCss(s.$errorContainer, s.msgErrorClass), a || (s.$errorContainer.hide(), s.previewInitId = "preview-" + t.uniqId(), s._initPreviewCache(), s._initPreview(!0), s._initPreviewActions(), s._setFileDropZoneTitle(), s.$parent.hasClass("file-loading") && (s.$container.insertBefore(s.$parent), s.$parent.remove())), d.attr("disabled") && s.disable(), s._initZoom(), s.hideThumbnailContent && t.addCss(s.$preview, "hide-content") }, _initTemplateDefaults: function () { var i, a, n, r, o, l, s, d, c, p, u, f, m, v, g, h, w, _, b, C, y, x, T, E, S, k, F, I, P, A, D, z, $, U, j, B, R, O, L = this; i = '{preview}\n<div class="kv-upload-progress kv-hidden"></div><div class="clearfix"></div>\n<div class="input-group {class}">\n  {caption}\n<div class="input-group-btn">\n      {remove}\n      {cancel}\n      {upload}\n      {browse}\n    </div>\n</div>', a = '{preview}\n<div class="kv-upload-progress kv-hidden"></div>\n<div class="clearfix"></div>\n{remove}\n{cancel}\n{upload}\n{browse}\n', n = '<div class="file-preview {class}">\n    {close}    <div class="{dropClass}">\n    <div class="file-preview-thumbnails">\n    </div>\n    <div class="clearfix"></div>    <div class="file-preview-status text-center text-success"></div>\n    <div class="kv-fileinput-error"></div>\n    </div>\n</div>', o = '<button type="button" class="close fileinput-remove">&times;</button>\n', r = '<i class="glyphicon glyphicon-file"></i>', l = '<div class="file-caption form-control {class}" tabindex="500">\n  <span class="file-caption-icon"></span>\n  <input class="file-caption-name" onkeydown="return false;" onpaste="return false;">\n</div>', s = '<button type="{type}" tabindex="500" title="{title}" class="{css}" {status}>{icon} {label}</button>', d = '<a href="{href}" tabindex="500" title="{title}" class="{css}" {status}>{icon} {label}</a>', c = '<div tabindex="500" class="{css}" {status}>{icon} {label}</div>', p = '<div id="' + t.MODAL_ID + '" class="file-zoom-dialog modal fade" tabindex="-1" aria-labelledby="' + t.MODAL_ID + 'Label"></div>', u = '<div class="modal-dialog modal-lg{rtl}" role="document">\n  <div class="modal-content">\n    <div class="modal-header">\n      <h5 class="modal-title">{heading}</h5>\n      <span class="kv-zoom-title"></span>\n      <div class="kv-zoom-actions">{toggleheader}{fullscreen}{borderless}{close}</div>\n    </div>\n    <div class="modal-body">\n      <div class="floating-buttons"></div>\n      <div class="kv-zoom-body file-zoom-content {zoomFrameClass}"></div>\n{prev} {next}\n    </div>\n  </div>\n</div>\n', f = '<div class="progress">\n    <div class="{class}" role="progressbar" aria-valuenow="{percent}" aria-valuemin="0" aria-valuemax="100" style="width:{percent}%;">\n        {status}\n     </div>\n</div>', m = " <samp>({sizeText})</samp>", v = '<div class="file-thumbnail-footer">\n    <div class="file-footer-caption" title="{caption}">\n        <div class="file-caption-info">{caption}</div>\n        <div class="file-size-info">{size}</div>\n    </div>\n    {progress}\n{indicator}\n{actions}\n</div>', g = '<div class="file-actions">\n    <div class="file-footer-buttons">\n        {download} {upload} {delete} {zoom} {other}    </div>\n</div>\n{drag}\n<div class="clearfix"></div>', h = '<button type="button" class="kv-file-remove {removeClass}" title="{removeTitle}" {dataUrl}{dataKey}>{removeIcon}</button>\n', w = '<button type="button" class="kv-file-upload {uploadClass}" title="{uploadTitle}">{uploadIcon}</button>', _ = '<a href="{downloadUrl}" class="{downloadClass}" title="{downloadTitle}" download="{caption}">{downloadIcon}</a>', b = '<button type="button" class="kv-file-zoom {zoomClass}" title="{zoomTitle}">{zoomIcon}</button>', C = '<span class="file-drag-handle {dragClass}" title="{dragTitle}">{dragIcon}</span>', y = '<div class="file-upload-indicator" title="{indicatorTitle}">{indicator}</div>', x = '<div class="file-preview-frame {frameClass}" id="{previewId}" data-fileindex="{fileindex}" data-template="{template}"', T = x + '><div class="kv-file-content">\n', E = x + ' title="{caption}"><div class="kv-file-content">\n', S = "</div>{footer}\n</div>\n", k = "{content}\n", F = '<div class="kv-preview-data file-preview-html" title="{caption}" {style}>{data}</div>\n', I = '<img src="{data}" class="file-preview-image kv-preview-data" title="{caption}" alt="{caption}" {style}>\n', P = '<textarea class="kv-preview-data file-preview-text" title="{caption}" readonly {style}>{data}</textarea>\n', A = '<iframe class="kv-preview-data file-preview-office" src="https://docs.google.com/gview?url={data}&embedded=true" {style}></iframe>', D = '<video class="kv-preview-data file-preview-video" controls {style}>\n<source src="{data}" type="{type}">\n' + t.DEFAULT_PREVIEW + "\n</video>\n", z = '<audio class="kv-preview-data file-preview-audio" controls {style}>\n<source src="{data}" type="{type}">\n' + t.DEFAULT_PREVIEW + "\n</audio>\n", $ = '<embed class="kv-preview-data file-preview-flash" src="{data}" type="application/x-shockwave-flash" {style}>\n', j = '<embed class="kv-preview-data file-preview-pdf" src="{data}" type="application/pdf" {style}>\n', U = '<object class="kv-preview-data file-preview-object file-object {typeCss}" data="{data}" type="{type}" {style}>\n<param name="movie" value="{caption}" />\n' + t.OBJECT_PARAMS + " " + t.DEFAULT_PREVIEW + "\n</object>\n", B = '<div class="kv-preview-data file-preview-other-frame" {style}>\n' + t.DEFAULT_PREVIEW + "\n</div>\n", R = '<div class="kv-zoom-cache" style="display:none">{zoomContent}</div>', O = { width: "100%", height: "100%", "min-height": "480px" }, L.defaults = { layoutTemplates: { main1: i, main2: a, preview: n, close: o, fileIcon: r, caption: l, modalMain: p, modal: u, progress: f, size: m, footer: v, indicator: y, actions: g, actionDelete: h, actionUpload: w, actionDownload: _, actionZoom: b, actionDrag: C, btnDefault: s, btnLink: d, btnBrowse: c, zoomCache: R }, previewMarkupTags: { tagBefore1: T, tagBefore2: E, tagAfter: S }, previewContentTemplates: { generic: k, html: F, image: I, text: P, office: A, video: D, audio: z, flash: $, object: U, pdf: j, other: B }, allowedPreviewTypes: ["image", "html", "text", "video", "audio", "flash", "pdf", "object"], previewTemplates: {}, previewSettings: { image: { width: "auto", height: "auto", "max-width": "100%", "max-height": "100%" }, html: { width: "213px", height: "160px" }, text: { width: "213px", height: "160px" }, office: { width: "213px", height: "160px" }, video: { width: "213px", height: "160px" }, audio: { width: "100%", height: "30px" }, flash: { width: "213px", height: "160px" }, object: { width: "213px", height: "160px" }, pdf: { width: "213px", height: "160px" }, other: { width: "213px", height: "160px" } }, previewSettingsSmall: { image: { width: "auto", height: "auto", "max-width": "100%", "max-height": "100%" }, html: { width: "100%", height: "160px" }, text: { width: "100%", height: "160px" }, office: { width: "100%", height: "160px" }, video: { width: "100%", height: "auto" }, audio: { width: "100%", height: "30px" }, flash: { width: "100%", height: "auto" }, object: { width: "100%", height: "auto" }, pdf: { width: "100%", height: "160px" }, other: { width: "100%", height: "160px" } }, previewZoomSettings: { image: { width: "auto", height: "auto", "max-width": "100%", "max-height": "100%" }, html: O, text: O, office: { width: "100%", height: "100%", "max-width": "100%", "min-height": "480px" }, video: { width: "auto", height: "100%", "max-width": "100%" }, audio: { width: "100%", height: "30px" }, flash: { width: "auto", height: "480px" }, object: { width: "auto", height: "100%", "max-width": "100%", "min-height": "480px" }, pdf: O, other: { width: "auto", height: "100%", "min-height": "480px" } }, fileTypeSettings: { image: function (e, i) { return t.compare(e, "image.*") || t.compare(i, /\.(gif|png|jpe?g)$/i) }, html: function (e, i) { return t.compare(e, "text/html") || t.compare(i, /\.(htm|html)$/i) }, text: function (e, i) { return t.compare(e, "text.*") || t.compare(i, /\.(xml|javascript)$/i) || t.compare(i, /\.(txt|md|csv|nfo|ini|json|php|js|css)$/i) }, office: function (e, i) { return t.compare(e, "msword") || t.compare(e, "ms-excel") || t.compare(e, "ms-powerpoint") || t.compare(e, "vnd.openxmlformats-officedocument") || t.compare(i, /\.(doc|docx|rtf|odt|xls|xlsx|ods|ppt|pptx|pps|pot|potx)$/i) }, video: function (e, i) { return t.compare(e, "video.*") && (t.compare(e, /(ogg|mp4|mp?g|mov|webm|3gp)$/i) || t.compare(i, /\.(og?|mp4|webm|mp?g|mov|3gp)$/i)) }, audio: function (e, i) { return t.compare(e, "audio.*") && (t.compare(i, /(ogg|mp3|mp?g|wav)$/i) || t.compare(i, /\.(og?|mp3|mp?g|wav)$/i)) }, flash: function (e, i) { return t.compare(e, "application/x-shockwave-flash", !0) || t.compare(i, /\.(swf)$/i) }, pdf: function (e, i) { return t.compare(e, "application/pdf", !0) || t.compare(i, /\.(pdf)$/i) }, object: function () { return !0 }, other: function () { return !0 } }, fileActionSettings: { showRemove: !0, showUpload: !0, showDownload: !0, showZoom: !0, showDrag: !0, removeIcon: '<i class="glyphicon glyphicon-trash"></i>', removeClass: "btn btn-kv btn-default btn-outline-secondary", removeErrorClass: "btn btn-kv btn-danger", removeTitle: "Remove file", uploadIcon: '<i class="glyphicon glyphicon-upload"></i>', uploadClass: "btn btn-kv btn-default btn-outline-secondary", uploadTitle: "Upload file", uploadRetryIcon: '<i class="glyphicon glyphicon-repeat"></i>', uploadRetryTitle: "Retry upload", downloadIcon: '<i class="glyphicon glyphicon-download"></i>', downloadClass: "btn btn-kv btn-default btn-outline-secondary", downloadTitle: "Download file", zoomIcon: '<i class="glyphicon glyphicon-zoom-in"></i>', zoomClass: "btn btn-kv btn-default btn-outline-secondary", zoomTitle: "View Details", dragIcon: '<i class="glyphicon glyphicon-move"></i>', dragClass: "text-info", dragTitle: "Move / Rearrange", dragSettings: {}, indicatorNew: '<i class="glyphicon glyphicon-plus-sign text-warning"></i>', indicatorSuccess: '<i class="glyphicon glyphicon-ok-sign text-success"></i>', indicatorError: '<i class="glyphicon glyphicon-exclamation-sign text-danger"></i>', indicatorLoading: '<i class="glyphicon glyphicon-hourglass text-muted"></i>', indicatorNewTitle: "Not uploaded yet", indicatorSuccessTitle: "Uploaded", indicatorErrorTitle: "Upload Error", indicatorLoadingTitle: "Uploading ..." } }, e.each(L.defaults, function (t, i) { return "allowedPreviewTypes" === t ? void (void 0 === L.allowedPreviewTypes && (L.allowedPreviewTypes = i)) : void (L[t] = e.extend(!0, {}, i, L[t])) }), L._initPreviewTemplates() }, _initPreviewTemplates: function () { var i, a = this, n = a.defaults, r = a.previewMarkupTags, o = r.tagAfter; e.each(n.previewContentTemplates, function (e, n) { t.isEmpty(a.previewTemplates[e]) && (i = r.tagBefore2, "generic" !== e && "image" !== e && "html" !== e && "text" !== e || (i = r.tagBefore1), a.previewTemplates[e] = i + n + o) }) }, _initPreviewCache: function () { var i = this; i.previewCache = { data: {}, init: function () { var e = i.initialPreview; e.length > 0 && !t.isArray(e) && (e = e.split(i.initialPreviewDelimiter)), i.previewCache.data = { content: e, config: i.initialPreviewConfig, tags: i.initialPreviewThumbTags } }, count: function () { return i.previewCache.data && i.previewCache.data.content ? i.previewCache.data.content.length : 0 }, get: function (a, n) { var r, o, l, s, d, c, p, u = "init_" + a, f = i.previewCache.data, m = f.config[a], v = f.content[a], g = i.previewInitId + "-" + u, h = t.ifSet("previewAsData", m, i.initialPreviewAsData), w = function (e, a, n, r, o, l, s, d, c) { return d = " file-preview-initial " + t.SORT_CSS + (d ? " " + d : ""), i._generatePreviewTemplate(e, a, n, r, o, !1, null, d, l, s, c) }; return v ? (n = void 0 === n ? !0 : n, l = t.ifSet("type", m, i.initialPreviewFileType || "generic"), d = t.ifSet("filename", m, t.ifSet("caption", m)), c = t.ifSet("filetype", m, l), s = i.previewCache.footer(a, n, m && m.size || null), p = t.ifSet("frameClass", m), r = h ? w(l, v, d, c, g, s, u, p) : w("generic", v, d, c, g, s, u, p, l).setTokens({ content: f.content[a] }), f.tags.length && f.tags[a] && (r = t.replaceTags(r, f.tags[a])), t.isEmpty(m) || t.isEmpty(m.frameAttr) || (o = e(document.createElement("div")).html(r), o.find(".file-preview-initial").attr(m.frameAttr), r = o.html(), o.remove()), r) : "" }, add: function (e, a, n, r) { var o, l = i.previewCache.data; return t.isArray(e) || (e = e.split(i.initialPreviewDelimiter)), r ? (o = l.content.push(e) - 1, l.config[o] = a, l.tags[o] = n) : (o = e.length - 1, l.content = e, l.config = a, l.tags = n), i.previewCache.data = l, o }, set: function (e, a, n, r) { var o, l, s = i.previewCache.data; if (e && e.length && (t.isArray(e) || (e = e.split(i.initialPreviewDelimiter)), l = e.filter(function (e) { return null !== e }), l.length)) { if (void 0 === s.content && (s.content = []), void 0 === s.config && (s.config = []), void 0 === s.tags && (s.tags = []), r) { for (o = 0; o < e.length; o++)e[o] && s.content.push(e[o]); for (o = 0; o < a.length; o++)a[o] && s.config.push(a[o]); for (o = 0; o < n.length; o++)n[o] && s.tags.push(n[o]) } else s.content = e, s.config = a, s.tags = n; i.previewCache.data = s } }, unset: function (e) { var t = i.previewCache.count(); if (t) { if (1 === t) return i.previewCache.data.content = [], i.previewCache.data.config = [], i.previewCache.data.tags = [], i.initialPreview = [], i.initialPreviewConfig = [], void (i.initialPreviewThumbTags = []); i.previewCache.data.content.splice(e, 1), i.previewCache.data.config.splice(e, 1), i.previewCache.data.tags.splice(e, 1) } }, out: function () { var e, t, a = "", n = i.previewCache.count(); if (0 === n) return { content: "", caption: "" }; for (t = 0; n > t; t++)a += i.previewCache.get(t); return e = i._getMsgSelected(n), { content: a, caption: e } }, footer: function (e, a, n) { var r = i.previewCache.data || {}; if (t.isEmpty(r.content)) return ""; (t.isEmpty(r.config) || t.isEmpty(r.config[e])) && (r.config[e] = {}), a = void 0 === a ? !0 : a; var o, l = r.config[e], s = t.ifSet("caption", l), d = t.ifSet("width", l, "auto"), c = t.ifSet("url", l, !1), p = t.ifSet("key", l, null), u = i.fileActionSettings, f = i.initialPreviewShowDelete || !1, m = l.downloadUrl || i.initialPreviewDownloadUrl || "", v = l.filename || l.caption || "", g = !!m, h = t.ifSet("showDelete", l, t.ifSet("showDelete", u, f)), w = t.ifSet("showDownload", l, t.ifSet("showDownload", u, g)), _ = t.ifSet("showZoom", l, t.ifSet("showZoom", u, !0)), b = t.ifSet("showDrag", l, t.ifSet("showDrag", u, !0)), C = c === !1 && a; return w = w && l.downloadUrl !== !1 && !!m, o = i._renderFileActions(!1, w, h, _, b, C, c, p, !0, m, v), i._getLayoutTemplate("footer").setTokens({ progress: i._renderThumbProgress(), actions: o, caption: s, size: i._getSize(n), width: d, indicator: "" }) } }, i.previewCache.init() }, _handler: function (e, t, i) { var a = this, n = a.namespace, r = t.split(" ").join(n + " ") + n; e && e.length && e.off(r).on(r, i) }, _log: function (e) { var t = this, i = t.$element.attr("id"); i && (e = '"' + i + '": ' + e), "undefined" != typeof window.console.log ? window.console.log(e) : window.alert(e) }, _validate: function () { var e = this, t = "file" === e.$element.attr("type"); return t || e._log('The input "type" must be set to "file" for initializing the "bootstrap-fileinput" plugin.'), t }, _errorsExist: function () { var t, i = this, a = i.$errorContainer.find("li"); return a.length ? !0 : (t = e(document.createElement("div")).html(i.$errorContainer.html()), t.find(".kv-error-close").remove(), t.find("ul").remove(), !!e.trim(t.text()).length) }, _errorHandler: function (e, t) { var i = this, a = e.target.error, n = function (e) { i._showError(e.replace("{name}", t)) }; n(a.code === a.NOT_FOUND_ERR ? i.msgFileNotFound : a.code === a.SECURITY_ERR ? i.msgFileSecured : a.code === a.NOT_READABLE_ERR ? i.msgFileNotReadable : a.code === a.ABORT_ERR ? i.msgFilePreviewAborted : i.msgFilePreviewError) }, _addError: function (e) { var t = this, i = t.$errorContainer; e && i.length && (i.html(t.errorCloseButton + e), t._handler(i.find(".kv-error-close"), "click", function () { i.fadeOut("slow") })) }, _setValidationError: function (e) { var i = this; e = (e ? e + " " : "") + "has-error", i.$container.removeClass(e).addClass("has-error"), t.addCss(i.$captionContainer, "is-invalid") }, _resetErrors: function (e) { var t = this, i = t.$errorContainer; t.isError = !1, t.$container.removeClass("has-error"), t.$captionContainer.removeClass("is-invalid"), i.html(""), e ? i.fadeOut("slow") : i.hide() }, _showFolderError: function (e) { var t, i = this, a = i.$errorContainer; e && (t = i.msgFoldersNotAllowed.replace("{n}", e), i._addError(t), i._setValidationError(), a.fadeIn(800), i._raise("filefoldererror", [e, t])) }, _showUploadError: function (e, t, i) { var a = this, n = a.$errorContainer, r = i || "fileuploaderror", o = t && t.id ? '<li data-file-id="' + t.id + '">' + e + "</li>" : "<li>" + e + "</li>"; return 0 === n.find("ul").length ? a._addError("<ul>" + o + "</ul>") : n.find("ul").append(o), n.fadeIn(800), a._raise(r, [t, e]), a._setValidationError("file-input-new"), !0 }, _showError: function (e, t, i) { var a = this, n = a.$errorContainer, r = i || "fileerror"; return t = t || {}, t.reader = a.reader, a._addError(e), n.fadeIn(800), a._raise(r, [t, e]), a.isAjaxUpload || a._clearFileInput(), a._setValidationError("file-input-new"), a.$btnUpload.attr("disabled", !0), !0 }, _noFilesError: function (e) { var t = this, i = t.minFileCount > 1 ? t.filePlural : t.fileSingle, a = t.msgFilesTooLess.replace("{n}", t.minFileCount).replace("{files}", i), n = t.$errorContainer; t._addError(a), t.isError = !0, t._updateFileDetails(0), n.fadeIn(800), t._raise("fileerror", [e, a]), t._clearFileInput(), t._setValidationError() }, _parseError: function (t, i, a, n) { var r, o = this, l = e.trim(a + ""), s = void 0 !== i.responseJSON && void 0 !== i.responseJSON.error ? i.responseJSON.error : i.responseText; return o.cancelling && o.msgUploadAborted && (l = o.msgUploadAborted), o.showAjaxErrorDetails && s && (s = e.trim(s.replace(/\n\s*\n/g, "\n")), r = s.length ? "<pre>" + s + "</pre>" : "", l += l ? r : s), l || (l = o.msgAjaxError.replace("{operation}", t)), o.cancelling = !1, n ? "<b>" + n + ": </b>" + l : l }, _parseFileType: function (e, i) { var a, n, r, o, l = this, s = l.allowedPreviewTypes || []; if ("application/text-plain" === e) return "text"; for (o = 0; o < s.length; o++)if (r = s[o], a = l.fileTypeSettings[r], n = a(e, i) ? r : "", !t.isEmpty(n)) return n; return "other" }, _getPreviewIcon: function (t) { var i, a = this, n = null; return t && t.indexOf(".") > -1 && (i = t.split(".").pop(), a.previewFileIconSettings && (n = a.previewFileIconSettings[i] || a.previewFileIconSettings[i.toLowerCase()] || null), a.previewFileExtSettings && e.each(a.previewFileExtSettings, function (e, t) { return a.previewFileIconSettings[e] && t(i) ? void (n = a.previewFileIconSettings[e]) : void 0 })), n }, _parseFilePreviewIcon: function (e, t) { var i = this, a = i._getPreviewIcon(t) || i.previewFileIcon, n = e; return n.indexOf("{previewFileIcon}") > -1 && (n = n.setTokens({ previewFileIconClass: i.previewFileIconClass, previewFileIcon: a })), n }, _raise: function (t, i) { var a = this, n = e.Event(t); if (void 0 !== i ? a.$element.trigger(n, i) : a.$element.trigger(n), n.isDefaultPrevented() || n.result === !1) return !1; switch (t) { case "filebatchuploadcomplete": case "filebatchuploadsuccess": case "fileuploaded": case "fileclear": case "filecleared": case "filereset": case "fileerror": case "filefoldererror": case "fileuploaderror": case "filebatchuploaderror": case "filedeleteerror": case "filecustomerror": case "filesuccessremove": break; default: a.ajaxAborted || (a.ajaxAborted = n.result) }return !0 }, _listenFullScreen: function (e) { var t, i, a = this, n = a.$modal; n && n.length && (t = n && n.find(".btn-fullscreen"), i = n && n.find(".btn-borderless"), t.length && i.length && (t.removeClass("active").attr("aria-pressed", "false"), i.removeClass("active").attr("aria-pressed", "false"), e ? t.addClass("active").attr("aria-pressed", "true") : i.addClass("active").attr("aria-pressed", "true"), n.hasClass("file-zoom-fullscreen") ? a._maximizeZoomDialog() : e ? a._maximizeZoomDialog() : i.removeClass("active").attr("aria-pressed", "false"))) }, _listen: function () { var i, a = this, n = a.$element, r = a.$form, o = a.$container; a._handler(n, "change", e.proxy(a._change, a)), a.showBrowse && a._handler(a.$btnFile, "click", e.proxy(a._browse, a)), a._handler(o.find(".fileinput-remove:not([disabled])"), "click", e.proxy(a.clear, a)), a._handler(o.find(".fileinput-cancel"), "click", e.proxy(a.cancel, a)), a._initDragDrop(), a._handler(r, "reset", e.proxy(a.clear, a)), a.isAjaxUpload || a._handler(r, "submit", e.proxy(a._submitForm, a)), a._handler(a.$container.find(".fileinput-upload"), "click", e.proxy(a._uploadClick, a)), a._handler(e(window), "resize", function () { a._listenFullScreen(screen.width === window.innerWidth && screen.height === window.innerHeight) }), i = "webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange", a._handler(e(document), i, function () { a._listenFullScreen(t.checkFullScreen()) }), a._autoFitContent(), a._initClickable() }, _autoFitContent: function () { var t, i = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth, a = this, n = 400 > i ? a.previewSettingsSmall || a.defaults.previewSettingsSmall : a.previewSettings || a.defaults.previewSettings; e.each(n, function (e, i) { t = ".file-preview-frame .file-preview-" + e, a.$preview.find(t + ".kv-preview-data," + t + " .kv-preview-data").css(i) }) }, _initClickable: function () { var i, a = this; a.isClickable && (i = a.isAjaxUpload ? a.$dropZone : a.$preview.find(".file-default-preview"), t.addCss(i, "clickable"), i.attr("tabindex", -1), a._handler(i, "click", function (t) { var n = e(t.target); n.parents(".file-preview-thumbnails").length && !n.parents(".file-default-preview").length || (a.$element.trigger("click"), i.blur()) })) }, _initDragDrop: function () { var t = this, i = t.$dropZone; t.isAjaxUpload && t.dropZoneEnabled && t.showPreview && (t._handler(i, "dragenter dragover", e.proxy(t._zoneDragEnter, t)), t._handler(i, "dragleave", e.proxy(t._zoneDragLeave, t)), t._handler(i, "drop", e.proxy(t._zoneDrop, t)), t._handler(e(document), "dragenter dragover drop", t._zoneDragDropInit)) }, _zoneDragDropInit: function (e) { e.stopPropagation(), e.preventDefault() }, _zoneDragEnter: function (i) { var a = this, n = e.inArray("Files", i.originalEvent.dataTransfer.types) > -1; return a._zoneDragDropInit(i), a.isDisabled || !n ? (i.originalEvent.dataTransfer.effectAllowed = "none", void (i.originalEvent.dataTransfer.dropEffect = "none")) : void t.addCss(a.$dropZone, "file-highlighted") }, _zoneDragLeave: function (e) { var t = this; t._zoneDragDropInit(e), t.isDisabled || t.$dropZone.removeClass("file-highlighted") }, _zoneDrop: function (e) { var i = this; e.preventDefault(), i.isDisabled || t.isEmpty(e.originalEvent.dataTransfer.files) || (i._change(e, "dragdrop"), i.$dropZone.removeClass("file-highlighted")) }, _uploadClick: function (e) {
            var i, a = this, n = a.$container.find(".fileinput-upload"), r = !n.hasClass("disabled") && t.isEmpty(n.attr("disabled")); if (!e || !e.isDefaultPrevented()) {
                if (!a.isAjaxUpload) return void (r && "submit" !== n.attr("type") && (i = n.closest("form"),
                    i.length && i.trigger("submit"), e.preventDefault())); e.preventDefault(), r && a.upload()
            }
        }, _submitForm: function () { var e = this; return e._isFileSelectionValid() && !e._abort({}) }, _clearPreview: function () { var i = this, a = i.$preview, n = i.showUploadedThumbs ? i.getFrames(":not(.file-preview-success)") : i.getFrames(); n.each(function () { var i = e(this); i.remove(), t.cleanZoomCache(a.find("#zoom-" + i.attr("id"))) }), i.getFrames().length && i.showPreview || i._resetUpload(), i._validateDefaultPreview() }, _initSortable: function () { var i, a = this, n = a.$preview, r = "." + t.SORT_CSS; window.KvSortable && 0 !== n.find(r).length && (i = { handle: ".drag-handle-init", dataIdAttr: "data-preview-id", scroll: !1, draggable: r, onSort: function (i) { var n, r, o = i.oldIndex, l = i.newIndex; a.initialPreview = t.moveArray(a.initialPreview, o, l), a.initialPreviewConfig = t.moveArray(a.initialPreviewConfig, o, l), a.previewCache.init(); for (var s = 0; s < a.initialPreviewConfig.length; s++)null !== a.initialPreviewConfig[s] && (n = a.initialPreviewConfig[s].key, r = e(".kv-file-remove[data-key='" + n + "']").closest(t.FRAMES), r.attr("data-fileindex", "init_" + s).attr("data-fileindex", "init_" + s)); a._raise("filesorted", { previewId: e(i.item).attr("id"), oldIndex: o, newIndex: l, stack: a.initialPreviewConfig }) } }, n.data("kvsortable") && n.kvsortable("destroy"), e.extend(!0, i, a.fileActionSettings.dragSettings), n.kvsortable(i)) }, _setPreviewContent: function (e) { var t = this; t.$preview.html(e), t._autoFitContent() }, _initPreview: function (e) { var i, a = this, n = a.initialCaption || ""; return a.previewCache.count() ? (i = a.previewCache.out(), n = e && a.initialCaption ? a.initialCaption : i.caption, a._setPreviewContent(i.content), a._setInitThumbAttr(), a._setCaption(n), a._initSortable(), void (t.isEmpty(i.content) || a.$container.removeClass("file-input-new"))) : (a._clearPreview(), void (e ? a._setCaption(n) : a._initCaption())) }, _getZoomButton: function (e) { var t = this, i = t.previewZoomButtonIcons[e], a = t.previewZoomButtonClasses[e], n = ' title="' + (t.previewZoomButtonTitles[e] || "") + '" ', r = n + ("close" === e ? ' data-dismiss="modal" aria-hidden="true"' : ""); return "fullscreen" !== e && "borderless" !== e && "toggleheader" !== e || (r += ' data-toggle="button" aria-pressed="false" autocomplete="off"'), '<button type="button" class="' + a + " btn-" + e + '"' + r + ">" + i + "</button>" }, _getModalContent: function () { var e = this; return e._getLayoutTemplate("modal").setTokens({ rtl: e.rtl ? " kv-rtl" : "", zoomFrameClass: e.frameClass, heading: e.msgZoomModalHeading, prev: e._getZoomButton("prev"), next: e._getZoomButton("next"), toggleheader: e._getZoomButton("toggleheader"), fullscreen: e._getZoomButton("fullscreen"), borderless: e._getZoomButton("borderless"), close: e._getZoomButton("close") }) }, _listenModalEvent: function (e) { var i = this, a = i.$modal, n = function (e) { return { sourceEvent: e, previewId: a.data("previewId"), modal: a } }; a.on(e + ".bs.modal", function (r) { var o = a.find(".btn-fullscreen"), l = a.find(".btn-borderless"); i._raise("filezoom" + e, n(r)), "shown" === e && (l.removeClass("active").attr("aria-pressed", "false"), o.removeClass("active").attr("aria-pressed", "false"), a.hasClass("file-zoom-fullscreen") && (i._maximizeZoomDialog(), t.checkFullScreen() ? o.addClass("active").attr("aria-pressed", "true") : l.addClass("active").attr("aria-pressed", "true"))) }) }, _initZoom: function () { var i, a = this, n = a._getLayoutTemplate("modalMain"), r = "#" + t.MODAL_ID; a.showPreview && (a.$modal = e(r), a.$modal && a.$modal.length || (i = e(document.createElement("div")).html(n).insertAfter(a.$container), a.$modal = e(r).insertBefore(i), i.remove()), t.initModal(a.$modal), a.$modal.html(a._getModalContent()), e.each(t.MODAL_EVENTS, function (e, t) { a._listenModalEvent(t) })) }, _initZoomButtons: function () { var t, i, a = this, n = a.$modal.data("previewId") || "", r = a.getFrames().toArray(), o = r.length, l = a.$modal.find(".btn-prev"), s = a.$modal.find(".btn-next"); return r.length < 2 ? (l.hide(), void s.hide()) : (l.show(), s.show(), void (o && (t = e(r[0]), i = e(r[o - 1]), l.removeAttr("disabled"), s.removeAttr("disabled"), t.length && t.attr("id") === n && l.attr("disabled", !0), i.length && i.attr("id") === n && s.attr("disabled", !0)))) }, _maximizeZoomDialog: function () { var t = this, i = t.$modal, a = i.find(".modal-header:visible"), n = i.find(".modal-footer:visible"), r = i.find(".modal-body"), o = e(window).height(), l = 0; i.addClass("file-zoom-fullscreen"), a && a.length && (o -= a.outerHeight(!0)), n && n.length && (o -= n.outerHeight(!0)), r && r.length && (l = r.outerHeight(!0) - r.height(), o -= l), i.find(".kv-zoom-body").height(o) }, _resizeZoomDialog: function (e) { var i = this, a = i.$modal, n = a.find(".btn-fullscreen"), r = a.find(".btn-borderless"); if (a.hasClass("file-zoom-fullscreen")) t.toggleFullScreen(!1), e ? n.hasClass("active") || (a.removeClass("file-zoom-fullscreen"), i._resizeZoomDialog(!0), r.hasClass("active") && r.removeClass("active").attr("aria-pressed", "false")) : n.hasClass("active") ? n.removeClass("active").attr("aria-pressed", "false") : (a.removeClass("file-zoom-fullscreen"), i.$modal.find(".kv-zoom-body").css("height", i.zoomModalHeight)); else { if (!e) return void i._maximizeZoomDialog(); t.toggleFullScreen(!0) } a.focus() }, _setZoomContent: function (i, a) { var n, r, o, l, s, d, c, p, u, f, m = this, v = i.attr("id"), g = m.$modal, h = g.find(".btn-prev"), w = g.find(".btn-next"), _ = g.find(".btn-fullscreen"), b = g.find(".btn-borderless"), C = g.find(".btn-toggleheader"), y = m.$preview.find("#zoom-" + v); r = y.attr("data-template") || "generic", n = y.find(".kv-file-content"), o = n.length ? n.html() : "", u = i.data("caption") || "", f = i.data("size") || "", l = u + " " + f, g.find(".kv-zoom-title").attr("title", e("<div/>").html(l).text()).html(l), s = g.find(".kv-zoom-body"), g.removeClass("kv-single-content"), a ? (p = s.addClass("file-thumb-loading").clone().insertAfter(s), s.html(o).hide(), p.fadeOut("fast", function () { s.fadeIn("fast", function () { s.removeClass("file-thumb-loading") }), p.remove() })) : s.html(o), c = m.previewZoomSettings[r], c && (d = s.find(".kv-preview-data"), t.addCss(d, "file-zoom-detail"), e.each(c, function (e, t) { d.css(e, t), (d.attr("width") && "width" === e || d.attr("height") && "height" === e) && d.removeAttr(e) })), g.data("previewId", v); var x = s.find("img"); x.length && t.adjustOrientedImage(x, !0), m._handler(h, "click", function () { m._zoomSlideShow("prev", v) }), m._handler(w, "click", function () { m._zoomSlideShow("next", v) }), m._handler(_, "click", function () { m._resizeZoomDialog(!0) }), m._handler(b, "click", function () { m._resizeZoomDialog(!1) }), m._handler(C, "click", function () { var e, t = g.find(".modal-header"), i = g.find(".modal-body .floating-buttons"), a = t.find(".kv-zoom-actions"), n = function (e) { var i = m.$modal.find(".kv-zoom-body"), a = m.zoomModalHeight; g.hasClass("file-zoom-fullscreen") && (a = i.outerHeight(!0), e || (a -= t.outerHeight(!0))), i.css("height", e ? a + e : a) }; t.is(":visible") ? (e = t.outerHeight(!0), t.slideUp("slow", function () { a.find(".btn").appendTo(i), n(e) })) : (i.find(".btn").appendTo(a), t.slideDown("slow", function () { n() })), g.focus() }), m._handler(g, "keydown", function (e) { var t = e.which || e.keyCode; 37 !== t || h.attr("disabled") || m._zoomSlideShow("prev", v), 39 !== t || w.attr("disabled") || m._zoomSlideShow("next", v) }) }, _zoomPreview: function (e) { var i, a = this, n = a.$modal; if (!e.length) throw "Cannot zoom to detailed preview!"; t.initModal(n), n.html(a._getModalContent()), i = e.closest(t.FRAMES), a._setZoomContent(i), n.modal("show"), a._initZoomButtons() }, _zoomSlideShow: function (t, i) { var a, n, r, o = this, l = o.$modal.find(".kv-zoom-actions .btn-" + t), s = o.getFrames().toArray(), d = s.length; if (!l.attr("disabled")) { for (n = 0; d > n; n++)if (e(s[n]).attr("id") === i) { r = "prev" === t ? n - 1 : n + 1; break } 0 > r || r >= d || !s[r] || (a = e(s[r]), a.length && o._setZoomContent(a, !0), o._initZoomButtons(), o._raise("filezoom" + t, { previewId: i, modal: o.$modal })) } }, _initZoomButton: function () { var t = this; t.$preview.find(".kv-file-zoom").each(function () { var i = e(this); t._handler(i, "click", function () { t._zoomPreview(i) }) }) }, _clearObjects: function (t) { t.find("video audio").each(function () { this.pause(), e(this).remove() }), t.find("img object div").each(function () { e(this).remove() }) }, _clearFileInput: function () { var i, a, n, r = this, o = r.$element; r.fileInputCleared = !0, t.isEmpty(o.val()) || (r.isIE9 || r.isIE10 ? (i = o.closest("form"), a = e(document.createElement("form")), n = e(document.createElement("div")), o.before(n), i.length ? i.after(a) : n.after(a), a.append(o).trigger("reset"), n.before(o).remove(), a.remove()) : o.val("")) }, _resetUpload: function () { var e = this; e.uploadCache = { content: [], config: [], tags: [], append: !0 }, e.uploadCount = 0, e.uploadStatus = {}, e.uploadLog = [], e.uploadAsyncCount = 0, e.loadedImages = [], e.totalImagesCount = 0, e.$btnUpload.removeAttr("disabled"), e._setProgress(0), e.$progress.hide(), e._resetErrors(!1), e.ajaxAborted = !1, e.ajaxRequests = [], e._resetCanvas(), e.cacheInitialPreview = {}, e.overwriteInitial && (e.initialPreview = [], e.initialPreviewConfig = [], e.initialPreviewThumbTags = [], e.previewCache.data = { content: [], config: [], tags: [] }) }, _resetCanvas: function () { var e = this; e.canvas && e.imageCanvasContext && e.imageCanvasContext.clearRect(0, 0, e.canvas.width, e.canvas.height) }, _hasInitialPreview: function () { var e = this; return !e.overwriteInitial && e.previewCache.count() }, _resetPreview: function () { var e, t, i = this; i.previewCache.count() ? (e = i.previewCache.out(), i._setPreviewContent(e.content), i._setInitThumbAttr(), t = i.initialCaption ? i.initialCaption : e.caption, i._setCaption(t)) : (i._clearPreview(), i._initCaption()), i.showPreview && (i._initZoom(), i._initSortable()) }, _clearDefaultPreview: function () { var e = this; e.$preview.find(".file-default-preview").remove() }, _validateDefaultPreview: function () { var e = this; e.showPreview && !t.isEmpty(e.defaultPreviewContent) && (e._setPreviewContent('<div class="file-default-preview">' + e.defaultPreviewContent + "</div>"), e.$container.removeClass("file-input-new"), e._initClickable()) }, _resetPreviewThumbs: function (e) { var t, i = this; return e ? (i._clearPreview(), void i.clearStack()) : void (i._hasInitialPreview() ? (t = i.previewCache.out(), i._setPreviewContent(t.content), i._setInitThumbAttr(), i._setCaption(t.caption), i._initPreviewActions()) : i._clearPreview()) }, _getLayoutTemplate: function (e) { var i = this, a = i.layoutTemplates[e]; return t.isEmpty(i.customLayoutTags) ? a : t.replaceTags(a, i.customLayoutTags) }, _getPreviewTemplate: function (e) { var i = this, a = i.previewTemplates[e]; return t.isEmpty(i.customPreviewTags) ? a : t.replaceTags(a, i.customPreviewTags) }, _getOutData: function (e, t, i) { var a = this; return e = e || {}, t = t || {}, i = i || a.filestack.slice(0) || {}, { form: a.formdata, files: i, filenames: a.filenames, filescount: a.getFilesCount(), extra: a._getExtraData(), response: t, reader: a.reader, jqXHR: e } }, _getMsgSelected: function (e) { var t = this, i = 1 === e ? t.fileSingle : t.filePlural; return e > 0 ? t.msgSelected.replace("{n}", e).replace("{files}", i) : t.msgNoFilesSelected }, _getFrame: function (t) { var i = this, a = e("#" + t); return a.length ? a : (i._log('Invalid thumb frame with id: "' + t + '".'), null) }, _getThumbs: function (e) { return e = e || "", this.getFrames(":not(.file-preview-initial)" + e) }, _getExtraData: function (e, t) { var i = this, a = i.uploadExtraData; return "function" == typeof i.uploadExtraData && (a = i.uploadExtraData(e, t)), a }, _initXhr: function (e, t, i) { var a = this; return e.upload && e.upload.addEventListener("progress", function (e) { var n = 0, r = e.total, o = e.loaded || e.position; e.lengthComputable && (n = Math.floor(o / r * 100)), t ? a._setAsyncUploadStatus(t, n, i) : a._setProgress(n) }, !1), e }, _mergeAjaxCallback: function (e, t, i) { var a, n = this, r = n.ajaxSettings, o = n.mergeAjaxCallbacks; "delete" === i && (r = n.ajaxDeleteSettings, o = n.mergeAjaxDeleteCallbacks), a = r[e], o && "function" == typeof a ? "before" === o ? r[e] = function () { a.apply(this, arguments), t.apply(this, arguments) } : r[e] = function () { t.apply(this, arguments), a.apply(this, arguments) } : r[e] = t, "delete" === i ? n.ajaxDeleteSettings = r : n.ajaxSettings = r }, _ajaxSubmit: function (t, i, a, n, r, o) { var l, s = this; s._raise("filepreajax", [r, o]) && (s._uploadExtra(r, o), s._mergeAjaxCallback("beforeSend", t), s._mergeAjaxCallback("success", i), s._mergeAjaxCallback("complete", a), s._mergeAjaxCallback("error", n), l = e.extend(!0, {}, { xhr: function () { var t = e.ajaxSettings.xhr(); return s._initXhr(t, r, s.getFileStack().length) }, url: o && s.uploadUrlThumb ? s.uploadUrlThumb : s.uploadUrl, type: "POST", dataType: "json", data: s.formdata, cache: !1, processData: !1, contentType: !1 }, s.ajaxSettings), s.ajaxRequests.push(e.ajax(l))) }, _mergeArray: function (e, i) { var a = this, n = t.cleanArray(a[e]), r = t.cleanArray(i); a[e] = n.concat(r) }, _initUploadSuccess: function (i, a, n) { var r, o, l, s, d, c, p, u, f, m = this; m.showPreview && "object" == typeof i && !e.isEmptyObject(i) && void 0 !== i.initialPreview && i.initialPreview.length > 0 && (m.hasInitData = !0, c = i.initialPreview || [], p = i.initialPreviewConfig || [], u = i.initialPreviewThumbTags || [], r = void 0 === i.append || i.append, c.length > 0 && !t.isArray(c) && (c = c.split(m.initialPreviewDelimiter)), m._mergeArray("initialPreview", c), m._mergeArray("initialPreviewConfig", p), m._mergeArray("initialPreviewThumbTags", u), void 0 !== a ? n ? (f = a.attr("data-fileindex"), m.uploadCache.content[f] = c[0], m.uploadCache.config[f] = p[0] || [], m.uploadCache.tags[f] = u[0] || [], m.uploadCache.append = r) : (l = m.previewCache.add(c, p[0], u[0], r), o = m.previewCache.get(l, !1), s = e(document.createElement("div")).html(o).hide().insertAfter(a), d = s.find(".kv-zoom-cache"), d && d.length && d.insertAfter(a), a.fadeOut("slow", function () { var e = s.find(".file-preview-frame"); e && e.length && e.insertBefore(a).fadeIn("slow").css("display:inline-block"), m._initPreviewActions(), m._clearFileInput(), t.cleanZoomCache(m.$preview.find("#zoom-" + a.attr("id"))), a.remove(), s.remove(), m._initSortable() })) : (m.previewCache.set(c, p, u, r), m._initPreview(), m._initPreviewActions())) }, _initSuccessThumbs: function () { var i = this; i.showPreview && i._getThumbs(t.FRAMES + ".file-preview-success").each(function () { var a = e(this), n = i.$preview, r = a.find(".kv-file-remove"); r.removeAttr("disabled"), i._handler(r, "click", function () { var e = a.attr("id"), r = i._raise("filesuccessremove", [e, a.attr("data-fileindex")]); t.cleanMemory(a), r !== !1 && a.fadeOut("slow", function () { t.cleanZoomCache(n.find("#zoom-" + e)), a.remove(), i.getFrames().length || i.reset() }) }) }) }, _checkAsyncComplete: function () { var t, i, a = this; for (i = 0; i < a.filestack.length; i++)if (a.filestack[i] && (t = a.previewInitId + "-" + i, -1 === e.inArray(t, a.uploadLog))) return !1; return a.uploadAsyncCount === a.uploadLog.length }, _uploadExtra: function (t, i) { var a = this, n = a._getExtraData(t, i); 0 !== n.length && e.each(n, function (e, t) { a.formdata.append(e, t) }) }, _uploadSingle: function (i, a) { var n, r, o, l, s, d, c, p, u, f, m, v = this, g = v.getFileStack().length, h = new FormData, w = v.previewInitId + "-" + i, _ = v.filestack.length > 0 || !e.isEmptyObject(v.uploadExtraData), b = e("#" + w).find(".file-thumb-progress"), C = { id: w, index: i }; v.formdata = h, v.showPreview && (r = e("#" + w + ":not(.file-preview-initial)"), l = r.find(".kv-file-upload"), s = r.find(".kv-file-remove"), b.show()), 0 === g || !_ || l && l.hasClass("disabled") || v._abort(C) || (m = function (e, t) { d || v.updateStack(e, void 0), v.uploadLog.push(t), v._checkAsyncComplete() && (v.fileBatchCompleted = !0) }, o = function () { var e, i, a, n = v.uploadCache, r = 0, o = v.cacheInitialPreview; v.fileBatchCompleted && (o && o.content && (r = o.content.length), setTimeout(function () { var l = 0 === v.getFileStack(!0).length; if (v.showPreview) { if (v.previewCache.set(n.content, n.config, n.tags, n.append), r) { for (i = 0; i < n.content.length; i++)a = i + r, o.content[a] = n.content[i], o.config.length && (o.config[a] = n.config[i]), o.tags.length && (o.tags[a] = n.tags[i]); v.initialPreview = t.cleanArray(o.content), v.initialPreviewConfig = t.cleanArray(o.config), v.initialPreviewThumbTags = t.cleanArray(o.tags) } else v.initialPreview = n.content, v.initialPreviewConfig = n.config, v.initialPreviewThumbTags = n.tags; v.cacheInitialPreview = {}, v.hasInitData && (v._initPreview(), v._initPreviewActions()) } v.unlock(l), l && v._clearFileInput(), e = v.$preview.find(".file-preview-initial"), v.uploadAsync && e.length && (t.addCss(e, t.SORT_CSS), v._initSortable()), v._raise("filebatchuploadcomplete", [v.filestack, v._getExtraData()]), v.uploadCount = 0, v.uploadStatus = {}, v.uploadLog = [], v._setProgress(101) }, 100)) }, c = function (o) { n = v._getOutData(o), v.fileBatchCompleted = !1, v.showPreview && (r.hasClass("file-preview-success") || (v._setThumbStatus(r, "Loading"), t.addCss(r, "file-uploading")), l.attr("disabled", !0), s.attr("disabled", !0)), a || v.lock(), v._raise("filepreupload", [n, w, i]), e.extend(!0, C, n), v._abort(C) && (o.abort(), v._setProgressCancelled()) }, p = function (o, s, c) { var p = v.showPreview && r.attr("id") ? r.attr("id") : w; n = v._getOutData(c, o), e.extend(!0, C, n), setTimeout(function () { t.isEmpty(o) || t.isEmpty(o.error) ? (v.showPreview && (v._setThumbStatus(r, "Success"), l.hide(), v._initUploadSuccess(o, r, a), v._setProgress(101, b)), v._raise("fileuploaded", [n, p, i]), a ? m(i, p) : v.updateStack(i, void 0)) : (d = !0, v._showUploadError(o.error, C), v._setPreviewError(r, i, v.filestack[i], v.retryErrorUploads), v.retryErrorUploads || l.hide(), a && m(i, p), v._setProgress(101, e("#" + p).find(".file-thumb-progress"), v.msgUploadError)) }, 100) }, u = function () { setTimeout(function () { v.showPreview && (l.removeAttr("disabled"), s.removeAttr("disabled"), r.removeClass("file-uploading")), a ? o() : (v.unlock(!1), v._clearFileInput()), v._initSuccessThumbs() }, 100) }, f = function (t, n, o) { var s = v.ajaxOperations.uploadThumb, c = v._parseError(s, t, o, a && v.filestack[i].name ? v.filestack[i].name : null); d = !0, setTimeout(function () { a && m(i, w), v.uploadStatus[w] = 100, v._setPreviewError(r, i, v.filestack[i], v.retryErrorUploads), v.retryErrorUploads || l.hide(), e.extend(!0, C, v._getOutData(t)), v._setProgress(101, b, v.msgAjaxProgressError.replace("{operation}", s)), v._setProgress(101, e("#" + w).find(".file-thumb-progress"), v.msgUploadError), v._showUploadError(c, C) }, 100) }, h.append(v.uploadFileAttr, v.filestack[i], v.filenames[i]), h.append("file_id", i), v._ajaxSubmit(c, p, u, f, w, i)) }, _uploadBatch: function () { var i, a, n, r, o, l = this, s = l.filestack, d = s.length, c = {}, p = l.filestack.length > 0 || !e.isEmptyObject(l.uploadExtraData); l.formdata = new FormData, 0 !== d && p && !l._abort(c) && (o = function () { e.each(s, function (e) { l.updateStack(e, void 0) }), l._clearFileInput() }, i = function (i) { l.lock(); var a = l._getOutData(i); l.showPreview && l._getThumbs().each(function () { var i = e(this), a = i.find(".kv-file-upload"), n = i.find(".kv-file-remove"); i.hasClass("file-preview-success") || (l._setThumbStatus(i, "Loading"), t.addCss(i, "file-uploading")), a.attr("disabled", !0), n.attr("disabled", !0) }), l._raise("filebatchpreupload", [a]), l._abort(a) && (i.abort(), l._setProgressCancelled()) }, a = function (i, a, n) { var r = l._getOutData(n, i), s = 0, d = l._getThumbs(":not(.file-preview-success)"), c = t.isEmpty(i) || t.isEmpty(i.errorkeys) ? [] : i.errorkeys; t.isEmpty(i) || t.isEmpty(i.error) ? (l._raise("filebatchuploadsuccess", [r]), o(), l.showPreview ? (d.each(function () { var t = e(this); l._setThumbStatus(t, "Success"), t.removeClass("file-uploading"), t.find(".kv-file-upload").hide().removeAttr("disabled") }), l._initUploadSuccess(i)) : l.reset(), l._setProgress(101)) : (l.showPreview && (d.each(function () { var t = e(this), i = t.attr("data-fileindex"); t.removeClass("file-uploading"), t.find(".kv-file-upload").removeAttr("disabled"), t.find(".kv-file-remove").removeAttr("disabled"), 0 === c.length || -1 !== e.inArray(s, c) ? (l._setPreviewError(t, i, l.filestack[i], l.retryErrorUploads), l.retryErrorUploads || (t.find(".kv-file-upload").hide(), l.updateStack(i, void 0))) : (t.find(".kv-file-upload").hide(), l._setThumbStatus(t, "Success"), l.updateStack(i, void 0)), t.hasClass("file-preview-error") && !l.retryErrorUploads || s++ }), l._initUploadSuccess(i)), l._showUploadError(i.error, r, "filebatchuploaderror"), l._setProgress(101, l.$progress, l.msgUploadError)) }, r = function () { l.unlock(), l._initSuccessThumbs(), l._clearFileInput(), l._raise("filebatchuploadcomplete", [l.filestack, l._getExtraData()]) }, n = function (t, i, a) { var n = l._getOutData(t), r = l.ajaxOperations.uploadBatch, o = l._parseError(r, t, a); l._showUploadError(o, n, "filebatchuploaderror"), l.uploadFileCount = d - 1, l.showPreview && (l._getThumbs().each(function () { var t = e(this), i = t.attr("data-fileindex"); t.removeClass("file-uploading"), void 0 !== l.filestack[i] && l._setPreviewError(t) }), l._getThumbs().removeClass("file-uploading"), l._getThumbs(" .kv-file-upload").removeAttr("disabled"), l._getThumbs(" .kv-file-delete").removeAttr("disabled"), l._setProgress(101, l.$progress, l.msgAjaxProgressError.replace("{operation}", r))) }, e.each(s, function (e, i) { t.isEmpty(s[e]) || l.formdata.append(l.uploadFileAttr, i, l.filenames[e]) }), l._ajaxSubmit(i, a, r, n)) }, _uploadExtraOnly: function () { var e, i, a, n, r = this, o = {}; r.formdata = new FormData, r._abort(o) || (e = function (e) { r.lock(); var t = r._getOutData(e); r._raise("filebatchpreupload", [t]), r._setProgress(50), o.data = t, o.xhr = e, r._abort(o) && (e.abort(), r._setProgressCancelled()) }, i = function (e, i, a) { var n = r._getOutData(a, e); t.isEmpty(e) || t.isEmpty(e.error) ? (r._raise("filebatchuploadsuccess", [n]), r._clearFileInput(), r._initUploadSuccess(e), r._setProgress(101)) : r._showUploadError(e.error, n, "filebatchuploaderror") }, a = function () { r.unlock(), r._clearFileInput(), r._raise("filebatchuploadcomplete", [r.filestack, r._getExtraData()]) }, n = function (e, t, i) { var a = r._getOutData(e), n = r.ajaxOperations.uploadExtra, l = r._parseError(n, e, i); o.data = a, r._showUploadError(l, a, "filebatchuploaderror"), r._setProgress(101, r.$progress, r.msgAjaxProgressError.replace("{operation}", n)) }, r._ajaxSubmit(e, i, a, n)) }, _deleteFileIndex: function (i) { var a = this, n = i.attr("data-fileindex"); "init_" === n.substring(0, 5) && (n = parseInt(n.replace("init_", "")), a.initialPreview = t.spliceArray(a.initialPreview, n), a.initialPreviewConfig = t.spliceArray(a.initialPreviewConfig, n), a.initialPreviewThumbTags = t.spliceArray(a.initialPreviewThumbTags, n), a.getFrames().each(function () { var t = e(this), i = t.attr("data-fileindex"); "init_" === i.substring(0, 5) && (i = parseInt(i.replace("init_", "")), i > n && (i-- , t.attr("data-fileindex", "init_" + i))) }), a.uploadAsync && (a.cacheInitialPreview = a.getPreview())) }, _initFileActions: function () { var i = this, a = i.$preview; i.showPreview && (i._initZoomButton(), i.getFrames(" .kv-file-remove").each(function () { var n, r, o, l, s = e(this), d = s.closest(t.FRAMES), c = d.attr("id"), p = d.attr("data-fileindex"); i._handler(s, "click", function () { return l = i._raise("filepreremove", [c, p]), l !== !1 && i._validateMinCount() ? (n = d.hasClass("file-preview-error"), t.cleanMemory(d), void d.fadeOut("slow", function () { t.cleanZoomCache(a.find("#zoom-" + c)), i.updateStack(p, void 0), i._clearObjects(d), d.remove(), c && n && i.$errorContainer.find('li[data-file-id="' + c + '"]').fadeOut("fast", function () { e(this).remove(), i._errorsExist() || i._resetErrors() }), i._clearFileInput(); var l = i.getFileStack(!0), s = i.previewCache.count(), u = l.length, f = i.showPreview && i.getFrames().length; 0 !== u || 0 !== s || f ? (r = s + u, o = r > 1 ? i._getMsgSelected(r) : l[0] ? i._getFileNames()[0] : "", i._setCaption(o)) : i.reset(), i._raise("fileremoved", [c, p]) })) : !1 }) }), i.getFrames(" .kv-file-upload").each(function () { var a = e(this); i._handler(a, "click", function () { var e = a.closest(t.FRAMES), n = e.attr("data-fileindex"); i.$progress.hide(), e.hasClass("file-preview-error") && !i.retryErrorUploads || i._uploadSingle(n, !1) }) })) }, _initPreviewActions: function () { var i = this, a = i.$preview, n = i.deleteExtraData || {}, r = t.FRAMES + " .kv-file-remove", o = i.fileActionSettings, l = o.removeClass, s = o.removeErrorClass, d = function () { var e = i.isAjaxUpload ? i.previewCache.count() : i.$element.get(0).files.length; a.find(t.FRAMES).length || e || (i._setCaption(""), i.reset(), i.initialCaption = "") }; i._initZoomButton(), a.find(r).each(function () { var r, o, c, p = e(this), u = p.data("url") || i.deleteUrl, f = p.data("key"); if (!t.isEmpty(u) && void 0 !== f) { var m, v, g, h, w = p.closest(t.FRAMES), _ = i.previewCache.data, b = w.attr("data-fileindex"); b = parseInt(b.replace("init_", "")), g = t.isEmpty(_.config) && t.isEmpty(_.config[b]) ? null : _.config[b], h = t.isEmpty(g) || t.isEmpty(g.extra) ? n : g.extra, "function" == typeof h && (h = h()), v = { id: p.attr("id"), key: f, extra: h }, r = function (e) { i.ajaxAborted = !1, i._raise("filepredelete", [f, e, h]), p.removeClass(s), i._abort() ? e.abort() : (t.addCss(w, "file-uploading"), t.addCss(p, "disabled " + l)) }, o = function (e, n, r) { var o, c; return t.isEmpty(e) || t.isEmpty(e.error) ? (w.removeClass("file-uploading").addClass("file-deleted"), void w.fadeOut("slow", function () { b = parseInt(w.attr("data-fileindex").replace("init_", "")), i.previewCache.unset(b), o = i.previewCache.count(), c = o > 0 ? i._getMsgSelected(o) : "", i._deleteFileIndex(w), i._setCaption(c), i._raise("filedeleted", [f, r, h]), t.cleanZoomCache(a.find("#zoom-" + w.attr("id"))), i._clearObjects(w), w.remove(), d() })) : (v.jqXHR = r, v.response = e, i._showError(e.error, v, "filedeleteerror"), w.removeClass("file-uploading"), p.removeClass("disabled " + l).addClass(s), void d()) }, c = function (e, t, a) { var n = i.ajaxOperations.deleteThumb, r = i._parseError(n, e, a); v.jqXHR = e, v.response = {}, i._showError(r, v, "filedeleteerror"), w.removeClass("file-uploading"), p.removeClass("disabled " + l).addClass(s), d() }, i._mergeAjaxCallback("beforeSend", r, "delete"), i._mergeAjaxCallback("success", o, "delete"), i._mergeAjaxCallback("error", c, "delete"), m = e.extend(!0, {}, { url: u, type: "POST", dataType: "json", data: e.extend(!0, {}, { key: f }, h) }, i.ajaxDeleteSettings), i._handler(p, "click", function () { return i._validateMinCount() ? (i.ajaxAborted = !1, i._raise("filebeforedelete", [f, h]), void (i.ajaxAborted instanceof Promise ? i.ajaxAborted.then(function (t) { t || e.ajax(m) }) : i.ajaxAborted || e.ajax(m))) : !1 }) } }) }, _hideFileIcon: function () { var e = this; e.overwriteInitial && e.$captionContainer.removeClass("icon-visible") }, _showFileIcon: function () { var e = this; t.addCss(e.$captionContainer, "icon-visible") }, _getSize: function (t) { var i, a, n, r = this, o = parseFloat(t), l = r.fileSizeGetter; return e.isNumeric(t) && e.isNumeric(o) ? ("function" == typeof l ? n = l(o) : 0 === o ? n = "0.00 B" : (i = Math.floor(Math.log(o) / Math.log(1024)), a = ["B", "KB", "MB", "GB", "TB", "PB", "EB", "ZB", "YB"], n = 1 * (o / Math.pow(1024, i)).toFixed(2) + " " + a[i]), r._getLayoutTemplate("size").replace("{sizeText}", n)) : "" }, _generatePreviewTemplate: function (i, a, n, r, o, l, s, d, c, p, u) { var f, m, v = this, g = v.slug(n), h = "", w = "", _ = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth, b = 400 > _ ? v.previewSettingsSmall[i] || v.defaults.previewSettingsSmall[i] : v.previewSettings[i] || v.defaults.previewSettings[i], C = c || v._renderFileFooter(g, s, "auto", l), y = v._getPreviewIcon(n), x = "type-default", T = y && v.preferIconicPreview, E = y && v.preferIconicZoomPreview; return b && e.each(b, function (e, t) { w += e + ":" + t + ";" }), m = function (a, l, s, c) { var f = s ? "zoom-" + o : o, m = v._getPreviewTemplate(a), h = (d || "") + " " + c; return v.frameClass && (h = v.frameClass + " " + h), s && (h = h.replace(" " + t.SORT_CSS, "")), m = v._parseFilePreviewIcon(m, n), "text" === a && (l = t.htmlEncode(l)), "object" !== i || r || e.each(v.defaults.fileTypeSettings, function (e, t) { "object" !== e && "other" !== e && t(n, r) && (x = "type-" + e) }), m.setTokens({ previewId: f, caption: g, frameClass: h, type: r, fileindex: p, typeCss: x, footer: C, data: l, template: u || i, style: w ? 'style="' + w + '"' : "" }) }, p = p || o.slice(o.lastIndexOf("-") + 1), v.fileActionSettings.showZoom && (h = m(E ? "other" : i, a, !0, "kv-zoom-thumb")), h = "\n" + v._getLayoutTemplate("zoomCache").replace("{zoomContent}", h), f = m(T ? "other" : i, a, !1, "kv-preview-thumb"), f + h }, _previewDefault: function (i, a, n) { var r = this, o = r.$preview; if (r.showPreview) { var l, s = i ? i.name : "", d = i ? i.type : "", c = i.size || 0, p = r.slug(s), u = n === !0 && !r.isAjaxUpload, f = t.objUrl.createObjectURL(i); r._clearDefaultPreview(), l = r._generatePreviewTemplate("other", f, s, d, a, u, c), o.append("\n" + l), r._setThumbAttr(a, p, c), n === !0 && r.isAjaxUpload && r._setThumbStatus(e("#" + a), "Error") } }, _previewFile: function (e, i, a, n, r, o) { if (this.showPreview) { var l, s = this, d = i ? i.name : "", c = o.type, p = o.name, u = s._parseFileType(c, d), f = s.allowedPreviewTypes, m = s.allowedPreviewMimeTypes, v = s.$preview, g = i.size || 0, h = f && f.indexOf(u) >= 0, w = m && -1 !== m.indexOf(c), _ = "text" === u || "html" === u || "image" === u ? a.target.result : r; if ("html" === u && s.purifyHtml && window.DOMPurify && (_ = window.DOMPurify.sanitize(_)), h || w) { l = s._generatePreviewTemplate(u, _, d, c, n, !1, g), s._clearDefaultPreview(), v.append("\n" + l); var b = v.find("#" + n + " img"); b.length && s.autoOrientImage ? t.validateOrientation(i, function (e) { if (!e) return void s._validateImage(n, p, c, g, _); var a = v.find("#zoom-" + n + " img"), r = "rotate-" + e; e > 4 && (r += b.width() > b.height() ? " is-portrait-gt4" : " is-landscape-gt4"), t.addCss(b, r), t.addCss(a, r), s._raise("fileimageoriented", { $img: b, file: i }), s._validateImage(n, p, c, g, _), t.adjustOrientedImage(b) }) : s._validateImage(n, p, c, g, _) } else s._previewDefault(i, n); s._setThumbAttr(n, p, g), s._initSortable() } }, _setThumbAttr: function (t, i, a) { var n = this, r = e("#" + t); r.length && (a = a && a > 0 ? n._getSize(a) : "", r.data({ caption: i, size: a })) }, _setInitThumbAttr: function () { var e, i, a, n, r = this, o = r.previewCache.data, l = r.previewCache.count(); if (0 !== l) for (var s = 0; l > s; s++)e = o.config[s], n = r.previewInitId + "-init_" + s, i = t.ifSet("caption", e, t.ifSet("filename", e)), a = t.ifSet("size", e), r._setThumbAttr(n, i, a) }, _slugDefault: function (e) { return t.isEmpty(e) ? "" : String(e).replace(/[\-\[\]\/\{}:;#%=\(\)\*\+\?\\\^\$\|<>&"']/g, "_") }, _readFiles: function (i) {
        this.reader = new FileReader; var a, n = this, r = n.$element, o = n.$preview, l = n.reader, s = n.$previewContainer, d = n.$previewStatus, c = n.msgLoading, p = n.msgProgress, u = n.previewInitId, f = i.length, m = n.fileTypeSettings, v = n.filestack.length, g = n.allowedFileTypes, h = g ? g.length : 0, w = n.allowedFileExtensions, _ = t.isEmpty(w) ? "" : w.join(", "), b = n.maxFilePreviewSize && parseFloat(n.maxFilePreviewSize), C = o.length && (!b || isNaN(b)), y = function (t, r, o, l) { var s, d = e.extend(!0, {}, n._getOutData({}, {}, i), { id: o, index: l }), c = { id: o, index: l, file: r, files: i }; n._previewDefault(r, o, !0), n.isAjaxUpload ? (n.addToStack(void 0), setTimeout(function () { a(l + 1) }, 100)) : f = 0, n._initFileActions(), s = e("#" + o), s.find(".kv-file-upload").hide(), n.removeFromPreviewOnError && s.remove(), n.isError = n.isAjaxUpload ? n._showUploadError(t, d) : n._showError(t, c), n._updateFileDetails(f) }; n.loadedImages = [], n.totalImagesCount = 0, e.each(i, function (e, t) { var i = n.fileTypeSettings.image; i && i(t.type) && n.totalImagesCount++ }), a = function (x) {
            if (t.isEmpty(r.attr("multiple")) && (f = 1), x >= f) return n.isAjaxUpload && n.filestack.length > 0 ? n._raise("filebatchselected", [n.getFileStack()]) : n._raise("filebatchselected", [i]), s.removeClass("file-thumb-loading"), void d.html(""); var T, E, S, k, F, I, P, A, D, z, $, U, j = v + x, B = u + "-" + j, R = i[x], O = m.text, L = m.image, M = m.html, Z = R.name ? n.slug(R.name) : "", N = (R.size || 0) / 1e3, H = "", V = t.objUrl.createObjectURL(R), W = 0, q = "", K = 0, Y = function () { var e = p.setTokens({ index: x + 1, files: f, percent: 50, name: Z }); setTimeout(function () { d.html(e), n._updateFileDetails(f), a(x + 1) }, 100), n._raise("fileloaded", [R, B, x, l]) }; if (h > 0) for (E = 0; h > E; E++)I = g[E], P = n.msgFileTypes[I] || I, q += 0 === E ? P : ", " + P; if (Z === !1) return void a(x + 1); if (0 === Z.length) return S = n.msgInvalidFileName.replace("{name}", t.htmlEncode(R.name)), void y(S, R, B, x); if (t.isEmpty(w) || (H = new RegExp("\\.(" + w.join("|") + ")$", "i")), T = N.toFixed(2), n.maxFileSize > 0 && N > n.maxFileSize) return S = n.msgSizeTooLarge.setTokens({ name: Z, size: T, maxSize: n.maxFileSize }), void y(S, R, B, x); if (null !== n.minFileSize && N <= t.getNum(n.minFileSize)) return S = n.msgSizeTooSmall.setTokens({ name: Z, size: T, minSize: n.minFileSize }), void y(S, R, B, x); if (!t.isEmpty(g) && t.isArray(g)) { for (E = 0; E < g.length; E += 1)k = g[E], A = m[k], W += A && "function" == typeof A && A(R.type, R.name) ? 1 : 0; if (0 === W) return S = n.msgInvalidFileType.setTokens({ name: Z, types: q }), void y(S, R, B, x) } return 0 !== W || t.isEmpty(w) || !t.isArray(w) || t.isEmpty(H) || (F = t.compare(Z, H), W += t.isEmpty(F) ? 0 : F.length, 0 !== W) ? n.showPreview ? !C && N > b ? (n.addToStack(R), s.addClass("file-thumb-loading"), n._previewDefault(R, B), n._initFileActions(), n._updateFileDetails(f), void a(x + 1)) : (o.length && void 0 !== FileReader ? (D = O(R.type, Z), z = M(R.type, Z), $ = L(R.type, Z), d.html(c.replace("{index}", x + 1).replace("{files}", f)), s.addClass("file-thumb-loading"), l.onerror = function (e) { n._errorHandler(e, Z) }, l.onload = function (i) { var a, r, o, s, d, c, p = [], u = function (e) { var t = new FileReader; t.onerror = function (e) { n._errorHandler(e, Z) }, t.onload = function (e) { n._previewFile(x, R, e, B, V, r), n._initFileActions(), Y() }, e ? t.readAsText(R, n.textEncoding) : t.readAsDataURL(R) }; if (r = { name: Z, type: R.type }, e.each(m, function (e, t) { "object" !== e && "other" !== e && t(R.type, Z) && K++ }), 0 === K) { for (o = new Uint8Array(i.target.result), E = 0; E < o.length; E++)s = o[E].toString(16), p.push(s); if (a = p.join("").toLowerCase().substring(0, 8), c = t.getMimeType(a, "", ""), t.isEmpty(c) && (d = t.arrayBuffer2String(l.result), c = t.isSvg(d) ? "image/svg+xml" : t.getMimeType(a, d, R.type)), r = { name: Z, type: c }, D = O(c, ""), z = M(c, ""), $ = L(c, ""), U = D || z, U || $) return void u(U) } n._previewFile(x, R, i, B, V, r), n._initFileActions(), Y() }, l.onprogress = function (e) { if (e.lengthComputable) { var t = e.loaded / e.total * 100, i = Math.ceil(t); S = p.setTokens({ index: x + 1, files: f, percent: i, name: Z }), setTimeout(function () { d.html(S) }, 100) } }, D || z ? l.readAsText(R, n.textEncoding) : $ ? l.readAsDataURL(R) : l.readAsArrayBuffer(R)) : (n._previewDefault(R, B), setTimeout(function () { a(x + 1), n._updateFileDetails(f) }, 100), n._raise("fileloaded", [R, B, x, l])), void n.addToStack(R)) : (n.isAjaxUpload && n.addToStack(R),
                setTimeout(function () { a(x + 1), n._updateFileDetails(f) }, 100), void n._raise("fileloaded", [R, B, x, l])) : (S = n.msgInvalidFileExtension.setTokens({ name: Z, extensions: _ }), void y(S, R, B, x))
        }, a(0), n._updateFileDetails(f, !1)
        }, _updateFileDetails: function (e) { var i = this, a = i.$element, n = i.getFileStack(), r = t.isIE(9) && t.findFileName(a.val()) || a[0].files[0] && a[0].files[0].name || n.length && n[0].name || "", o = i.slug(r), l = i.isAjaxUpload ? n.length : e, s = i.previewCache.count() + l, d = 1 === l ? o : i._getMsgSelected(s); i.isError ? (i.$previewContainer.removeClass("file-thumb-loading"), i.$previewStatus.html(""), i.$captionContainer.removeClass("icon-visible")) : i._showFileIcon(), i._setCaption(d, i.isError), i.$container.removeClass("file-input-new file-input-ajax-new"), 1 === arguments.length && i._raise("fileselect", [e, o]), i.previewCache.count() && i._initPreviewActions() }, _setThumbStatus: function (e, t) { var i = this; if (i.showPreview) { var a = "indicator" + t, n = a + "Title", r = "file-preview-" + t.toLowerCase(), o = e.find(".file-upload-indicator"), l = i.fileActionSettings; e.removeClass("file-preview-success file-preview-error file-preview-loading"), "Success" === t && e.find(".file-drag-handle").remove(), o.html(l[a]), o.attr("title", l[n]), e.addClass(r), "Error" !== t || i.retryErrorUploads || e.find(".kv-file-upload").attr("disabled", !0) } }, _setProgressCancelled: function () { var e = this; e._setProgress(101, e.$progress, e.msgCancelled) }, _setProgress: function (e, i, a) { var n, r = this, o = Math.min(e, 100), l = r.progressUploadThreshold, s = 100 >= e ? r.progressTemplate : r.progressCompleteTemplate, d = 100 > o ? r.progressTemplate : a ? r.progressErrorTemplate : s; i = i || r.$progress, t.isEmpty(d) || (n = l && o > l && 100 >= e ? d.setTokens({ percent: l, status: r.msgUploadThreshold }) : d.setTokens({ percent: o, status: e > 100 ? r.msgUploadEnd : o + "%" }), i.html(n), a && i.find('[role="progressbar"]').html(a)) }, _setFileDropZoneTitle: function () { var e, i = this, a = i.$container.find(".file-drop-zone"), n = i.dropZoneTitle; i.isClickable && (e = t.isEmpty(i.$element.attr("multiple")) ? i.fileSingle : i.filePlural, n += i.dropZoneClickTitle.replace("{files}", e)), a.find("." + i.dropZoneTitleClass).remove(), i.isAjaxUpload && i.showPreview && 0 !== a.length && !(i.getFileStack().length > 0) && i.dropZoneEnabled && (0 === a.find(t.FRAMES).length && t.isEmpty(i.defaultPreviewContent) && a.prepend('<div class="' + i.dropZoneTitleClass + '">' + n + "</div>"), i.$container.removeClass("file-input-new"), t.addCss(i.$container, "file-input-ajax-new")) }, _setAsyncUploadStatus: function (t, i, a) { var n = this, r = 0; n._setProgress(i, e("#" + t).find(".file-thumb-progress")), n.uploadStatus[t] = i, e.each(n.uploadStatus, function (e, t) { r += t }), n._setProgress(Math.floor(r / a)) }, _validateMinCount: function () { var e = this, t = e.isAjaxUpload ? e.getFileStack().length : e.$element.get(0).files.length; return e.validateInitialCount && e.minFileCount > 0 && e._getFileCount(t - 1) < e.minFileCount ? (e._noFilesError({}), !1) : !0 }, _getFileCount: function (e) { var t = this, i = 0; return t.validateInitialCount && !t.overwriteInitial && (i = t.previewCache.count(), e += i), e }, _getFileId: function (e) { var t, i = this, a = i.generateFileId; return "function" == typeof a ? a(e, event) : e ? (t = String(e.webkitRelativePath || e.fileName || e.name || null), t ? e.size + "-" + t.replace(/[^0-9a-zA-Z_-]/gim, "") : null) : null }, _getFileName: function (e) { return e && e.name ? this.slug(e.name) : void 0 }, _getFileIds: function (e) { var t = this; return t.fileids.filter(function (t) { return e ? void 0 !== t : void 0 !== t && null !== t }) }, _getFileNames: function (e) { var t = this; return t.filenames.filter(function (t) { return e ? void 0 !== t : void 0 !== t && null !== t }) }, _setPreviewError: function (e, t, i, a) { var n = this; if (void 0 !== t && n.updateStack(t, i), n.showPreview) { if (n.removeFromPreviewOnError && !a) return void e.remove(); n._setThumbStatus(e, "Error"), n._refreshUploadButton(e, a) } }, _refreshUploadButton: function (e, t) { var i = this, a = e.find(".kv-file-upload"), n = i.fileActionSettings, r = n.uploadIcon, o = n.uploadTitle; a.length && (t && (r = n.uploadRetryIcon, o = n.uploadRetryTitle), a.attr("title", o).html(r)) }, _checkDimensions: function (e, i, a, n, r, o, l) { var s, d, c, p, u = this, f = "Small" === i ? "min" : "max", m = u[f + "Image" + o]; !t.isEmpty(m) && a.length && (c = a[0], d = "Width" === o ? c.naturalWidth || c.width : c.naturalHeight || c.height, p = "Small" === i ? d >= m : m >= d, p || (s = u["msgImage" + o + i].setTokens({ name: r, size: m }), u._showUploadError(s, l), u._setPreviewError(n, e, null))) }, _validateImage: function (t, i, a, n, r) { var o, l, s, d, c = this, p = c.$preview, u = p.find("#" + t), f = u.attr("data-fileindex"), m = u.find("img"); i = i || "Untitled", m.one("load", function () { l = u.width(), s = p.width(), l > s && m.css("width", "100%"), o = { ind: f, id: t }, c._checkDimensions(f, "Small", m, u, i, "Width", o), c._checkDimensions(f, "Small", m, u, i, "Height", o), c.resizeImage || (c._checkDimensions(f, "Large", m, u, i, "Width", o), c._checkDimensions(f, "Large", m, u, i, "Height", o)), c._raise("fileimageloaded", [t]); try { d = window.piexif ? window.piexif.load(r) : null } catch (e) { d = null } c.loadedImages.push({ ind: f, img: m, thumb: u, pid: t, typ: a, siz: n, validated: !1, imgData: r, exifObj: d }), u.data("exif", d), c._validateAllImages() }).one("error", function () { c._raise("fileimageloaderror", [t]) }).each(function () { this.complete ? e(this).trigger("load") : this.error && e(this).trigger("error") }) }, _validateAllImages: function () { var e, t, i, a = this, n = { val: 0 }, r = a.loadedImages.length, o = a.resizeIfSizeMoreThan; if (r === a.totalImagesCount && (a._raise("fileimagesloaded"), a.resizeImage)) for (e = 0; e < a.loadedImages.length; e++)t = a.loadedImages[e], t.validated || (i = t.siz, i && i > 1e3 * o && a._getResizedImage(t, n, r), a.loadedImages[e].validated = !0) }, _getResizedImage: function (i, a, n) { var r, o, l, s, d, c, p, u = this, f = e(i.img)[0], m = f.naturalWidth, v = f.naturalHeight, g = 1, h = u.maxImageWidth || m, w = u.maxImageHeight || v, _ = !(!m || !v), b = u.imageCanvas, C = u.imageCanvasContext, y = i.typ, x = i.pid, T = i.ind, E = i.thumb, S = i.exifObj; if (d = function (e, t, i) { u.isAjaxUpload ? u._showUploadError(e, t, i) : u._showError(e, t, i), u._setPreviewError(E, T) }, (!u.filestack[T] || !_ || h >= m && w >= v) && (_ && u.filestack[T] && u._raise("fileimageresized", [x, T]), a.val++ , a.val === n && u._raise("fileimagesresized"), !_)) return void d(u.msgImageResizeError, { id: x, index: T }, "fileimageresizeerror"); y = y || u.resizeDefaultImageType, o = m > h, l = v > w, g = "width" === u.resizePreference ? o ? h / m : l ? w / v : 1 : l ? w / v : o ? h / m : 1, u._resetCanvas(), m *= g, v *= g, b.width = m, b.height = v; try { C.drawImage(f, 0, 0, m, v), s = b.toDataURL(y, u.resizeQuality), S && (p = window.piexif.dump(S), s = window.piexif.insert(p, s)), r = t.dataURI2Blob(s), u.filestack[T] = r, u._raise("fileimageresized", [x, T]), a.val++ , a.val === n && u._raise("fileimagesresized", [void 0, void 0]), r instanceof Blob || d(u.msgImageResizeError, { id: x, index: T }, "fileimageresizeerror") } catch (k) { a.val++ , a.val === n && u._raise("fileimagesresized", [void 0, void 0]), c = u.msgImageResizeException.replace("{errors}", k.message), d(c, { id: x, index: T }, "fileimageresizeexception") } }, _initBrowse: function (e) { var t = this; t.showBrowse ? (t.$btnFile = e.find(".btn-file"), t.$btnFile.append(t.$element)) : t.$element.hide() }, _initCaption: function () { var e = this, i = e.initialCaption || ""; return e.overwriteInitial || t.isEmpty(i) ? (e.$caption.val(""), !1) : (e._setCaption(i), !0) }, _setCaption: function (i, a) { var n, r, o, l, s, d = this, c = d.getFileStack(); if (d.$caption.length) { if (d.$captionContainer.removeClass("icon-visible"), a) n = e("<div>" + d.msgValidationError + "</div>").text(), l = c.length, s = l ? 1 === l && c[0] ? d._getFileNames()[0] : d._getMsgSelected(l) : d._getMsgSelected(d.msgNo), r = t.isEmpty(i) ? s : i, o = '<span class="' + d.msgValidationErrorClass + '">' + d.msgValidationErrorIcon + "</span>"; else { if (t.isEmpty(i)) return; n = e("<div>" + i + "</div>").text(), r = n, o = d._getLayoutTemplate("fileIcon") } d.$captionContainer.addClass("icon-visible"), d.$caption.attr("title", n).val(r), d.$captionIcon.html(o) } }, _createContainer: function () { var t = this, i = { "class": "file-input file-input-new" + (t.rtl ? " kv-rtl" : "") }, a = e(document.createElement("div")).attr(i).html(t._renderMain()); return t.$element.before(a), t._initBrowse(a), t.theme && a.addClass("theme-" + t.theme), a }, _refreshContainer: function () { var e = this, t = e.$container; t.before(e.$element), t.html(e._renderMain()), e._initBrowse(t), e._validateDisabled() }, _validateDisabled: function () { var e = this; e.$caption.attr({ readonly: e.isDisabled }) }, _renderMain: function () { var e = this, t = e.isAjaxUpload && e.dropZoneEnabled ? " file-drop-zone" : "file-drop-disabled", i = e.showClose ? e._getLayoutTemplate("close") : "", a = e.showPreview ? e._getLayoutTemplate("preview").setTokens({ "class": e.previewClass, dropClass: t }) : "", n = e.isDisabled ? e.captionClass + " file-caption-disabled" : e.captionClass, r = e.captionTemplate.setTokens({ "class": n + " kv-fileinput-caption" }); return e.mainTemplate.setTokens({ "class": e.mainClass + (!e.showBrowse && e.showCaption ? " no-browse" : ""), preview: a, close: i, caption: r, upload: e._renderButton("upload"), remove: e._renderButton("remove"), cancel: e._renderButton("cancel"), browse: e._renderButton("browse") }) }, _renderButton: function (e) { var i = this, a = i._getLayoutTemplate("btnDefault"), n = i[e + "Class"], r = i[e + "Title"], o = i[e + "Icon"], l = i[e + "Label"], s = i.isDisabled ? " disabled" : "", d = "button"; switch (e) { case "remove": if (!i.showRemove) return ""; break; case "cancel": if (!i.showCancel) return ""; n += " kv-hidden"; break; case "upload": if (!i.showUpload) return ""; i.isAjaxUpload && !i.isDisabled ? a = i._getLayoutTemplate("btnLink").replace("{href}", i.uploadUrl) : d = "submit"; break; case "browse": if (!i.showBrowse) return ""; a = i._getLayoutTemplate("btnBrowse"); break; default: return "" }return n += "browse" === e ? " btn-file" : " fileinput-" + e + " fileinput-" + e + "-button", t.isEmpty(l) || (l = ' <span class="' + i.buttonLabelClass + '">' + l + "</span>"), a.setTokens({ type: d, css: n, title: r, status: s, icon: o, label: l }) }, _renderThumbProgress: function () { var e = this; return '<div class="file-thumb-progress kv-hidden">' + e.progressTemplate.setTokens({ percent: "0", status: e.msgUploadBegin }) + "</div>" }, _renderFileFooter: function (e, i, a, n) { var r, o = this, l = o.fileActionSettings, s = l.showRemove, d = l.showDrag, c = l.showUpload, p = l.showZoom, u = o._getLayoutTemplate("footer"), f = o._getLayoutTemplate("indicator"), m = n ? l.indicatorError : l.indicatorNew, v = n ? l.indicatorErrorTitle : l.indicatorNewTitle, g = f.setTokens({ indicator: m, indicatorTitle: v }); return i = o._getSize(i), r = o.isAjaxUpload ? u.setTokens({ actions: o._renderFileActions(c, !1, s, p, d, !1, !1, !1), caption: e, size: i, width: a, progress: o._renderThumbProgress(), indicator: g }) : u.setTokens({ actions: o._renderFileActions(!1, !1, !1, p, d, !1, !1, !1), caption: e, size: i, width: a, progress: "", indicator: g }), r = t.replaceTags(r, o.previewThumbTags) }, _renderFileActions: function (e, t, i, a, n, r, o, l, s, d, c) { if (!(e || t || i || a || n)) return ""; var p, u = this, f = o === !1 ? "" : ' data-url="' + o + '"', m = l === !1 ? "" : ' data-key="' + l + '"', v = "", g = "", h = "", w = "", _ = "", b = u._getLayoutTemplate("actions"), C = u.fileActionSettings, y = u.otherActionButtons.setTokens({ dataKey: m, key: l }), x = r ? C.removeClass + " disabled" : C.removeClass; return i && (v = u._getLayoutTemplate("actionDelete").setTokens({ removeClass: x, removeIcon: C.removeIcon, removeTitle: C.removeTitle, dataUrl: f, dataKey: m, key: l })), e && (g = u._getLayoutTemplate("actionUpload").setTokens({ uploadClass: C.uploadClass, uploadIcon: C.uploadIcon, uploadTitle: C.uploadTitle })), t && (h = u._getLayoutTemplate("actionDownload").setTokens({ downloadClass: C.downloadClass, downloadIcon: C.downloadIcon, downloadTitle: C.downloadTitle, downloadUrl: d || u.initialPreviewDownloadUrl }), h = h.setTokens({ filename: c, key: l })), a && (w = u._getLayoutTemplate("actionZoom").setTokens({ zoomClass: C.zoomClass, zoomIcon: C.zoomIcon, zoomTitle: C.zoomTitle })), n && s && (p = "drag-handle-init " + C.dragClass, _ = u._getLayoutTemplate("actionDrag").setTokens({ dragClass: p, dragTitle: C.dragTitle, dragIcon: C.dragIcon })), b.setTokens({ "delete": v, upload: g, download: h, zoom: w, drag: _, other: y }) }, _browse: function (e) { var t = this; t._raise("filebrowse"), e && e.isDefaultPrevented() || (t.isError && !t.isAjaxUpload && t.clear(), t.$captionContainer.focus()) }, _filterDuplicate: function (e, t, i) { var a = this, n = a._getFileId(e); n && i && i.indexOf(n) > -1 || (i || (i = []), t.push(e), i.push(n)) }, _change: function (i) { var a = this, n = a.$element; if (!a.isAjaxUpload && t.isEmpty(n.val()) && a.fileInputCleared) return void (a.fileInputCleared = !1); a.fileInputCleared = !1; var r, o, l, s, d = [], c = arguments.length > 1, p = a.isAjaxUpload, u = c ? i.originalEvent.dataTransfer.files : n.get(0).files, f = a.filestack.length, m = t.isEmpty(n.attr("multiple")), v = m && f > 0, g = 0, h = a._getFileIds(), w = function (t, i, n, r) { var o = e.extend(!0, {}, a._getOutData({}, {}, u), { id: n, index: r }), l = { id: n, index: r, file: i, files: u }; return a.isAjaxUpload ? a._showUploadError(t, o) : a._showError(t, l) }; if (a.reader = null, a._resetUpload(), a._hideFileIcon(), a.isAjaxUpload && a.$container.find(".file-drop-zone ." + a.dropZoneTitleClass).remove(), c ? e.each(u, function (e, t) { t && !t.type && void 0 !== t.size && t.size % 4096 === 0 ? g++ : a._filterDuplicate(t, d, h) }) : (u = i.target && void 0 === i.target.files ? i.target.value ? [{ name: i.target.value.replace(/^.+\\/, "") }] : [] : i.target.files || {}, p ? e.each(u, function (e, t) { a._filterDuplicate(t, d, h) }) : d = u), t.isEmpty(d) || 0 === d.length) return p || a.clear(), a._showFolderError(g), void a._raise("fileselectnone"); if (a._resetErrors(), s = d.length, o = a._getFileCount(a.isAjaxUpload ? a.getFileStack().length + s : s), a.maxFileCount > 0 && o > a.maxFileCount) { if (!a.autoReplace || s > a.maxFileCount) return l = a.autoReplace && s > a.maxFileCount ? s : o, r = a.msgFilesTooMany.replace("{m}", a.maxFileCount).replace("{n}", l), a.isError = w(r, null, null, null), a.$captionContainer.removeClass("icon-visible"), a._setCaption("", !0), void a.$container.removeClass("file-input-new file-input-ajax-new"); o > a.maxFileCount && a._resetPreviewThumbs(p) } else !p || v ? (a._resetPreviewThumbs(!1), v && a.clearStack()) : !p || 0 !== f || a.previewCache.count() && !a.overwriteInitial || a._resetPreviewThumbs(!0); a.isPreviewable ? a._readFiles(d) : a._updateFileDetails(1), a._showFolderError(g) }, _abort: function (t) { var i, a = this; return a.ajaxAborted && "object" == typeof a.ajaxAborted && void 0 !== a.ajaxAborted.message ? (i = e.extend(!0, {}, a._getOutData(), t), i.abortData = a.ajaxAborted.data || {}, i.abortMessage = a.ajaxAborted.message, a._setProgress(101, a.$progress, a.msgCancelled), a._showUploadError(a.ajaxAborted.message, i, "filecustomerror"), a.cancel(), !0) : !1 }, _resetFileStack: function () { var i = this, a = 0, n = [], r = [], o = []; i._getThumbs().each(function () { var l, s = e(this), d = s.attr("data-fileindex"), c = i.filestack[d], p = s.attr("id"); "-1" !== d && -1 !== d && (void 0 !== c ? (n[a] = c, r[a] = i._getFileName(c), o[a] = i._getFileId(c), s.attr({ id: i.previewInitId + "-" + a, "data-fileindex": a }), a++) : (l = "uploaded-" + t.uniqId(), s.attr({ id: l, "data-fileindex": "-1" }), i.$preview.find("#zoom-" + p).attr("id", "zoom-" + l))) }), i.filestack = n, i.filenames = r, i.fileids = o }, _isFileSelectionValid: function (e) { var t = this; return e = e || 0, t.required && !t.getFilesCount() ? (t.$errorContainer.html(""), t._showUploadError(t.msgFileRequired), !1) : t.minFileCount > 0 && t._getFileCount(e) < t.minFileCount ? (t._noFilesError({}), !1) : !0 }, clearStack: function () { var e = this; return e.filestack = [], e.filenames = [], e.fileids = [], e.$element }, updateStack: function (e, t) { var i = this; return i.filestack[e] = t, i.filenames[e] = i._getFileName(t), i.fileids[e] = t && i._getFileId(t) || null, i.$element }, addToStack: function (e) { var t = this; return t.filestack.push(e), t.filenames.push(t._getFileName(e)), t.fileids.push(t._getFileId(e)), t.$element }, getFileStack: function (e) { var t = this; return t.filestack.filter(function (t) { return e ? void 0 !== t : void 0 !== t && null !== t }) }, getFilesCount: function () { var e = this, t = e.isAjaxUpload ? e.getFileStack().length : e.$element.get(0).files.length; return e._getFileCount(t) }, lock: function () { var e = this; return e._resetErrors(), e.disable(), e.showRemove && e.$container.find(".fileinput-remove").hide(), e.showCancel && e.$container.find(".fileinput-cancel").show(), e._raise("filelock", [e.filestack, e._getExtraData()]), e.$element }, unlock: function (e) { var t = this; return void 0 === e && (e = !0), t.enable(), t.showCancel && t.$container.find(".fileinput-cancel").hide(), t.showRemove && t.$container.find(".fileinput-remove").show(), e && t._resetFileStack(), t._raise("fileunlock", [t.filestack, t._getExtraData()]), t.$element }, cancel: function () { var t, i = this, a = i.ajaxRequests, n = a.length; if (n > 0) for (t = 0; n > t; t += 1)i.cancelling = !0, a[t].abort(); return i._setProgressCancelled(), i._getThumbs().each(function () { var t = e(this), a = t.attr("data-fileindex"); t.removeClass("file-uploading"), void 0 !== i.filestack[a] && (t.find(".kv-file-upload").removeClass("disabled").removeAttr("disabled"), t.find(".kv-file-remove").removeClass("disabled").removeAttr("disabled")), i.unlock() }), i.$element }, clear: function () { var i, a = this; if (a._raise("fileclear")) return a.$btnUpload.removeAttr("disabled"), a._getThumbs().find("video,audio,img").each(function () { t.cleanMemory(e(this)) }), a._resetUpload(), a.clearStack(), a._clearFileInput(), a._resetErrors(!0), a._hasInitialPreview() ? (a._showFileIcon(), a._resetPreview(), a._initPreviewActions(), a.$container.removeClass("file-input-new")) : (a._getThumbs().each(function () { a._clearObjects(e(this)) }), a.isAjaxUpload && (a.previewCache.data = {}), a.$preview.html(""), i = !a.overwriteInitial && a.initialCaption.length > 0 ? a.initialCaption : "", a.$caption.attr("title", "").val(i), t.addCss(a.$container, "file-input-new"), a._validateDefaultPreview()), 0 === a.$container.find(t.FRAMES).length && (a._initCaption() || a.$captionContainer.removeClass("icon-visible")), a._hideFileIcon(), a._raise("filecleared"), a.$captionContainer.focus(), a._setFileDropZoneTitle(), a.$element }, reset: function () { var e = this; if (e._raise("filereset")) return e._resetPreview(), e.$container.find(".fileinput-filename").text(""), t.addCss(e.$container, "file-input-new"), (e.getFrames().length || e.isAjaxUpload && e.dropZoneEnabled) && e.$container.removeClass("file-input-new"), e.clearStack(), e.formdata = {}, e._setFileDropZoneTitle(), e.$element }, disable: function () { var e = this; return e.isDisabled = !0, e._raise("filedisabled"), e.$element.attr("disabled", "disabled"), e.$container.find(".kv-fileinput-caption").addClass("file-caption-disabled"), e.$container.find(".fileinput-remove, .fileinput-upload, .file-preview-frame button").attr("disabled", !0), t.addCss(e.$container.find(".btn-file"), "disabled"), e._initDragDrop(), e.$element }, enable: function () { var e = this; return e.isDisabled = !1, e._raise("fileenabled"), e.$element.removeAttr("disabled"), e.$container.find(".kv-fileinput-caption").removeClass("file-caption-disabled"), e.$container.find(".fileinput-remove, .fileinput-upload, .file-preview-frame button").removeAttr("disabled"), e.$container.find(".btn-file").removeClass("disabled"), e._initDragDrop(), e.$element }, upload: function () { var i, a, n, r = this, o = r.getFileStack().length, l = !e.isEmptyObject(r._getExtraData()); if (r.isAjaxUpload && !r.isDisabled && r._isFileSelectionValid(o)) { if (r._resetUpload(), 0 === o && !l) return void r._showUploadError(r.msgUploadEmpty); if (r.$progress.show(), r.uploadCount = 0, r.uploadStatus = {}, r.uploadLog = [], r.lock(), r._setProgress(2), 0 === o && l) return void r._uploadExtraOnly(); if (n = r.filestack.length, r.hasInitData = !1, !r.uploadAsync) return r._uploadBatch(), r.$element; for (a = r._getOutData(), r._raise("filebatchpreupload", [a]), r.fileBatchCompleted = !1, r.uploadCache = { content: [], config: [], tags: [], append: !0 }, r.uploadAsyncCount = r.getFileStack().length, i = 0; n > i; i++)r.uploadCache.content[i] = null, r.uploadCache.config[i] = null, r.uploadCache.tags[i] = null; for (r.$preview.find(".file-preview-initial").removeClass(t.SORT_CSS), r._initSortable(), r.cacheInitialPreview = r.getPreview(), i = 0; n > i; i++)r.filestack[i] && r._uploadSingle(i, !0) } }, destroy: function () { var t = this, i = t.$form, a = t.$container, n = t.$element, r = t.namespace; return e(document).off(r), e(window).off(r), i && i.length && i.off(r), t.isAjaxUpload && t._clearFileInput(), t._cleanup(), t._initPreviewCache(), n.insertBefore(a).off(r).removeData(), a.off().remove(), n }, refresh: function (i, a) { var n = this, r = n.$element; return i = "object" != typeof i || t.isEmpty(i) ? n.options : e.extend(!0, {}, n.options, i), n._init(i, !0), n._listen(), a && r.trigger("change" + n.namespace), r }, zoom: function (e) { var i = this, a = i._getFrame(e), n = i.$modal; a && (t.initModal(n), n.html(i._getModalContent()), i._setZoomContent(a), n.modal("show"), i._initZoomButtons()) }, getExif: function (e) { var t = this, i = t._getFrame(e); return i && i.data("exif") || null }, getFrames: function (e) { var i = this; return e = e || "", i.$preview.find(t.FRAMES + e) }, getPreview: function () { var e = this; return { content: e.initialPreview, config: e.initialPreviewConfig, tags: e.initialPreviewThumbTags } }
    }, e.fn.fileinput = function (a) { if (t.hasFileAPISupport() || t.isIE(9)) { var n = Array.apply(null, arguments), r = []; switch (n.shift(), this.each(function () { var o, l = e(this), s = l.data("fileinput"), d = "object" == typeof a && a, c = d.theme || l.data("theme"), p = {}, u = {}, f = d.language || l.data("language") || e.fn.fileinput.defaults.language || "en"; s || (c && (u = e.fn.fileinputThemes[c] || {}), "en" === f || t.isEmpty(e.fn.fileinputLocales[f]) || (p = e.fn.fileinputLocales[f] || {}), o = e.extend(!0, {}, e.fn.fileinput.defaults, u, e.fn.fileinputLocales.en, p, d, l.data()), s = new i(this, o), l.data("fileinput", s)), "string" == typeof a && r.push(s[a].apply(s, n)) }), r.length) { case 0: return this; case 1: return r[0]; default: return r } } }, e.fn.fileinput.defaults = { language: "en", showCaption: !0, showBrowse: !0, showPreview: !0, showRemove: !0, showUpload: !0, showCancel: !0, showClose: !0, showUploadedThumbs: !0, browseOnZoneClick: !1, autoReplace: !1, autoOrientImage: !0, required: !1, rtl: !1, hideThumbnailContent: !1, generateFileId: null, previewClass: "", captionClass: "", frameClass: "krajee-default", mainClass: "file-caption-main", mainTemplate: null, purifyHtml: !0, fileSizeGetter: null, initialCaption: "", initialPreview: [], initialPreviewDelimiter: "*$$*", initialPreviewAsData: !1, initialPreviewFileType: "image", initialPreviewConfig: [], initialPreviewThumbTags: [], previewThumbTags: {}, initialPreviewShowDelete: !0, initialPreviewDownloadUrl: "", removeFromPreviewOnError: !1, deleteUrl: "", deleteExtraData: {}, overwriteInitial: !0, previewZoomButtonIcons: { prev: '<i class="glyphicon glyphicon-triangle-left"></i>', next: '<i class="glyphicon glyphicon-triangle-right"></i>', toggleheader: '<i class="glyphicon glyphicon-resize-vertical"></i>', fullscreen: '<i class="glyphicon glyphicon-fullscreen"></i>', borderless: '<i class="glyphicon glyphicon-resize-full"></i>', close: '<i class="glyphicon glyphicon-remove"></i>' }, previewZoomButtonClasses: { prev: "btn btn-navigate", next: "btn btn-navigate", toggleheader: "btn btn-kv btn-default btn-outline-secondary", fullscreen: "btn btn-kv btn-default btn-outline-secondary", borderless: "btn btn-kv btn-default btn-outline-secondary", close: "btn btn-kv btn-default btn-outline-secondary" }, preferIconicPreview: !1, preferIconicZoomPreview: !1, allowedPreviewTypes: void 0, allowedPreviewMimeTypes: null, allowedFileTypes: null, allowedFileExtensions: null, defaultPreviewContent: null, customLayoutTags: {}, customPreviewTags: {}, previewFileIcon: '<i class="glyphicon glyphicon-file"></i>', previewFileIconClass: "file-other-icon", previewFileIconSettings: {}, previewFileExtSettings: {}, buttonLabelClass: "hidden-xs", browseIcon: '<i class="glyphicon glyphicon-folder-open"></i>&nbsp;', browseClass: "btn btn-primary", removeIcon: '<i class="glyphicon glyphicon-trash"></i>', removeClass: "btn btn-default btn-secondary", cancelIcon: '<i class="glyphicon glyphicon-ban-circle"></i>', cancelClass: "btn btn-default btn-secondary", uploadIcon: '<i class="glyphicon glyphicon-upload"></i>', uploadClass: "btn btn-default btn-secondary", uploadUrl: null, uploadUrlThumb: null, uploadAsync: !0, uploadExtraData: {}, zoomModalHeight: 480, minImageWidth: null, minImageHeight: null, maxImageWidth: null, maxImageHeight: null, resizeImage: !1, resizePreference: "width", resizeQuality: .92, resizeDefaultImageType: "image/jpeg", resizeIfSizeMoreThan: 0, minFileSize: 0, maxFileSize: 0, maxFilePreviewSize: 25600, minFileCount: 0, maxFileCount: 0, validateInitialCount: !1, msgValidationErrorClass: "text-danger", msgValidationErrorIcon: '<i class="glyphicon glyphicon-exclamation-sign"></i> ', msgErrorClass: "file-error-message", progressThumbClass: "progress-bar bg-success progress-bar-success progress-bar-striped active", progressClass: "progress-bar bg-success progress-bar-success progress-bar-striped active", progressCompleteClass: "progress-bar bg-success progress-bar-success", progressErrorClass: "progress-bar bg-danger progress-bar-danger", progressUploadThreshold: 99, previewFileType: "image", elCaptionContainer: null, elCaptionText: null, elPreviewContainer: null, elPreviewImage: null, elPreviewStatus: null, elErrorContainer: null, errorCloseButton: '<button type="button" class="close kv-error-close">&times;</button>', slugCallback: null, dropZoneEnabled: !0, dropZoneTitleClass: "file-drop-zone-title", fileActionSettings: {}, otherActionButtons: "", textEncoding: "UTF-8", ajaxSettings: {}, ajaxDeleteSettings: {}, showAjaxErrorDetails: !0, mergeAjaxCallbacks: !1, mergeAjaxDeleteCallbacks: !1, retryErrorUploads: !0 }, e.fn.fileinputLocales.en = { fileSingle: "file", filePlural: "files", browseLabel: "Browse &hellip;", removeLabel: "Remove", removeTitle: "Clear selected files", cancelLabel: "Cancel", cancelTitle: "Abort ongoing upload", uploadLabel: "Upload", uploadTitle: "Upload selected files", msgNo: "No", msgNoFilesSelected: "No files selected", msgCancelled: "Cancelled", msgPlaceholder: "Select {files}...", msgZoomModalHeading: "Detailed Preview", msgFileRequired: "You must select a file to upload.", msgSizeTooSmall: 'File "{name}" (<b>{size} KB</b>) is too small and must be larger than <b>{minSize} KB</b>.', msgSizeTooLarge: 'File "{name}" (<b>{size} KB</b>) exceeds maximum allowed upload size of <b>{maxSize} KB</b>.', msgFilesTooLess: "You must select at least <b>{n}</b> {files} to upload.", msgFilesTooMany: "Number of files selected for upload <b>({n})</b> exceeds maximum allowed limit of <b>{m}</b>.", msgFileNotFound: 'File "{name}" not found!', msgFileSecured: 'Security restrictions prevent reading the file "{name}".', msgFileNotReadable: 'File "{name}" is not readable.', msgFilePreviewAborted: 'File preview aborted for "{name}".', msgFilePreviewError: 'An error occurred while reading the file "{name}".', msgInvalidFileName: 'Invalid or unsupported characters in file name "{name}".', msgInvalidFileType: 'Invalid type for file "{name}". Only "{types}" files are supported.', msgInvalidFileExtension: 'Invalid extension for file "{name}". Only "{extensions}" files are supported.', msgFileTypes: { image: "image", html: "HTML", text: "text", video: "video", audio: "audio", flash: "flash", pdf: "PDF", object: "object" }, msgUploadAborted: "The file upload was aborted", msgUploadThreshold: "Processing...", msgUploadBegin: "Initializing...", msgUploadEnd: "Done", msgUploadEmpty: "No valid data available for upload.", msgUploadError: "Error", msgValidationError: "Validation Error", msgLoading: "Loading file {index} of {files} &hellip;", msgProgress: "Loading file {index} of {files} - {name} - {percent}% completed.", msgSelected: "{n} {files} selected", msgFoldersNotAllowed: "Drag & drop files only! {n} folder(s) dropped were skipped.", msgImageWidthSmall: 'Width of image file "{name}" must be at least {size} px.', msgImageHeightSmall: 'Height of image file "{name}" must be at least {size} px.', msgImageWidthLarge: 'Width of image file "{name}" cannot exceed {size} px.', msgImageHeightLarge: 'Height of image file "{name}" cannot exceed {size} px.', msgImageResizeError: "Could not get the image dimensions to resize.", msgImageResizeException: "Error while resizing the image.<pre>{errors}</pre>", msgAjaxError: "Something went wrong with the {operation} operation. Please try again later!", msgAjaxProgressError: "{operation} failed", ajaxOperations: { deleteThumb: "file delete", uploadThumb: "file upload", uploadBatch: "batch file upload", uploadExtra: "form data upload" }, dropZoneTitle: "Drag & drop files here &hellip;", dropZoneClickTitle: "<br>(or click to select {files})", previewZoomButtonTitles: { prev: "View previous file", next: "View next file", toggleheader: "Toggle header", fullscreen: "Toggle full screen", borderless: "Toggle borderless mode", close: "Close detailed preview" } }, e.fn.fileinput.Constructor = i, e(document).ready(function () { var t = e("input.file[type=file]"); t.length && t.fileinput() })
});;
